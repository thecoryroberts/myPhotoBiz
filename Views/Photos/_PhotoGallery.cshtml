@model IEnumerable<MyPhotoBiz.Models.Photo>

@* Ensure antiforgery token exists on the page for JS POSTs *@
@Html.AntiForgeryToken()

@* GLightbox CSS *@
<link rel="stylesheet" href="~/plugins/glightbox/glightbox.min.css">

@if (Model != null && Model.Any())
{
    <div class="row g-3" id="photoGallery" data-album-id="@(Model.FirstOrDefault()?.AlbumId ?? 0)">
        @foreach (var photo in Model)
        {
            <div class="col-lg-6">
                <div class="card photo-card h-100">
                    <div class="row g-0 align-items-center">
                        <div class="col-md-4 position-relative">
                            @if (User.IsInRole("Admin"))
                            {
                                <div class="position-absolute top-0 start-0 p-2" style="z-index: 10;">
                                    <input type="checkbox" class="photo-select-checkbox form-check-input" data-photo-id="@photo.Id" />
                                </div>
                            }
                            <a href="@Url.Action("Image", "Photos", new { id = photo.Id })"
                               class="glightbox d-block photo-link"
                               data-gallery="photo-gallery"
                               data-type="image"
                               data-title="@photo.FileName"
                               data-description="@FormatFileSize(photo.FileSize) - Uploaded @photo.UploadDate.ToString("MMM dd, yyyy")">
                                <img src="@Url.Action("Thumbnail", "Photos", new { id = photo.Id })"
                                     class="img-fluid rounded-start photo-thumbnail" alt="@photo.FileName" loading="lazy"
                                     onerror="this.onerror=null; this.src='/images/svg/photo-placeholder.svg'; this.classList.add('img-error');">
                            </a>
                            @if (photo.IsSelected)
                            {
                                <div class="position-absolute bottom-0 start-0 p-2">
                                    <span class="badge bg-success">
                                        <i class="ti ti-check"></i> Selected
                                    </span>
                                </div>
                            }
                        </div>
                        <div class="col-md-8">
                            <div class="card-body">
                                <h5 class="card-title mb-3 text-truncate" title="@photo.FileName">@photo.FileName</h5>
                                <p class="card-text text-muted mb-2">
                                    <i class="ti ti-file me-1"></i> @FormatFileSize(photo.FileSize)
                                </p>
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="ti ti-calendar me-1"></i> Uploaded @photo.UploadDate.ToString("MMM dd, yyyy")
                                    </small>
                                </p>
                                @if (User.IsInRole("Admin"))
                                {
                                    <div class="d-flex gap-2 mt-3">
                                        <a asp-controller="Photos" asp-action="View" asp-route-id="@photo.Id" class="btn btn-sm btn-outline-primary">
                                            <i class="ti ti-eye me-1"></i> View
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-danger"
                                                onclick="deletePhoto(@photo.Id, '@photo.FileName')">
                                            <i class="ti ti-trash me-1"></i> Delete
                                        </button>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <div class="text-center py-5">
        <i class="ti ti-photo-off fs-1 text-muted mb-3 d-block"></i>
        <h5 class="text-muted">No photos uploaded yet</h5>
        @if (User.IsInRole("Admin"))
        {
            <p class="text-muted">Upload your first photos to get started</p>
        }
    </div>
}

@functions {
    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }
}

<style>
    .photo-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .photo-card:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .photo-thumbnail {
        height: 150px;
        width: 100%;
        object-fit: cover;
        cursor: pointer;
        background: #e9ecef;
    }

    .photo-thumbnail.img-error {
        object-fit: contain;
        padding: 20px;
    }

    .photo-link {
        overflow: hidden;
        display: block;
        height: 100%;
    }

    .photo-link img {
        transition: transform 0.3s ease;
    }

    .photo-link:hover img {
        transform: scale(1.05);
    }

    /* Selected photo checkbox styling */
    .photo-select-checkbox {
        width: 1.25rem;
        height: 1.25rem;
        cursor: pointer;
    }

    .photo-card.selected {
        outline: 3px solid var(--bs-primary);
        outline-offset: -3px;
    }

    /* Responsive adjustments for smaller screens */
    @@media (max-width: 767.98px) {
        .photo-thumbnail {
            height: 200px;
        }

        .photo-card .row {
            flex-direction: column;
        }

        .photo-card .col-md-4,
        .photo-card .col-md-8 {
            width: 100%;
        }
    }
</style>

@* GLightbox JS *@
<script src="~/plugins/glightbox/glightbox.min.js"></script>

<script>
    function deletePhoto(photoId, fileName) {
        confirmDelete(fileName, function () {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/Photos/Delete/' + photoId;

            const antiforgeryToken = document.querySelector('input[name="__RequestVerificationToken"]');
            if (antiforgeryToken) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = antiforgeryToken.value;
                form.appendChild(tokenInput);
            }

            document.body.appendChild(form);
            form.submit();
        });
    }

    // Initialize GLightbox for photo gallery
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof GLightbox !== 'undefined') {
            // Build elements array from gallery links
            const galleryLinks = document.querySelectorAll('.glightbox');
            const elements = Array.from(galleryLinks).map(link => ({
                href: link.getAttribute('href'),
                type: 'image',
                title: link.getAttribute('data-title') || '',
                description: link.getAttribute('data-description') || ''
            }));

            // Initialize GLightbox with explicit elements
            const lightbox = GLightbox({
                selector: '.glightbox',
                elements: elements.length > 0 ? elements : null,
                touchNavigation: true,
                loop: true,
                autoplayVideos: false,
                zoomable: true,
                draggable: true,
                openEffect: 'zoom',
                closeEffect: 'zoom',
                slideEffect: 'slide',
                moreText: 'See more',
                moreLength: 60,
                closeButton: true,
                touchFollowAxis: true,
                keyboardNavigation: true,
                closeOnOutsideClick: true,
                preload: true
            });

            // Handle click on gallery links to open at correct index
            galleryLinks.forEach((link, index) => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    lightbox.openAt(index);
                });
            });
        }
    });

    // Photo Gallery Selection Module - accessible from parent pages
    window.PhotoGallerySelection = (function () {
        let allSelected = false;

        function getCheckboxes() {
            return document.querySelectorAll('.photo-select-checkbox');
        }

        function getCheckedBoxes() {
            return document.querySelectorAll('.photo-select-checkbox:checked');
        }

        function updateDeleteButtonVisibility() {
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const anyChecked = getCheckedBoxes().length > 0;
            if (deleteBtn) {
                deleteBtn.classList.toggle('d-none', !anyChecked);
            }
        }

        function updateSelectAllButtonText() {
            const selectAllBtn = document.getElementById('selectAllBtn');
            if (selectAllBtn) {
                selectAllBtn.innerHTML = allSelected
                    ? '<i class="ti ti-checkbox me-1"></i>Deselect All'
                    : '<i class="ti ti-checkbox me-1"></i>Select All';
            }
        }

        function toggleSelectAll() {
            allSelected = !allSelected;
            const checkboxes = getCheckboxes();
            checkboxes.forEach(cb => {
                cb.checked = allSelected;
                highlightCard(cb);
            });
            updateSelectAllButtonText();
            updateDeleteButtonVisibility();
        }

        function highlightCard(checkbox) {
            const card = checkbox.closest('.photo-card') || checkbox.closest('.col-lg-6')?.querySelector('.photo-card');
            if (card) {
                if (checkbox.checked) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            }
        }

        function deleteSelected() {
            const checkedBoxes = Array.from(getCheckedBoxes());
            if (checkedBoxes.length === 0) {
                showInfo('Please select at least one photo to delete.');
                return;
            }

            const gallery = document.getElementById('photoGallery');

            confirmAction({
                title: 'Delete ' + checkedBoxes.length + ' photo(s)?',
                text: 'This action cannot be undone.',
                icon: 'warning',
                confirmButtonColor: '#d33',
                confirmButtonText: 'Yes, delete them!'
            }).then((result) => {
                if (!result.isConfirmed) return;

                // Build form and submit
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/Photos/BulkDelete';

                // Antiforgery token
                const antiforgeryToken = document.querySelector('input[name="__RequestVerificationToken"]');
                if (antiforgeryToken) {
                    const tokenInput = document.createElement('input');
                    tokenInput.type = 'hidden';
                    tokenInput.name = '__RequestVerificationToken';
                    tokenInput.value = antiforgeryToken.value;
                    form.appendChild(tokenInput);
                }

                // Album ID
                const albumId = gallery ? gallery.getAttribute('data-album-id') : null;
                if (albumId) {
                    const albumInput = document.createElement('input');
                    albumInput.type = 'hidden';
                    albumInput.name = 'albumId';
                    albumInput.value = albumId;
                    form.appendChild(albumInput);
                }

                checkedBoxes.forEach(cb => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'photoIds';
                    input.value = cb.getAttribute('data-photo-id');
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit();
            });
        }

        // Listen for individual checkbox changes
        document.addEventListener('change', function (e) {
            if (e.target && e.target.classList && e.target.classList.contains('photo-select-checkbox')) {
                highlightCard(e.target);
                const total = getCheckboxes().length;
                const checked = getCheckedBoxes().length;
                allSelected = (total > 0 && total === checked);
                updateSelectAllButtonText();
                updateDeleteButtonVisibility();
            }
        });

        return {
            toggleSelectAll: toggleSelectAll,
            deleteSelected: deleteSelected,
            updateDeleteButtonVisibility: updateDeleteButtonVisibility
        };
    })();
</script>