@model MyPhotoBiz.ViewModels.PermissionsIndexViewModel
@{
    ViewBag.Title = "Permissions";
    ViewBag.PageTitle = "Permission Management";
    ViewBag.Icon = "ti-lock";
    ViewBag.Color = "secondary";
    ViewBag.Purpose = "List and manage permissions.";
}

@section styles
{
}
<div class="container-fluid">
    <partial name="Partials/_PageTitle" />

    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">All Permissions</h5>
                <a href="javascript:void(0);" class="btn btn-success create-permission-btn">
                    <i class="ti ti-plus me-1"></i> Add New Permission
                </a>
            </div>
            <div data-table data-table-rows-per-page="8" class="card">
                <div class="card-header border-light justify-content-between">
                    <div class="d-flex gap-2">
                        <div class="app-search">
                            <input data-table-search type="search" class="form-control" placeholder="Search permissions...">
                            <i data-lucide="search" class="app-search-icon text-muted"></i>
                        </div>
                        <button data-table-delete-selected class="btn btn-danger d-none">Delete</button>
                    </div>

                    <!-- Records Per Page -->
                    <div>
                        <select data-table-set-rows-per-page class="form-select form-control my-1 my-md-0">
                            <option value="5">5</option>
                            <option value="8" selected>8</option>
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-custom table-centered table-select table-hover w-100 mb-0">
                        <thead class="bg-light align-middle bg-opacity-25 thead-sm">
                            <tr class="text-uppercase fs-xxs">
                                <th data-table-sort="name">Name</th>
                                <th>Assign To</th>
                                <th data-table-sort="created">Created Date</th>
                                <th data-table-sort="users">Users</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model?.Permissions?.Any() == true)
                            {
                                @foreach (var permission in Model.Permissions)
                                {
                                    <tr data-permission-id="@permission.Id">
                                        <td data-sort="name">@permission.Name</td>
                                        <td>
                                            @if (permission.AssignedRoles?.Any() == true)
                                            {
                                                @foreach (var role in permission.AssignedRoles)
                                                {
                                                    var badgeClass = role switch
                                                    {
                                                        "Admin" => "bg-primary-subtle text-primary",
                                                        "Client" => "bg-info-subtle text-info",
                                                        "Photographer" => "bg-success-subtle text-success",
                                                        _ => "bg-secondary-subtle text-secondary"
                                                    };
                                                    <span class="badge @badgeClass badge-label fs-xxs fw-semibold me-1">@role</span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="text-muted">No roles assigned</span>
                                            }
                                        </td>
                                        <td data-sort="created">
                                            @permission.CreatedDate.ToString("dd MMM yyyy"),
                                            <span class="text-muted">@permission.CreatedDate.ToString("h:mm tt")</span>
                                        </td>
                                        <td data-sort="users">@permission.UserCount</td>
                                        <td class="text-center">
                                            <a href="javascript:void(0);" class="btn btn-sm btn-outline-secondary btn-icon view-permission" data-permission-id="@permission.Id" title="View Details">
                                                <i class="ti ti-eye"></i>
                                            </a>
                                            <a href="javascript:void(0);" class="btn btn-sm btn-outline-secondary btn-icon edit-permission" data-permission-id="@permission.Id" title="Edit Permission">
                                                <i class="ti ti-edit"></i>
                                            </a>
                                            <a href="javascript:void(0);" class="btn btn-sm btn-outline-secondary btn-icon delete-permission" data-permission-id="@permission.Id" data-permission-name="@permission.Name" title="Delete Permission">
                                                <i class="ti ti-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <p class="text-muted mb-3">No permissions found. Create your first permission to get started.</p>
                                        <button type="button" class="btn btn-primary create-permission-btn">
                                            <i class="ti ti-plus me-1"></i> Create First Permission
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="card-footer border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <div data-table-pagination-info></div>
                        <div data-table-pagination></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@Html.AntiForgeryToken()

@section scripts
{
<script src="~/js/pages/custom-table.js"></script>
<script>
    // Create Permission
    document.addEventListener('click', function (e) {
        const createBtn = e.target.closest('.create-permission-btn');
        if (createBtn) {
            e.preventDefault();
            fetch('@Url.Action("Create", "Permissions")')
                .then(res => res.text())
                .then(html => {
                    const existing = document.getElementById('createPermissionModal');
                    if (existing) existing.remove();
                    document.body.insertAdjacentHTML('beforeend', html);
                    new bootstrap.Modal(document.getElementById('createPermissionModal')).show();
                })
                .catch(err => {
                    console.error('Error:', err);
                    showError('Failed to load create form');
                });
        }

        // View Permission
        const viewBtn = e.target.closest('.view-permission');
        if (viewBtn) {
            e.preventDefault();
            const id = viewBtn.dataset.permissionId;
            fetch(`@Url.Action("Details", "Permissions")/${id}`)
                .then(res => res.text())
                .then(html => {
                    const existing = document.getElementById('permissionDetailsModal');
                    if (existing) existing.remove();
                    document.body.insertAdjacentHTML('beforeend', html);
                    new bootstrap.Modal(document.getElementById('permissionDetailsModal')).show();
                })
                .catch(err => {
                    console.error('Error:', err);
                    showError('Failed to load permission details');
                });
        }

        // Edit Permission
        const editBtn = e.target.closest('.edit-permission');
        if (editBtn) {
            e.preventDefault();
            const id = editBtn.dataset.permissionId;
            fetch(`@Url.Action("Edit", "Permissions")/${id}`)
                .then(res => res.text())
                .then(html => {
                    const existing = document.getElementById('editPermissionModal');
                    if (existing) existing.remove();
                    document.body.insertAdjacentHTML('beforeend', html);
                    new bootstrap.Modal(document.getElementById('editPermissionModal')).show();
                })
                .catch(err => {
                    console.error('Error:', err);
                    showError('Failed to load edit form');
                });
        }

        // Delete Permission
        const deleteBtn = e.target.closest('.delete-permission');
        if (deleteBtn) {
            e.preventDefault();
            const id = deleteBtn.dataset.permissionId;
            const name = deleteBtn.dataset.permissionName;

            confirmDelete(name, function() {
                const formData = new FormData();
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value);

                fetch(`@Url.Action("Delete", "Permissions")/${id}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const row = document.querySelector(`tr[data-permission-id='${id}']`);
                        if (row) row.remove();
                        showSuccess(data.message || 'Permission deleted');
                    } else {
                        showError(data.message || 'Error deleting permission');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('An error occurred while deleting the permission.');
                });
            });
        }
    });
</script>
}
