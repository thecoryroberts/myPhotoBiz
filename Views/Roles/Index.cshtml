@model MyPhotoBiz.ViewModels.RolesIndexViewModel
@{
    ViewBag.Title = "Roles";
    ViewBag.PageTitle = "Role Management";
    ViewBag.Icon = "ti-shield";
    ViewBag.Color = "secondary";
}

@section styles
{
}

<div class="container-fluid">
    <partial name="Partials/_PageTitle" />

    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">All Roles</h5>
                <a href="javascript: void(0);" class="btn btn-success new-role-btn">
                    <i class="ti ti-plus me-1"></i> Add New Role
                </a>
            </div>

            <!-- Roles Grid Cards -->
            <div id="roleCards" class="row">
                @if (Model?.Roles?.Any() == true)
                {
                    @foreach (var role in Model.Roles)
                    {
                        <div class="col-md-6 col-lg-3 role-card-wrapper" data-role-id="@role.Id">
                            <div class="card role-card" data-role-id="@role.Id">
                                <div class="card-body d-flex flex-column justify-content-between">
                                    <div class="d-flex align-items-start mb-4">
                                        <div class="flex-shrink-0">
                                            <div class="avatar-xl rounded-circle @role.ColorClass d-flex align-items-center justify-content-center">
                                                <i class="ti @role.Icon fs-24 @(role.ColorClass.Replace("-subtle", "").Replace("bg-", "text-"))"></i>
                                            </div>
                                        </div>
                                        <div class="ms-3 flex-grow-1">
                                            <h5 class="mb-2">@role.RoleName</h5>
                                            <p class="text-muted mb-0 fs-sm">
                                                @(!string.IsNullOrEmpty(role.Description) ? role.Description : "No description available")
                                            </p>
                                        </div>
                                        <div class="ms-auto">
                                            <div class="dropdown">
                                                <a href="javascript:void(0);" class="text-muted fs-xl" data-bs-toggle="dropdown">
                                                    <i class="ti ti-dots-vertical"></i>
                                                </a>
                                                <ul class="dropdown-menu dropdown-menu-end">
                                                    <li>
                                                        <a class="dropdown-item view-role" href="javascript:void(0);" data-role-id="@role.Id"><i class="ti ti-eye me-2"></i>View</a>
                                                    </li>
                                                    <li><a class="dropdown-item edit-role" href="javascript:void(0);" data-role-id="@role.Id"><i class="ti ti-edit me-2"></i>Edit</a></li>
                                                    <li><a class="dropdown-item text-danger delete-role" href="javascript:void(0);" data-role-id="@role.Id" data-role-name="@role.RoleName"><i class="ti ti-trash me-2"></i>Delete</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    @if (role.Permissions?.Any() == true)
                                    {
                                        <ul class="list-unstyled mb-3">
                                            @foreach (var permission in role.Permissions.Take(4))
                                            {
                                                <li class="d-flex align-items-center mb-2">
                                                    <span class="ti ti-check fs-lg text-success me-2"></span> @permission
                                                </li>
                                            }
                                            @if (role.Permissions.Count > 4)
                                            {
                                                <li class="d-flex align-items-center text-muted">
                                                    <span class="ti ti-dots fs-lg me-2"></span> +@(role.Permissions.Count - 4) more
                                                </li>
                                            }
                                        </ul>
                                    }

                                    <p class="mb-2 text-muted">Total @role.UserCount user@(role.UserCount != 1 ? "s" : "")</p>
                                    @if (role.Users?.Any() == true)
                                    {
                                        <div class="avatar-group avatar-group-sm mb-3">
                                            @foreach (var user in role.Users.Take(4))
                                            {
                                                <div class="avatar">
                                                    <img src="@Url.Content(user.ProfilePicture ?? "~/images/users/user-1.jpg")" alt="" class="rounded-circle avatar-sm" data-bs-toggle="tooltip" title="@user.FirstName @user.LastName">
                                                </div>
                                            }
                                            @if (role.Users.Count > 4)
                                            {
                                                <div class="avatar avatar-sm" data-bs-toggle="tooltip" title="@(role.UserCount - 4) More">
                                                    <span class="avatar-title text-bg-primary rounded-circle fw-bold">
                                                        +@(role.UserCount - 4)
                                                    </span>
                                                </div>
                                            }
                                        </div>
                                    }

                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted fs-xs"><i class="ti ti-clock me-1"></i>Updated @(role?.LastUpdated != default ? role!.LastUpdated.ToString("MMM dd, yyyy") : "N/A")</span>
                                        <a href="javascript:void(0);" class="btn btn-sm @(role?.ColorClass?.Replace("-subtle", "").Replace("bg-", "btn-outline-") ?? "btn-outline-secondary") rounded-pill view-role" data-role-id="@(role?.Id ?? "")">Details</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12">
                        <div class="text-center py-5">
                            <p class="text-muted mb-3">No roles found. Create your first role.</p>
                            <button type="button" class="btn btn-primary new-role-btn">
                                <i class="ti ti-plus me-1"></i> Create First Role
                            </button>
                        </div>
                    </div>
                }
            </div>

            <!-- User Management Table -->
            <div class="row mt-4">
                <div class="col-12">
                    <div data-table data-table-rows-per-page="8" class="card">
                        <div class="card-header border-light justify-content-between">
                            <div class="d-flex gap-2">
                                <div class="app-search">
                                    <input data-table-search type="search" class="form-control" placeholder="Search users...">
                                    <i data-lucide="search" class="app-search-icon text-muted"></i>
                                </div>
                                <button data-table-delete-selected class="btn btn-danger d-none">Delete</button>
                            </div>

                            <div class="d-flex align-items-center gap-2">
                                <span class="me-2 fw-semibold">Filter By:</span>

                                <!-- Role Type Filter -->
                                <div class="app-search">
                                    <select data-table-filter="role" class="form-select form-control my-1 my-md-0">
                                        <option value="All">All Roles</option>
                                        @if (Model?.Roles?.Any() == true)
                                        {
                                            @foreach (var role in Model.Roles)
                                            {
                                                <option value="@role.RoleName">@role.RoleName</option>
                                            }
                                        }
                                    </select>
                                    <i data-lucide="shield" class="app-search-icon text-muted"></i>
                                </div>

                                <!-- Records Per Page -->
                                <div>
                                    <select data-table-set-rows-per-page class="form-select form-control my-1 my-md-0">
                                        <option value="5">5</option>
                                        <option value="8" selected>8</option>
                                        <option value="10">10</option>
                                        <option value="15">15</option>
                                        <option value="20">20</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-custom table-centered table-select table-hover w-100 mb-0">
                                <thead class="bg-light align-middle bg-opacity-25 thead-sm">
                                    <tr class="text-uppercase fs-xxs">
                                        <th class="ps-3 th-checkbox">
                                            <input data-table-select-all class="form-check-input form-check-input-light fs-14 mt-0" type="checkbox" id="select-all-users">
                                        </th>
                                        <th data-table-sort>ID</th>
                                        <th data-table-sort="name">User</th>
                                        <th data-table-sort="role">Role</th>
                                        <th data-table-sort>Email</th>
                                        <th data-table-sort>Status</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model?.UserRoles?.Any() == true)
                                    {
                                        @foreach (var userRole in Model.UserRoles)
                                        {
                                            <tr>
                                                <td class="ps-3">
                                                    <input class="form-check-input form-check-input-light fs-14 file-item-check mt-0" type="checkbox" value="@userRole.UserId">
                                                </td>
                                                <td>
                                                    <h5 class="m-0">
                                                        <a href="#" class="link-reset">#USR@(userRole.UserId.Substring(0, Math.Min(6, userRole.UserId.Length)))</a>
                                                    </h5>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center gap-2">
                                                        <div class="avatar avatar-sm">
                                                            <img src="@Url.Content(userRole.ProfilePicture ?? "~/images/users/user-1.jpg")" class="img-fluid rounded-circle" alt="@userRole.UserName">
                                                        </div>
                                                        <div>
                                                            <h5 class="fs-base mb-0">
                                                                <a data-sort="name" href="#" class="link-reset">@userRole.FirstName @userRole.LastName</a>
                                                            </h5>
                                                            <p class="text-muted fs-xs mb-0">@("@" + userRole.UserName)</p>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td data-sort="role">
                                                    @if (userRole.Roles?.Any() == true)
                                                    {
                                                        @string.Join(", ", userRole.Roles)
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">No role</span>
                                                    }
                                                </td>
                                                <td>@userRole.Email</td>
                                                <td>
                                                    @if (userRole.IsActive)
                                                    {
                                                        <span class="badge bg-success-subtle text-success badge-label">Active</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-warning-subtle text-warning badge-label">Inactive</span>
                                                    }
                                                </td>
                                                <td>
                                                    <div class="d-flex justify-content-center gap-1">
                                                        <a href="@Url.Action("Details", "Users", new { id = userRole.UserId })" class="btn btn-light btn-icon btn-sm rounded-circle" title="View User">
                                                            <i class="ti ti-eye fs-lg"></i>
                                                        </a>
                                                        <a href="@Url.Action("Edit", "Users", new { id = userRole.UserId })" class="btn btn-light btn-icon btn-sm rounded-circle" title="Edit User">
                                                            <i class="ti ti-edit fs-lg"></i>
                                                        </a>
                                                        <a href="javascript:void(0);" data-user-id="@userRole.UserId" data-user-name="@userRole.FirstName @userRole.LastName" class="btn btn-light btn-icon btn-sm rounded-circle delete-user" title="Delete User">
                                                            <i class="ti ti-trash fs-lg"></i>
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="7" class="text-center py-5">
                                                <p class="text-muted mb-0">No users found.</p>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer border-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div data-table-pagination-info></div>
                                <div data-table-pagination></div>
                            </div>
                        </div>
                    </div>
                </div><!-- end col -->
            </div><!-- end row -->

        </div> <!-- end col-->
    </div> <!-- end row-->
</div>

@Html.AntiForgeryToken()

@section scripts
{
    <script src="~/js/pages/custom-table.js"></script>
    <script>
        // Utility: initialize tooltips
        function initTooltips() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            return tooltipList;
        }

        // Bootstrap toast helper
        function showToast(message, type = 'success') {
            var container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'position-fixed top-0 end-0 p-3';
                container.style.zIndex = 9999;
                document.body.appendChild(container);
            }

            var toast = document.createElement('div');
            toast.className = `toast align-items-center text-bg-${type === 'danger' ? 'danger' : type} border-0 show`;
            toast.role = 'alert';
            toast.ariaLive = 'assertive';
            toast.ariaAtomic = 'true';

            toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type=\"button\" class=\"btn-close btn-close-white me-2 m-auto\" data-bs-dismiss=\"toast\" aria-label=\"Close\"></button></div>`;
            container.appendChild(toast);
            var bsToast = new bootstrap.Toast(toast, { delay: 4000 });
            bsToast.show();
            toast.addEventListener('hidden.bs.toast', function () {
                toast.remove();
            });
        }

        // Delegate click handlers for view/edit/delete
        document.addEventListener('click', function (e) {
            const newRoleBtn = e.target.closest('.new-role-btn');
            if (newRoleBtn) {
                e.preventDefault();
                fetch(`@Url.Action("Create", "Roles")`)
                    .then(res => res.text())
                    .then(html => {
                        const existing = document.getElementById('createRoleModal');
                        if (existing) existing.remove();
                        document.body.insertAdjacentHTML('beforeend', html);
                        new bootstrap.Modal(document.getElementById('createRoleModal')).show();
                        initTooltips();
                    })
                    .catch(err => {
                        console.error('Error fetching create modal:', err);
                        showToast('Failed to load create modal', 'danger');
                    });
                return;
            }

            const editBtn = e.target.closest('.edit-role');
            if (editBtn) {
                e.preventDefault();
                const roleId = editBtn.dataset.roleId;
                // Fetch Edit modal (pre-populated with permissions, etc.)
                fetch(`@Url.Action("Edit", "Roles")?id=${roleId}`)
                    .then(res => res.text())
                    .then(html => {
                        const existing = document.getElementById('editRoleModal');
                        if (existing) existing.remove();
                        document.body.insertAdjacentHTML('beforeend', html);
                        new bootstrap.Modal(document.getElementById('editRoleModal')).show();
                        initTooltips();
                    })
                    .catch(err => {
                        console.error('Error fetching edit modal:', err);
                        showToast('Failed to load edit modal', 'danger');
                    });
                return;
            }

            const viewBtn = e.target.closest('.view-role');
            if (viewBtn) {
                e.preventDefault();
                const roleId = viewBtn.dataset.roleId;
                fetch(`@Url.Action("Details", "Roles")?id=${roleId}`)
                    .then(res => res.text())
                    .then(html => {
                        const existing = document.getElementById('roleDetailsModal');
                        if (existing) existing.remove();
                        document.body.insertAdjacentHTML('beforeend', html);
                        new bootstrap.Modal(document.getElementById('roleDetailsModal')).show();
                    })
                    .catch(err => {
                        console.error('Error fetching role details:', err);
                        showToast('Failed to load role details', 'danger');
                    });
                return;
            }

            const deleteBtn = e.target.closest('.delete-role');
            if (deleteBtn) {
                e.preventDefault();
                const roleId = deleteBtn.dataset.roleId;
                const roleName = deleteBtn.dataset.roleName;
                if (confirm(`Are you sure you want to delete the role "${roleName}"?`)) {
                    const formData = new FormData();
                    formData.append('id', roleId);
                    formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value);

                    fetch('@Url.Action("Delete", "Roles")', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const cardWrapper = document.querySelector(`.role-card-wrapper[data-role-id='${roleId}']`);
                            if (cardWrapper) cardWrapper.remove();
                            showToast(data.message || 'Role deleted', 'success');
                        } else {
                            showToast(data.message || 'Error deleting role', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('An error occurred while deleting the role.', 'danger');
                    });
                }
                return;
            }
        });

        initTooltips();

        // AJAX submit for create role
        (function(){
            const createForm = document.getElementById('createRoleForm');
            if (createForm) {
                createForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const btn = createForm.querySelector('button[type="submit"]');
                    btn.disabled = true;
                    const formData = new FormData(createForm);
                    fetch(createForm.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(r => r.json())
                    .then(data => {
                        btn.disabled = false;
                        if (data.success) {
                            if (data.html) {
                                const col = document.createElement('div');
                                col.className = 'col-md-6 col-lg-3 role-card-wrapper';
                                col.setAttribute('data-role-id', data.roleId);
                                col.innerHTML = data.html;
                                document.getElementById('roleCards').insertAdjacentElement('afterbegin', col);
                                initTooltips();
                                var modal = bootstrap.Modal.getInstance(document.getElementById('createRoleModal'));
                                if (modal) modal.hide();
                                createForm.reset();
                                showToast('Role created successfully', 'success');
                            } else {
                                location.reload();
                            }
                        } else {
                            showToast('Error creating role: ' + (data.message || JSON.stringify(data.errors)), 'danger');
                        }
                    })
                    .catch(err => {
                        btn.disabled = false;
                        console.error(err);
                        showToast('An error occurred creating the role.', 'danger');
                    });
                });
            }
        })();

        // AJAX submit for edit role
        (function(){
            const editForm = document.getElementById('editRoleForm');
            if (editForm) {
                editForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const btn = editForm.querySelector('button[type="submit"]');
                    btn.disabled = true;
                    const formData = new FormData(editForm);
                    fetch(editForm.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(r => r.json())
                    .then(data => {
                        btn.disabled = false;
                        if (data.success) {
                            if (data.html && data.roleId) {
                                var cardWrapper = document.querySelector(`.role-card-wrapper[data-role-id='${data.roleId}']`);
                                if (cardWrapper) cardWrapper.innerHTML = data.html;
                                initTooltips();
                                var modal = bootstrap.Modal.getInstance(document.getElementById('editRoleModal'));
                                if (modal) modal.hide();
                                showToast('Role updated successfully', 'success');
                            } else {
                                location.reload();
                            }
                        } else {
                            showToast('Error updating role: ' + (data.message || JSON.stringify(data.errors)), 'danger');
                        }
                    })
                    .catch(err => {
                        btn.disabled = false;
                        console.error(err);
                        showToast('An error occurred updating the role.', 'danger');
                    });
                });
            }
        })();
    </script>
}
