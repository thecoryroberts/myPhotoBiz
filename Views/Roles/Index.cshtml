@model MyPhotoBiz.ViewModels.RolesIndexViewModel
@{
    ViewBag.Title = "Roles";
    ViewBag.SubTitle = "Users";
}

@section styles
{
}

<div class="container-fluid">

    @await Html.PartialAsync("~/Views/Shared/Partials/_PageTitle.cshtml")

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

                                <tbody>
                                    @foreach (var userRole in Model.UserRoles)
                                    {
                                        <tr>
                                            <td class="ps-3">
                                                <input class="form-check-input form-check-input-light fs-14 file-item-check mt-0" 
                                                       type="checkbox">
                                            </td>
                                            <td>
                                                <h5 class="m-0">
                                                    <a href="#" class="link-reset">@userRole.DisplayId</a>
                                                </h5>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center gap-2">
                                                    <div class="avatar avatar-sm">
                                                         <img src="@Url.Content(userRole.Avatar)" 
                                                             class="img-fluid rounded-circle" alt="">
                                                    </div>
                                                    <div>
                                                        <h5 class="fs-base mb-0">
                                                            <a data-sort="user" href="#" class="link-reset">
                                                                @userRole.UserName
                                                            </a>
                                                        </h5>
                                                        <p class="text-muted fs-xs mb-0">@userRole.Email</p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>@userRole.RoleName</td>
                                            <td>
                                                @userRole.LastUpdated.ToString("dd MMM, yyyy") 
                                                <small class="text-muted">@userRole.LastUpdated.ToString("h:mm tt")</small>
                                            </td>
                                            <td>
                                                @switch (userRole.Status)
                                                {
                                                    case "Active":
                                                        <span class="badge bg-success-subtle text-success badge-label">Active</span>
                                                        break;
                                                    case "Inactive":
                                                        <span class="badge bg-warning-subtle text-warning badge-label">Inactive</span>
                                                        break;
                                                    case "Suspended":
                                                        <span class="badge bg-danger-subtle text-danger badge-label">Suspended</span>
                                                        break;
                                                }
                                            </td>
                                            <td>
                                                <div class="d-flex justify-content-center gap-1">
                                                    <a href="@Url.Action("Details", "Users", new { id = userRole.UserId })" 
                                                       class="btn btn-light btn-icon btn-sm rounded-circle">
                                                        <i class="ti ti-eye fs-lg"></i>
                                                    </a>
                                                    <a href="@Url.Action("Edit", "Users", new { id = userRole.UserId })" 
                                                       class="btn btn-light btn-icon btn-sm rounded-circle">
                                                        <i class="ti ti-edit fs-lg"></i>
                                                    </a>
                                                    <a href="#" data-table-delete-row 
                                                       class="btn btn-light btn-icon btn-sm rounded-circle delete-user"
                                                       data-user-id="@userRole.UserId">
                                                        <i class="ti ti-trash fs-lg"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer border-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div data-table-pagination-info="roles"></div>
                                <div data-table-pagination></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

@await Html.PartialAsync("_CreateRoleModal")

@await Html.PartialAsync("_EditRoleModal")
@await Html.PartialAsync("_RoleDetailsModal")

@section scripts
{
    <script src="~/js/pages/custom-table.js"></script>
    <script>
        // Utility: initialize tooltips
        function initTooltips() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            return tooltipList;
        }

        // Bootstrap toast helper
        function showToast(message, type = 'success') {
            var container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'position-fixed top-0 end-0 p-3';
                container.style.zIndex = 9999;
                document.body.appendChild(container);
            }

            var toast = document.createElement('div');
            toast.className = `toast align-items-center text-bg-${type === 'danger' ? 'danger' : type} border-0 show`;
            toast.role = 'alert';
            toast.ariaLive = 'assertive';
            toast.ariaAtomic = 'true';

            toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type=\"button\" class=\"btn-close btn-close-white me-2 m-auto\" data-bs-dismiss=\"toast\" aria-label=\"Close\"></button></div>`;
            container.appendChild(toast);
            var bsToast = new bootstrap.Toast(toast, { delay: 4000 });
            bsToast.show();
            toast.addEventListener('hidden.bs.toast', function () {
                toast.remove();
            });
        }

        // Delegate click handlers for view/edit/delete
        document.addEventListener('click', function (e) {
            const editBtn = e.target.closest('.edit-role');
            if (editBtn) {
                e.preventDefault();
                const roleId = editBtn.dataset.roleId;
                // Fetch Edit modal (pre-populated with permissions, etc.)
                fetch(`@Url.Action("Edit", "Roles")?id=${roleId}`)
                    .then(res => res.text())
                    .then(html => {
                        const existing = document.getElementById('editRoleModal');
                        if (existing) existing.remove();
                        document.body.insertAdjacentHTML('beforeend', html);
                        new bootstrap.Modal(document.getElementById('editRoleModal')).show();
                    })
                    .catch(err => {
                        console.error('Error fetching edit modal:', err);
                        showToast('Failed to load edit modal', 'danger');
                    });
                return;
            }

            const viewBtn = e.target.closest('.view-role');
            if (viewBtn) {
                e.preventDefault();
                const roleId = viewBtn.dataset.roleId;
                fetch(`@Url.Action("Details", "Roles")?id=${roleId}`)
                    .then(res => res.text())
                    .then(html => {
                        const existing = document.getElementById('roleDetailsModal');
                        if (existing) existing.remove();
                        document.body.insertAdjacentHTML('beforeend', html);
                        new bootstrap.Modal(document.getElementById('roleDetailsModal')).show();
                    })
                    .catch(err => {
                        console.error('Error fetching role details:', err);
                        showToast('Failed to load role details', 'danger');
                    });
                return;
            }

            const deleteBtn = e.target.closest('.delete-role');
            if (deleteBtn) {
                e.preventDefault();
                const roleId = deleteBtn.dataset.roleId;
                const roleName = deleteBtn.dataset.roleName;
                if (confirm(`Are you sure you want to delete the role "${roleName}"?`)) {
                    const formData = new FormData();
                    formData.append('id', roleId);
                    formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

                    fetch('@Url.Action("Delete", "Roles")', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const card = document.querySelector(`.role-card[data-role-id='${roleId}']`);
                            if (card) card.remove();
                            showToast(data.message || 'Role deleted', 'success');
                        } else {
                            showToast(data.message || 'Error deleting role', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('An error occurred while deleting the role.', 'danger');
                    });
                }
                return;
            }
        });

        initTooltips();

        // AJAX submit for create role
        (function(){
            const createForm = document.getElementById('createRoleForm');
            if (createForm) {
                createForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const btn = createForm.querySelector('button[type="submit"]');
                    btn.disabled = true;
                    const formData = new FormData(createForm);
                    fetch(createForm.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(r => r.json())
                    .then(data => {
                        btn.disabled = false;
                        if (data.success) {
                            if (data.html) {
                                document.getElementById('roleCards').insertAdjacentHTML('afterbegin', data.html);
                                initTooltips();
                                var modal = bootstrap.Modal.getInstance(document.getElementById('createRoleModal'));
                                if (modal) modal.hide();
                                showToast('Role created successfully', 'success');
                            } else {
                                location.reload();
                            }
                        } else {
                            showToast('Error creating role: ' + (data.message || JSON.stringify(data.errors)), 'danger');
                        }
                    })
                    .catch(err => {
                        btn.disabled = false;
                        console.error(err);
                        showToast('An error occurred creating the role.', 'danger');
                    });
                });
            }
        })();

        // AJAX submit for edit role
        (function(){
            const editForm = document.getElementById('editRoleForm');
            if (editForm) {
                editForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const btn = editForm.querySelector('button[type="submit"]');
                    btn.disabled = true;
                    const formData = new FormData(editForm);
                    fetch(editForm.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(r => r.json())
                    .then(data => {
                        btn.disabled = false;
                        if (data.success) {
                            if (data.html && data.roleId) {
                                var cardEl = document.querySelector(`.role-card[data-role-id='${data.roleId}']`);
                                if (cardEl) cardEl.outerHTML = data.html;
                                initTooltips();
                                var modal = bootstrap.Modal.getInstance(document.getElementById('editRoleModal'));
                                if (modal) modal.hide();
                                showToast('Role updated successfully', 'success');
                            } else {
                                location.reload();
                            }
                        } else {
                            showToast('Error updating role: ' + (data.message || JSON.stringify(data.errors)), 'danger');
                        }
                    })
                    .catch(err => {
                        btn.disabled = false;
                        console.error(err);
                        showToast('An error occurred updating the role.', 'danger');
                    });
                });
            }
        })();
    </script>
}

@functions {
    string GetRelativeTime(DateTime dateTime)
    {
        var timeSpan = DateTime.Now - dateTime;
        
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes} min ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours} hour{((int)timeSpan.TotalHours != 1 ? "s" : "")} ago";
        if (timeSpan.TotalDays < 30)
            return $"{(int)timeSpan.TotalDays} day{((int)timeSpan.TotalDays != 1 ? "s" : "")} ago";
        
        return dateTime.ToString("MMM dd, yyyy");
    }
}