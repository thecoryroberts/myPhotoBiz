@model IEnumerable<MyPhotoBiz.Models.Notification>
@{
    ViewBag.Title = "Notifications";
    ViewBag.PageTitle = "Notifications";
    ViewBag.Icon = "ti-bell";
    ViewBag.Color = "info";
}

<div class="container-fluid">
    <partial name="Partials/_PageTitle" />

    <div class="row justify-content-center">
        <div class="col-xxl-10">
            <div class="card">
                <div class="card-header border-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">All Notifications</h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-primary" id="createTestBtn">
                            <i class="ti ti-plus me-1"></i>Create Test Notifications
                        </button>
                        <button type="button" class="btn btn-sm btn-light" onclick="NotificationSystem.markAllAsRead()">
                            <i class="ti ti-check-all me-1"></i>Mark All as Read
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    @if (Model != null && Model.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var notification in Model)
                            {
                                var iconClass = notification.Type switch
                                {
                                    MyPhotoBiz.Models.NotificationType.Success => "ti-circle-check",
                                    MyPhotoBiz.Models.NotificationType.Warning => "ti-alert-triangle",
                                    MyPhotoBiz.Models.NotificationType.Error => "ti-alert-circle",
                                    MyPhotoBiz.Models.NotificationType.Invoice => "ti-file-invoice",
                                    MyPhotoBiz.Models.NotificationType.PhotoShoot => "ti-camera",
                                    MyPhotoBiz.Models.NotificationType.Client => "ti-users",
                                    MyPhotoBiz.Models.NotificationType.Album => "ti-photo",
                                    _ => "ti-info-circle"
                                };

                                var colorClass = notification.Type switch
                                {
                                    MyPhotoBiz.Models.NotificationType.Success => "success",
                                    MyPhotoBiz.Models.NotificationType.Warning => "warning",
                                    MyPhotoBiz.Models.NotificationType.Error => "danger",
                                    MyPhotoBiz.Models.NotificationType.Invoice => "primary",
                                    MyPhotoBiz.Models.NotificationType.PhotoShoot => "purple",
                                    MyPhotoBiz.Models.NotificationType.Client => "teal",
                                    MyPhotoBiz.Models.NotificationType.Album => "indigo",
                                    _ => "info"
                                };

                                var bgClass = notification.IsRead ? "" : "bg-light";

                                <div class="list-group-item list-group-item-action cursor-pointer @bgClass"
                                     onclick="handleNotificationClick(@notification.Id, '@notification.Link')">
                                    <div class="d-flex align-items-start">
                                        <div class="flex-shrink-0">
                                            <div class="avatar avatar-md bg-@(colorClass)-subtle">
                                                <span class="avatar-title text-@colorClass rounded-circle">
                                                    <i class="ti @iconClass fs-lg"></i>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            @if (!string.IsNullOrEmpty(notification.Title))
                                            {
                                                <h6 class="mb-1 fw-semibold">@notification.Title</h6>
                                            }
                                            <p class="mb-2 text-muted">@notification.Message</p>
                                            <small class="text-muted">
                                                <i class="ti ti-clock me-1"></i>
                                                @{
                                                    var timeSpan = DateTime.Now - notification.CreatedDate;
                                                    var timeAgo = timeSpan.TotalMinutes < 1 ? "Just now" :
                                                                  timeSpan.TotalMinutes < 60 ? $"{(int)timeSpan.TotalMinutes} minutes ago" :
                                                                  timeSpan.TotalHours < 24 ? $"{(int)timeSpan.TotalHours} hours ago" :
                                                                  $"{(int)timeSpan.TotalDays} days ago";
                                                }
                                                @timeAgo
                                            </small>
                                        </div>
                                        <div class="flex-shrink-0 ms-2">
                                            @if (!notification.IsRead)
                                            {
                                                <span class="badge bg-primary rounded-circle badge-dot"></span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <div class="avatar avatar-xl bg-light mb-3">
                                <span class="avatar-title">
                                    <i class="ti ti-bell-off fs-1 text-muted"></i>
                                </span>
                            </div>
                            <h5 class="text-muted">No notifications yet</h5>
                            <p class="text-muted">You're all caught up!</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        async function handleNotificationClick(id, link) {
            try {
                // Mark as read
                await fetch(`/api/notifications/${id}/read`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                // Reload page to update UI
                if (link && link !== '' && link !== '#') {
                    window.location.href = link;
                } else {
                    location.reload();
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Create test notifications
        document.addEventListener('DOMContentLoaded', function() {
            const createTestBtn = document.getElementById('createTestBtn');
            if (createTestBtn) {
                createTestBtn.addEventListener('click', async function() {
                    const originalText = this.innerHTML;
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';

                    try {
                        const response = await fetch('/api/notifications/create-test', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            // Show success message
                            alert('Test notifications created successfully! Refresh the page to see them.');
                            location.reload();
                        } else {
                            alert('Failed to create test notifications. Please try again.');
                            this.disabled = false;
                            this.innerHTML = originalText;
                        }
                    } catch (error) {
                        console.error('Error creating test notifications:', error);
                        alert('An error occurred. Please try again.');
                        this.disabled = false;
                        this.innerHTML = originalText;
                    }
                });
            }
        });
    </script>
}
