@using MyPhotoBiz.ViewModels
@model IEnumerable<MyPhotoBiz.Models.Badge>

@{
    ViewBag.Title = "Badges";
    ViewBag.PageTitle = "Badges Management";
    ViewBag.Icon = "ti-award";
    ViewBag.Color = "warning";
}

<div class="container-fluid">
    <partial name="Partials/_PageTitle" />

    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="card-title mb-0">All Badges</h5>
                <div>
                    <form asp-action="SeedDefaultBadges" method="post" style="display: inline;">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-outline-success">
                            <i class="ti ti-seed me-1"></i> Seed Default Badges
                        </button>
                    </form>
                    <form asp-action="AwardNewUserBadgeToExisting" method="post" style="display: inline;" id="awardBadgeForm">
                        @Html.AntiForgeryToken()
                        <button type="button" class="btn btn-outline-primary" id="awardBadgeBtn">
                            <i class="ti ti-user-plus me-1"></i> Award New User Badge
                        </button>
                    </form>
                    <a asp-action="Create" class="btn btn-primary">
                        <i class="ti ti-plus me-1"></i> Create Badge
                    </a>
                </div>
            </div>

            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Icon</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Type</th>
                                <th>Color</th>
                                <th>Times Awarded</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var badge in Model)
                            {
                                <tr>
                                    <td>
                                        <div class="badge-icon-preview" style="color: @badge.Color; font-size: 1.5rem;">
                                            @if (!string.IsNullOrEmpty(badge.Icon))
                                            {
                                                @if (badge.Icon.StartsWith("ti-"))
                                                {
                                                    <i class="ti @badge.Icon"></i>
                                                }
                                                else
                                                {
                                                    <span>@badge.Icon</span>
                                                }
                                            }
                                            else
                                            {
                                                <i class="ti ti-award"></i>
                                            }
                                        </div>
                                    </td>
                                    <td><strong>@badge.Name</strong></td>
                                    <td>@badge.Description</td>
                                    <td><span class="badge bg-secondary">@badge.Type</span></td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div style="width: 30px; height: 20px; background-color: @badge.Color; border-radius: 4px; border: 1px solid #dee2e6;"></div>
                                            <code>@badge.Color</code>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">@badge.ClientBadges.Count</span>
                                    </td>
                                    <td>
                                        @if (badge.IsActive)
                                        {
                                            <span class="badge bg-success">Active</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Inactive</span>
                                        }
                                    </td>
                                    <td>
                                        <partial name="Partials/_ActionButtons" model="@(new ActionButtonsModel {
                                            Id = badge.Id,
                                            Controller = "Badges",
                                            ShowView = false,
                                            DeleteDataValue = badge.Name
                                        })" />
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="ti ti-award-off fs-1 text-muted d-block mb-3"></i>
                    <h5 class="text-muted">No badges found</h5>
                    <p class="text-muted">Create badges to reward your clients for their achievements.</p>
                    <div class="mt-3">
                        <form asp-action="SeedDefaultBadges" method="post" style="display: inline;">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-success me-2">
                                <i class="ti ti-seed me-1"></i> Seed Default Badges
                            </button>
                        </form>
                        <a asp-action="Create" class="btn btn-primary">
                            <i class="ti ti-plus me-1"></i> Create Custom Badge
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function attachDeleteHandlers() {
            function addHandlers() {
                document.querySelectorAll('.delete-btn').forEach(function(link) {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        var badgeName = this.getAttribute('data-item-name');
                        var deleteUrl = this.href;

                        // Validate anti-forgery token before attempting POST
                        var token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                        if (!token) {
                            console.error('Missing __RequestVerificationToken');
                            showError('Unable to perform delete: missing security token. Please refresh the page and try again.');
                            return;
                        }

                        confirmDelete(badgeName, function() {
                            fetch(deleteUrl, {
                                method: 'POST',
                                headers: {
                                    'RequestVerificationToken': token
                                }
                            })
                            .then(response => {
                                if (response.ok) {
                                    showSuccess('Badge deleted successfully!');
                                    setTimeout(() => window.location.reload(), 1500);
                                } else {
                                    showError('Failed to delete badge');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                showError('An error occurred while deleting the badge');
                            });
                        });
                    });
                });
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', addHandlers);
            } else {
                addHandlers();
            }
        })();

        // Award New User Badge confirmation
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('awardBadgeBtn')?.addEventListener('click', function() {
                confirmAction({
                    title: 'Award New User Badge?',
                    text: 'This will award the New User badge to all existing clients who don\'t have it yet.',
                    icon: 'question',
                    confirmButtonText: 'Yes, award badges',
                    confirmButtonColor: '#0d6efd'
                }).then((result) => {
                    if (result.isConfirmed) {
                        document.getElementById('awardBadgeForm').submit();
                    }
                });
            });
        });
    </script>
}
