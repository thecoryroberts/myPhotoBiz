@model MyPhotoBiz.ViewModels.ChangePasswordViewModel

<div class="modal fade" id="changePasswordModalElement" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="changePasswordForm" asp-action="ChangePassword" asp-controller="Users" asp-route-id="@Model.UserId" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="UserId" />

                <div class="modal-header">
                    <h5 class="modal-title" id="changePasswordModalLabel">
                        <i class="ti ti-key me-2"></i>Change Password
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <!-- User Info -->
                    <div class="alert alert-info d-flex align-items-center mb-3">
                        <i class="ti ti-info-circle fs-5 me-2"></i>
                        <div>
                            <strong>User:</strong> @Model.UserFullName<br />
                            <small class="text-muted">@Model.UserEmail</small>
                        </div>
                    </div>

                    <!-- New Password -->
                    <div class="mb-3">
                        <label asp-for="NewPassword" class="form-label">New Password <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input asp-for="NewPassword"
                                   class="form-control"
                                   type="password"
                                   id="newPassword"
                                   placeholder="Enter new password" />
                            <button class="btn btn-outline-secondary"
                                    type="button"
                                    onclick="togglePasswordVisibility('newPassword')">
                                <i class="ti ti-eye" id="newPassword-icon"></i>
                            </button>
                        </div>
                        <small class="text-muted">Minimum 12 characters with uppercase, lowercase, number, and special character</small>
                        <span asp-validation-for="NewPassword" class="text-danger d-block"></span>
                    </div>

                    <!-- Confirm Password -->
                    <div class="mb-3">
                        <label asp-for="ConfirmPassword" class="form-label">Confirm Password <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input asp-for="ConfirmPassword"
                                   class="form-control"
                                   type="password"
                                   id="confirmPassword"
                                   placeholder="Re-enter new password" />
                            <button class="btn btn-outline-secondary"
                                    type="button"
                                    onclick="togglePasswordVisibility('confirmPassword')">
                                <i class="ti ti-eye" id="confirmPassword-icon"></i>
                            </button>
                        </div>
                        <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                    </div>

                    <!-- Password Requirements -->
                    <div class="card bg-light">
                        <div class="card-body py-2 px-3">
                            <p class="mb-1 fw-semibold small">Password Requirements:</p>
                            <ul class="mb-0 small">
                                <li>At least 12 characters long</li>
                                <li>Contains uppercase letter (A-Z)</li>
                                <li>Contains lowercase letter (a-z)</li>
                                <li>Contains number (0-9)</li>
                                <li>Contains special character (!@@#$%^&*)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                        <i class="ti ti-x me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                        <span class="btn-text">
                            <i class="ti ti-check me-1"></i>Change Password
                        </span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm me-1"></span>
                            Changing...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Enable client-side validation
        $.validator.unobtrusive.parse($('#changePasswordForm'));

        // Handle form submission
        $('#changePasswordForm').on('submit', function(e) {
            e.preventDefault();

            if (!$(this).valid()) {
                return false;
            }

            var $form = $(this);
            var $btn = $('#changePasswordBtn');

            // Show loading state
            $btn.find('.btn-text').addClass('d-none');
            $btn.find('.btn-loading').removeClass('d-none');
            $btn.prop('disabled', true);

            $.ajax({
                url: $form.attr('action'),
                type: 'POST',
                data: $form.serialize(),
                success: function(result) {
                    if (result.success) {
                        // Close modal
                        var modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModalElement'));
                        modal.hide();

                        // Show success message
                        showToast('Success', result.message, 'success');

                        // Reload page
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showToast('Error', result.message, 'error');

                        // Reset button state
                        $btn.find('.btn-text').removeClass('d-none');
                        $btn.find('.btn-loading').addClass('d-none');
                        $btn.prop('disabled', false);
                    }
                },
                error: function(xhr) {
                    var message = 'Failed to change password';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        message = xhr.responseJSON.message;
                    }
                    showToast('Error', message, 'error');

                    // Reset button state
                    $btn.find('.btn-text').removeClass('d-none');
                    $btn.find('.btn-loading').addClass('d-none');
                    $btn.prop('disabled', false);
                }
            });

            return false;
        });

        // Real-time password validation
        $('#newPassword, #confirmPassword').on('input', function() {
            validatePasswordMatch();
        });
    });

    // Toggle password visibility
    function togglePasswordVisibility(inputId) {
        var input = document.getElementById(inputId);
        var icon = document.getElementById(inputId + '-icon');

        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('ti-eye');
            icon.classList.add('ti-eye-off');
        } else {
            input.type = 'password';
            icon.classList.remove('ti-eye-off');
            icon.classList.add('ti-eye');
        }
    }

    // Validate password match
    function validatePasswordMatch() {
        var newPassword = $('#newPassword').val();
        var confirmPassword = $('#confirmPassword').val();

        if (confirmPassword.length > 0 && newPassword !== confirmPassword) {
            $('#confirmPassword').addClass('is-invalid');
        } else {
            $('#confirmPassword').removeClass('is-invalid');
        }
    }

    function showToast(title, message, type) {
        if (typeof toastr !== 'undefined') {
            toastr[type](message, title);
        } else {
            alert(title + ': ' + message);
        }
    }
</script>
