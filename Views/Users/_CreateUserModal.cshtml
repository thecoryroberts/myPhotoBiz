@model MyPhotoBiz.ViewModels.CreateUserViewModel

<div class="modal fade" id="createUserModalElement" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="createUserForm" asp-action="Create" asp-controller="Users" method="post">
                @Html.AntiForgeryToken()

                <div class="modal-header border-light">
                    <h5 class="modal-title fw-semibold" id="createUserModalLabel">
                        <i class="ti ti-user-plus me-2"></i>Create New User
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <!-- First Name -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="FirstName" class="form-label fw-semibold">
                                <i class="ti ti-user me-1 text-muted"></i>First Name <span class="text-danger">*</span>
                            </label>
                            <input asp-for="FirstName" class="form-control" placeholder="Enter first name" />
                            <span asp-validation-for="FirstName" class="text-danger small"></span>
                        </div>

                        <!-- Last Name -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="LastName" class="form-label fw-semibold">
                                <i class="ti ti-user me-1 text-muted"></i>Last Name <span class="text-danger">*</span>
                            </label>
                            <input asp-for="LastName" class="form-control" placeholder="Enter last name" />
                            <span asp-validation-for="LastName" class="text-danger small"></span>
                        </div>

                        <!-- Email -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="Email" class="form-label fw-semibold">
                                <i class="ti ti-mail me-1 text-muted"></i>Email <span class="text-danger">*</span>
                            </label>
                            <input asp-for="Email" class="form-control" type="email" placeholder="user@example.com" />
                            <span asp-validation-for="Email" class="text-danger small"></span>
                        </div>

                        <!-- Phone Number -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="PhoneNumber" class="form-label fw-semibold">
                                <i class="ti ti-phone me-1 text-muted"></i>Phone Number
                            </label>
                            <input asp-for="PhoneNumber" class="form-control" type="tel" placeholder="(123) 456-7890" />
                            <span asp-validation-for="PhoneNumber" class="text-danger small"></span>
                        </div>

                        <!-- Password -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="Password" class="form-label fw-semibold">
                                <i class="ti ti-lock me-1 text-muted"></i>Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input asp-for="Password" class="form-control" type="password" id="createPassword" placeholder="Enter password" />
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('createPassword')">
                                    <i class="ti ti-eye" id="createPassword-icon"></i>
                                </button>
                            </div>
                            <small class="text-muted">Minimum 12 characters with uppercase, lowercase, number, and special character</small>
                            <span asp-validation-for="Password" class="text-danger small d-block"></span>
                        </div>

                        <!-- Confirm Password -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="ConfirmPassword" class="form-label fw-semibold">
                                <i class="ti ti-lock-check me-1 text-muted"></i>Confirm Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input asp-for="ConfirmPassword" class="form-control" type="password" id="createConfirmPassword" placeholder="Re-enter password" />
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('createConfirmPassword')">
                                    <i class="ti ti-eye" id="createConfirmPassword-icon"></i>
                                </button>
                            </div>
                            <span asp-validation-for="ConfirmPassword" class="text-danger small"></span>
                        </div>

                        <!-- Roles -->
                        <div class="col-12 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="ti ti-shield-check me-1 text-muted"></i>Roles <span class="text-danger">*</span>
                            </label>
                            <div class="border rounded p-3 bg-light">
                                @if (Model?.AvailableRoles?.Any() == true)
                                {
                                    <div class="row">
                                        @foreach (var role in Model.AvailableRoles)
                                        {
                                            <div class="col-md-4 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input"
                                                           type="checkbox"
                                                           name="SelectedRoleIds"
                                                           value="@role.Id"
                                                           id="role_@role.Id" />
                                                    <label class="form-check-label" for="role_@role.Id">
                                                        @{
                                                            var badgeClass = role.Name switch
                                                            {
                                                                "Admin" => "bg-danger-subtle text-danger",
                                                                "Photographer" => "bg-primary-subtle text-primary",
                                                                "Client" => "bg-success-subtle text-success",
                                                                _ => "bg-secondary-subtle text-secondary"
                                                            };
                                                        }
                                                        <span class="badge @badgeClass">@role.Name</span>
                                                    </label>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <p class="text-muted mb-0">No roles available</p>
                                }
                            </div>
                            <span asp-validation-for="SelectedRoleIds" class="text-danger small"></span>
                        </div>

                        <div class="col-12"><hr class="my-3" /></div>

                        <!-- Email Confirmed -->
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch">
                                <input asp-for="EmailConfirmed" class="form-check-input" type="checkbox" role="switch" />
                                <label asp-for="EmailConfirmed" class="form-check-label fw-semibold">
                                    <i class="ti ti-mail-check me-1 text-muted"></i>Email Confirmed
                                </label>
                            </div>
                            <small class="text-muted">Check if the email address has been verified</small>
                        </div>

                        <!-- Is Active -->
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch">
                                <input asp-for="IsActive" class="form-check-input" type="checkbox" role="switch" checked />
                                <label asp-for="IsActive" class="form-check-label fw-semibold">
                                    <i class="ti ti-user-check me-1 text-muted"></i>Active Account
                                </label>
                            </div>
                            <small class="text-muted">Inactive accounts cannot log in</small>
                        </div>
                    </div>
                </div>

                <div class="modal-footer border-light">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                        <i class="ti ti-x me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="createUserBtn">
                        <span class="btn-text">
                            <i class="ti ti-check me-1"></i>Create User
                        </span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm me-1"></span>
                            Creating...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Enable client-side validation
        $.validator.unobtrusive.parse($('#createUserForm'));

        // Handle form submission
        $('#createUserForm').on('submit', function(e) {
            e.preventDefault();

            if (!$(this).valid()) {
                return false;
            }

            var $form = $(this);
            var $btn = $('#createUserBtn');

            // Show loading state
            $btn.find('.btn-text').addClass('d-none');
            $btn.find('.btn-loading').removeClass('d-none');
            $btn.prop('disabled', true);

            $.ajax({
                url: $form.attr('action'),
                type: 'POST',
                data: $form.serialize(),
                success: function(result) {
                    if (result.success) {
                        // Close modal
                        var modal = bootstrap.Modal.getInstance(document.getElementById('createUserModalElement'));
                        modal.hide();

                        // Show success message
                        showToast('Success', result.message, 'success');

                        // Reload page to show new user
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showToast('Error', result.message, 'error');

                        // Reset button state
                        $btn.find('.btn-text').removeClass('d-none');
                        $btn.find('.btn-loading').addClass('d-none');
                        $btn.prop('disabled', false);
                    }
                },
                error: function(xhr) {
                    var message = 'Failed to create user';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        message = xhr.responseJSON.message;
                    }
                    showToast('Error', message, 'error');

                    // Reset button state
                    $btn.find('.btn-text').removeClass('d-none');
                    $btn.find('.btn-loading').addClass('d-none');
                    $btn.prop('disabled', false);
                }
            });

            return false;
        });
    });

    // Toggle password visibility
    function togglePassword(inputId) {
        var input = document.getElementById(inputId);
        var icon = document.getElementById(inputId + '-icon');

        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('ti-eye');
            icon.classList.add('ti-eye-off');
        } else {
            input.type = 'password';
            icon.classList.remove('ti-eye-off');
            icon.classList.add('ti-eye');
        }
    }

    function showToast(title, message, type) {
        if (typeof toastr !== 'undefined') {
            toastr[type](message, title);
        } else {
            alert(title + ': ' + message);
        }
    }
</script>
