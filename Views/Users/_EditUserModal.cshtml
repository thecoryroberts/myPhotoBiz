@model MyPhotoBiz.ViewModels.EditUserViewModel

<div class="modal fade" id="editUserModalElement" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="editUserForm" asp-action="Edit" asp-controller="Users" asp-route-id="@Model.Id" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="Id" />

                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">
                        <i class="ti ti-edit me-2"></i>Edit User
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <!-- User Info -->
                        <div class="col-12 mb-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                                <img src="@Url.Content(Model.ProfilePicture ?? "~/images/users/user-1.jpg")"
                                     class="rounded-circle me-3"
                                     width="60"
                                     height="60"
                                     alt="@Model.FirstName @Model.LastName" />
                                <div>
                                    <h6 class="mb-0">@Model.FirstName @Model.LastName</h6>
                                    <small class="text-muted">@Model.Email</small>
                                </div>
                            </div>
                        </div>

                        <!-- First Name -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="FirstName" class="form-label">First Name <span class="text-danger">*</span></label>
                            <input asp-for="FirstName" class="form-control" placeholder="Enter first name" />
                            <span asp-validation-for="FirstName" class="text-danger"></span>
                        </div>

                        <!-- Last Name -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="LastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                            <input asp-for="LastName" class="form-control" placeholder="Enter last name" />
                            <span asp-validation-for="LastName" class="text-danger"></span>
                        </div>

                        <!-- Email -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="Email" class="form-label">Email <span class="text-danger">*</span></label>
                            <input asp-for="Email" class="form-control" type="email" placeholder="user@example.com" />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>

                        <!-- Phone Number -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="PhoneNumber" class="form-label">Phone Number</label>
                            <input asp-for="PhoneNumber" class="form-control" type="tel" placeholder="(123) 456-7890" />
                            <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                        </div>

                        <!-- Roles -->
                        <div class="col-12 mb-3">
                            <label class="form-label">Roles <span class="text-danger">*</span></label>
                            <div class="border rounded p-3">
                                @if (Model?.AvailableRoles?.Any() == true)
                                {
                                    <div class="row">
                                        @foreach (var role in Model.AvailableRoles)
                                        {
                                            var isChecked = Model.SelectedRoleIds?.Contains(role.Id) ?? false;
                                            <div class="col-md-4 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input"
                                                           type="checkbox"
                                                           name="SelectedRoleIds"
                                                           value="@role.Id"
                                                           id="edit_role_@role.Id"
                                                           @(isChecked ? "checked" : "") />
                                                    <label class="form-check-label" for="edit_role_@role.Id">
                                                        @{
                                                            var badgeClass = role.Name switch
                                                            {
                                                                "Admin" => "bg-danger-subtle text-danger",
                                                                "Photographer" => "bg-primary-subtle text-primary",
                                                                "Client" => "bg-success-subtle text-success",
                                                                _ => "bg-secondary-subtle text-secondary"
                                                            };
                                                        }
                                                        <span class="badge @badgeClass">@role.Name</span>
                                                    </label>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <p class="text-muted mb-0">No roles available</p>
                                }
                            </div>
                            <span asp-validation-for="SelectedRoleIds" class="text-danger"></span>
                        </div>

                        <!-- Email Confirmed -->
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch">
                                <input asp-for="EmailConfirmed" class="form-check-input" type="checkbox" role="switch" />
                                <label asp-for="EmailConfirmed" class="form-check-label">Email Confirmed</label>
                            </div>
                            <small class="text-muted">Check if the email address has been verified</small>
                        </div>

                        <!-- Is Active -->
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch">
                                <input asp-for="IsActive" class="form-check-input" type="checkbox" role="switch" />
                                <label asp-for="IsActive" class="form-check-label">Active Account</label>
                            </div>
                            <small class="text-muted">Inactive accounts cannot log in</small>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                        <i class="ti ti-x me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="editUserBtn">
                        <span class="btn-text">
                            <i class="ti ti-check me-1"></i>Save Changes
                        </span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm me-1"></span>
                            Saving...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Enable client-side validation
        $.validator.unobtrusive.parse($('#editUserForm'));

        // Handle form submission
        $('#editUserForm').on('submit', function(e) {
            e.preventDefault();

            if (!$(this).valid()) {
                return false;
            }

            var $form = $(this);
            var $btn = $('#editUserBtn');

            // Show loading state
            $btn.find('.btn-text').addClass('d-none');
            $btn.find('.btn-loading').removeClass('d-none');
            $btn.prop('disabled', true);

            $.ajax({
                url: $form.attr('action'),
                type: 'POST',
                data: $form.serialize(),
                success: function(result) {
                    if (result.success) {
                        // Close modal
                        var modal = bootstrap.Modal.getInstance(document.getElementById('editUserModalElement'));
                        modal.hide();

                        // Show success message
                        showToast('Success', result.message, 'success');

                        // Reload page to show updated user
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showToast('Error', result.message, 'error');

                        // Reset button state
                        $btn.find('.btn-text').removeClass('d-none');
                        $btn.find('.btn-loading').addClass('d-none');
                        $btn.prop('disabled', false);
                    }
                },
                error: function(xhr) {
                    var message = 'Failed to update user';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        message = xhr.responseJSON.message;
                    }
                    showToast('Error', message, 'error');

                    // Reset button state
                    $btn.find('.btn-text').removeClass('d-none');
                    $btn.find('.btn-loading').addClass('d-none');
                    $btn.prop('disabled', false);
                }
            });

            return false;
        });
    });

    function showToast(title, message, type) {
        if (typeof toastr !== 'undefined') {
            toastr[type](message, title);
        } else {
            alert(title + ': ' + message);
        }
    }
</script>
