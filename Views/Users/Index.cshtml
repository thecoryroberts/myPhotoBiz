@{
    ViewBag.Purpose = "List and manage users.";
}

@model MyPhotoBiz.ViewModels.UsersIndexViewModel

@{
    ViewBag.Title = "Users";
    ViewBag.PageTitle = "User Management";
    ViewBag.Icon = "ti-users";
    ViewBag.Color = "info";
}

@Html.AntiForgeryToken()

<div class="container-fluid">
    <partial name="Partials/_PageTitle" />

    <div class="row">
        <div class="col-12">
            <div data-table data-table-rows-per-page="10" class="card">
                <div class="card-header border-light justify-content-between">
                    <div class="d-flex gap-2">
                        <div class="app-search">
                            <input data-table-search type="text" class="form-control" placeholder="Search users...">
                            <i data-lucide="search" class="app-search-icon text-muted"></i>
                        </div>
                        <button data-table-delete-selected class="btn btn-danger d-none">Delete</button>
                        <button type="button" class="btn btn-info rounded-circle btn-icon" onclick="showCreateUserModal()"
                                aria-label="Add new user">
                            <i class="ti ti-plus" aria-hidden="true"></i>
                        </button>
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        <span class="me-2 fw-semibold">Filter By:</span>
                        <div class="app-search">
                            <select data-table-filter="role" class="form-select form-control my-1 my-md-0">
                                <option value="">All Roles</option>
                                @foreach (var role in Model.AvailableRoles)
                                {
                                    <option value="@role.Name">@role.Name</option>
                                }
                            </select>
                            <i data-lucide="shield" class="app-search-icon text-muted"></i>
                        </div>
                        <div class="app-search">
                            <select data-table-filter="status" class="form-select form-control my-1 my-md-0">
                                <option value="">All Statuses</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Locked">Locked</option>
                                <option value="Pending">Pending</option>
                            </select>
                            <i data-lucide="user-check" class="app-search-icon text-muted"></i>
                        </div>
                        <div>
                            <select data-table-set-rows-per-page class="form-select form-control my-1 my-md-0">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                    </div>
                </div>

                @await Html.PartialAsync("Partials/_IndexTableShell", new MyPhotoBiz.ViewModels.IndexTableShellViewModel
                {
                    HasItems = Model?.Users?.Any() == true,
                    EmptyContent = @<div class="card-body text-center py-5">
                        <div class="empty-state">
                            <div class="empty-state-icon bg-info-subtle rounded-circle mx-auto mb-4" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;">
                                <i class="ti ti-users fs-1 text-info"></i>
                            </div>
                            <h4 class="mb-2">No users yet</h4>
                            <p class="text-muted mb-4">Create your first user to start managing access and roles.</p>
                            <button type="button" class="btn btn-info" onclick="showCreateUserModal()">
                                <i class="ti ti-plus me-1"></i> Create Your First User
                            </button>
                        </div>
                    </div>,
                    Thead = @<thead class="bg-light align-middle bg-opacity-25 thead-sm">
                        <tr class="text-uppercase fs-xxs">
                            <th scope="col" class="ps-3 th-checkbox">
                                <input data-table-select-all type="checkbox"
                                       class="form-check-input form-check-input-light fs-14 mt-0"
                                       aria-label="Select all users">
                            </th>
                            <th scope="col" data-table-sort="name">User</th>
                            <th scope="col" data-table-sort="email">Email</th>
                            <th scope="col" data-table-filter-column="role">Roles</th>
                            <th scope="col" data-table-filter-column="status">Status</th>
                            <th scope="col" data-table-sort="createdDate">Joined</th>
                            <th scope="col" class="text-center">Actions</th>
                        </tr>
                    </thead>,
                    Tbody = @<tbody>
                        @foreach (var user in Model?.Users?.ToList() ?? Enumerable.Empty<dynamic>())
                        {
                            <tr data-role="@string.Join(",", user.Roles)"
                                data-status="@user.Status">
                                <td class="ps-3">
                                    <input type="checkbox"
                                           class="form-check-input form-check-input-light fs-14 file-item-check mt-0"
                                           aria-label="Select user @user.FullName">
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="avatar avatar-sm">
                                            @if (!string.IsNullOrEmpty(user.ProfilePicture))
                                            {
                                                <img src="@Url.Content(user.ProfilePicture)"
                                                     class="rounded-circle avatar-sm"
                                                     width="32"
                                                     height="32"
                                                     style="object-fit: cover;"
                                                     onerror="this.onerror=null;this.src='@Url.Content("~/images/users/user-1.jpg")';"
                                                     alt="@user.FullName">
                                            }
                                            else
                                            {
                                                var initials = MyPhotoBiz.Helpers.ViewHelper.GetInitials(user.FirstName, user.LastName);
                                                <span class="avatar-title bg-info-subtle text-info rounded-circle">
                                                    @initials
                                                </span>
                                            }
                                        </div>
                                        <div>
                                            <h6 class="mb-0 fw-semibold">@user.FullName</h6>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="text-muted">@user.Email</span>
                                </td>
                                <td data-filter-value="@string.Join(",", user.Roles)">
                                    @foreach (var role in user.Roles)
                                    {
                                        var badgeClass = role switch
                                        {
                                            "Admin" => "bg-danger-subtle text-danger",
                                            "Photographer" => "bg-primary-subtle text-primary",
                                            "Client" => "bg-success-subtle text-success",
                                            _ => "bg-secondary-subtle text-secondary"
                                        };
                                        <span class="badge @badgeClass me-1">@role</span>
                                    }
                                </td>
                                <td data-filter-value="@user.Status">
                                    @{
                                        var statusBadge = user.Status switch
                                        {
                                            "Active" => "bg-success-subtle text-success",
                                            "Inactive" => "bg-secondary-subtle text-secondary",
                                            "Locked" => "bg-danger-subtle text-danger",
                                            "Pending" => "bg-warning-subtle text-warning",
                                            _ => "bg-secondary-subtle text-secondary"
                                        };
                                        var statusIcon = user.Status switch
                                        {
                                            "Active" => "ti-check",
                                            "Inactive" => "ti-minus",
                                            "Locked" => "ti-lock",
                                            "Pending" => "ti-clock",
                                            _ => "ti-help"
                                        };
                                    }
                                    <span class="badge @statusBadge">
                                        <i class="ti @statusIcon me-1" aria-hidden="true"></i>@user.Status
                                    </span>
                                </td>
                                <td>
                                    <small class="text-muted">@user.CreatedDate.ToString("MMM dd, yyyy")</small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center justify-content-center gap-1">
                                        <a asp-action="Details"
                                           asp-route-id="@user.Id"
                                           class="btn btn-sm btn-outline-secondary btn-icon"
                                           title="View Details"
                                           aria-label="View details for @user.FullName">
                                            <i class="ti ti-eye" aria-hidden="true"></i>
                                        </a>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-secondary btn-icon"
                                                onclick="showEditUserModal('@user.Id')"
                                                title="Edit User"
                                                aria-label="Edit @user.FullName">
                                            <i class="ti ti-edit" aria-hidden="true"></i>
                                        </button>
                                        @if (user.Status == "Locked")
                                        {
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-secondary btn-icon"
                                                    onclick="unlockUser('@user.Id')"
                                                    title="Unlock User"
                                                    aria-label="Unlock @user.FullName">
                                                <i class="ti ti-lock-open" aria-hidden="true"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-secondary btn-icon"
                                                    onclick="lockUser('@user.Id')"
                                                    title="Lock User"
                                                    aria-label="Lock @user.FullName">
                                                <i class="ti ti-lock" aria-hidden="true"></i>
                                            </button>
                                        }
                                        <button type="button"
                                                class="btn btn-sm btn-outline-secondary btn-icon"
                                                onclick="showChangePasswordModal('@user.Id')"
                                                title="Change Password"
                                                aria-label="Change password for @user.FullName">
                                            <i class="ti ti-key" aria-hidden="true"></i>
                                        </button>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-secondary btn-icon"
                                                onclick="deleteUser('@user.Id', '@user.FullName')"
                                                title="Delete User"
                                                aria-label="Delete @user.FullName">
                                            <i class="ti ti-trash" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                })

                @if (Model?.Users?.Any() == true)
                {
                    <div class="card-footer border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div data-table-pagination-info="users"></div>
                            <div data-table-pagination></div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="createUserModal"></div>
<div id="editUserModal"></div>
<div id="changePasswordModal"></div>

@section Scripts {
    <script src="~/js/pages/custom-table.js"></script>
    <script>
        // Show Create User Modal
        function showCreateUserModal() {
            $.ajax({
                url: '@Url.Action("Create", "Users")',
                type: 'GET',
                success: function(result) {
                    $('#createUserModal').html(result);
                    var modal = new bootstrap.Modal(document.getElementById('createUserModalElement'));
                    modal.show();
                },
                error: function(xhr) {
                    showError('Failed to load create user form');
                }
            });
        }

        // Show Edit User Modal
        function showEditUserModal(userId) {
            $.ajax({
                url: '@Url.Action("Edit", "Users")/' + userId,
                type: 'GET',
                success: function(result) {
                    $('#editUserModal').html(result);
                    var modal = new bootstrap.Modal(document.getElementById('editUserModalElement'));
                    modal.show();
                },
                error: function(xhr) {
                    showError('Failed to load edit user form');
                }
            });
        }

        // Show Change Password Modal
        function showChangePasswordModal(userId) {
            $.ajax({
                url: '@Url.Action("ChangePassword", "Users")/' + userId,
                type: 'GET',
                success: function(result) {
                    $('#changePasswordModal').html(result);
                    var modal = new bootstrap.Modal(document.getElementById('changePasswordModalElement'));
                    modal.show();
                },
                error: function(xhr) {
                    showError('Failed to load change password form');
                }
            });
        }

        // Lock User
        function lockUser(userId) {
            confirmAction({
                title: 'Lock User Account?',
                text: 'Are you sure you want to lock this user account?',
                icon: 'warning',
                confirmButtonText: 'Yes, lock account',
                confirmButtonColor: '#dc3545'
            }).then((result) => {
                if (result.isConfirmed) {
                    var formData = new FormData();
                    formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

                    $.ajax({
                        url: '@Url.Action("Lock", "Users")/' + userId,
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            if (response.success) {
                                showSuccess(response.message);
                                setTimeout(() => location.reload(), 1500);
                            } else {
                                showError(response.message);
                            }
                        },
                        error: function(xhr) {
                            showError('Failed to lock user');
                        }
                    });
                }
            });
        }

        // Unlock User
        function unlockUser(userId) {
            var formData = new FormData();
            formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

            $.ajax({
                url: '@Url.Action("Unlock", "Users")/' + userId,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        showSuccess(response.message);
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showError(response.message);
                    }
                },
                error: function(xhr) {
                    showError('Failed to unlock user');
                }
            });
        }

        // Delete User
        function deleteUser(userId, userName) {
            confirmDelete(userName, function() {
                var formData = new FormData();
                formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

                $.ajax({
                    url: '@Url.Action("Delete", "Users")/' + userId,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            showSuccess(response.message);
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            showError(response.message);
                        }
                    },
                    error: function(xhr) {
                        showError('Failed to delete user');
                    }
                });
            });
        }
    </script>
}
