@using System.Text.Json
@{
    var success = TempData["Success"] as string ?? TempData["SuccessMessage"] as string;
    var error = TempData["Error"] as string ?? TempData["ErrorMessage"] as string;
    var warning = TempData["WarningMessage"] as string ?? TempData["PasswordWarning"] as string;

    var uploadWarningsJson = TempData["UploadWarnings"] as string;
    List<string>? uploadWarnings = null;
    if (!string.IsNullOrEmpty(uploadWarningsJson))
    {
        try { uploadWarnings = JsonSerializer.Deserialize<List<string>>(uploadWarningsJson); }
        catch { uploadWarnings = new List<string> { uploadWarningsJson }; }
    }
}


<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0" id="confirmModalHeader">
                <h5 class="modal-title fw-semibold" id="confirmModalTitle">Are you sure?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-3">
                <div class="d-flex align-items-start gap-3">
                    <div class="flex-shrink-0">
                        <span class="rounded-circle fs-lg" id="confirmModalIcon" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;">
                            <i class="ti ti-alert-triangle"></i>
                        </span>
                    </div>
                    <div class="flex-grow-1">
                        <p id="confirmModalText" class="text-muted mb-0"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal" id="confirmModalCancelBtn">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmModalConfirmBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        var iconMap = {
            success: { bg: 'success', icon: 'ti-circle-check' },
            error: { bg: 'danger', icon: 'ti-alert-circle' },
            warning: { bg: 'warning', icon: 'ti-alert-triangle' },
            info: { bg: 'info', icon: 'ti-info-circle' }
        };

        function getContainer() {
            var container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.setAttribute('aria-live', 'polite');
                container.setAttribute('aria-atomic', 'true');
                container.className = 'position-fixed top-0 end-0 p-3';
                container.style.zIndex = '1090';
                document.body.appendChild(container);
            }
            return container;
        }

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        var _toast = window._bootstrapToast = window.showToast = function(icon, title, timer) {
            timer = timer || 5000;
            var config = iconMap[icon] || iconMap.info;
            var container = getContainer();

            var toastEl = document.createElement('div');
            toastEl.className = 'toast align-items-center text-bg-' + config.bg + ' border-0 mb-2';
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            toastEl.innerHTML =
                '<div class="d-flex">' +
                    '<div class="toast-body d-flex align-items-center gap-2">' +
                        '<i class="ti ' + config.icon + ' fs-5"></i>' +
                        '<span>' + escapeHtml(title) + '</span>' +
                    '</div>' +
                    '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>' +
                '</div>';

            container.appendChild(toastEl);
            var bsToast = new bootstrap.Toast(toastEl, { delay: timer });
            bsToast.show();

            toastEl.addEventListener('hidden.bs.toast', function() {
                toastEl.remove();
            });
        };

        window.showSuccess = function(title, timer) {
            _toast('success', title, timer || 5000);
        };

        window.showError = function(title, timer) {
            _toast('error', title, timer || 5000);
        };

        window.showWarning = function(title, timer) {
            _toast('warning', title, timer || 5000);
        };

        window.showInfo = function(title, timer) {
            _toast('info', title, timer || 5000);
        };

        // Confirmation dialog (returns a Promise)
        window.confirmAction = function(options) {
            return new Promise(function(resolve) {
                var title = options.title || 'Are you sure?';
                var text = options.text || options.html || '';
                var confirmText = options.confirmButtonText || 'Yes';
                var cancelText = options.cancelButtonText || 'Cancel';
                var icon = options.icon || 'warning';
                var confirmColor = options.confirmButtonColor || '';

                var modalEl = document.getElementById('confirmModal');
                var header = document.getElementById('confirmModalHeader');
                var titleEl = document.getElementById('confirmModalTitle');
                var textEl = document.getElementById('confirmModalText');
                var iconEl = document.getElementById('confirmModalIcon');
                var confirmBtn = document.getElementById('confirmModalConfirmBtn');
                var cancelBtn = document.getElementById('confirmModalCancelBtn');

                titleEl.textContent = title;
                textEl.innerHTML = text;
                confirmBtn.textContent = confirmText;
                cancelBtn.textContent = cancelText;

                // Reset styling
                header.className = 'modal-header border-0';
                iconEl.className = 'rounded-circle fs-lg';
                iconEl.style.cssText = 'width:40px;height:40px;display:flex;align-items:center;justify-content:center;';
                confirmBtn.className = 'btn';

                if (icon === 'warning' || icon === 'error') {
                    header.classList.add('bg-danger', 'text-white');
                    iconEl.classList.add('bg-danger-subtle', 'text-danger');
                    iconEl.querySelector('i').className = 'ti ti-alert-triangle';
                    confirmBtn.classList.add('btn-danger');
                } else if (icon === 'question' || icon === 'info') {
                    header.classList.add('bg-primary', 'text-white');
                    iconEl.classList.add('bg-primary-subtle', 'text-primary');
                    iconEl.querySelector('i').className = 'ti ti-help';
                    confirmBtn.classList.add('btn-primary');
                } else {
                    header.classList.add('bg-warning', 'text-dark');
                    iconEl.classList.add('bg-warning-subtle', 'text-warning');
                    iconEl.querySelector('i').className = 'ti ti-alert-triangle';
                    confirmBtn.classList.add('btn-warning');
                }

                if (confirmColor === '#d33' || confirmColor === '#dc3545') {
                    confirmBtn.className = 'btn btn-danger';
                }

                var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                var resolved = false;

                function cleanup() {
                    confirmBtn.removeEventListener('click', onConfirm);
                    modalEl.removeEventListener('hidden.bs.modal', onHidden);
                }

                function onConfirm() {
                    resolved = true;
                    modal.hide();
                    cleanup();
                    resolve({ isConfirmed: true, isDismissed: false });
                }

                function onHidden() {
                    cleanup();
                    if (!resolved) {
                        resolve({ isConfirmed: false, isDismissed: true });
                    }
                }

                confirmBtn.addEventListener('click', onConfirm);
                modalEl.addEventListener('hidden.bs.modal', onHidden);
                modal.show();
            });
        };

        // Delete confirmation helper
        window.confirmDelete = function(itemName, onConfirm) {
            return confirmAction({
                title: 'Delete ' + itemName + '?',
                text: 'This action cannot be undone.',
                icon: 'warning',
                confirmButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            }).then(function(result) {
                if (result.isConfirmed && onConfirm) {
                    onConfirm();
                }
                return result;
            });
        };

        // Show TempData messages on load
        document.addEventListener('DOMContentLoaded', function() {
            @if (!string.IsNullOrEmpty(success))
            {
                <text>showSuccess('@Html.Raw(success.Replace("'", "\\'").Replace("\n", "\\n"))');</text>
            }
            @if (!string.IsNullOrEmpty(error))
            {
                <text>showError('@Html.Raw(error.Replace("'", "\\'").Replace("\n", "\\n"))');</text>
            }
            @if (!string.IsNullOrEmpty(warning))
            {
                <text>showWarning('@Html.Raw(warning.Replace("'", "\\'").Replace("\n", "\\n"))');</text>
            }
            @if (uploadWarnings != null && uploadWarnings.Count > 0)
            {
                var warningHtml = string.Join("<br>", uploadWarnings.Select(w => System.Web.HttpUtility.HtmlEncode(w)));
                <text>showWarning('@Html.Raw(warningHtml.Replace("'", "\\'"))', 8000);</text>
            }
        });
    })();
</script>
