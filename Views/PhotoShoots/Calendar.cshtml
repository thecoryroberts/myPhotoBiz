@{
    ViewBag.Title = "Calendar";
    ViewBag.PageTitle = "Photo Shoot Calendar";
    ViewBag.SubTitle = "Photo Shoots";
    ViewBag.SubTitleUrl = Url.Action("Index", "PhotoShoots");
    ViewBag.Icon = "ti-calendar";
    ViewBag.Color = "warning";
    ViewBag.ActionUrl = Url.Action("Index", "PhotoShoots");
    ViewBag.ActionText = "List View";
    ViewBag.ActionIcon = "ti-list";
    ViewBag.ActionColor = "light";
}

@section styles
{
    <link href="~/lib/fullcalendar/main.css" rel="stylesheet" />
}

<div class="container-fluid">
    <partial name="Partials/_PageTitle" />

    <div class="outlook-box">
        <!-- Sidebar -->
        <div class="card h-100 mb-0 d-none d-lg-flex rounded-end-0">
            <div class="card-body">
                <button class="btn btn-primary w-100 btn-new-event" data-bs-toggle="modal"
                        data-bs-target="#event-modal">
                    <i class="ti ti-plus me-2 align-middle"></i>
                    New PhotoShoot
                </button>

                <div id="external-events" class="mt-3">
                    <p class="text-muted mt-2 fst-italic fs-xs mb-3">Drag and drop or click on the calendar</p>

                    <div class="external-event fc-event bg-success-subtle text-success border-start border-3 border-success fw-semibold"
                         data-class="bg-success-subtle text-success border-start border-3 border-success">
                        <i class="ti ti-circle-filled me-2"></i>Sample Shoot
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="card h-100 mb-0 rounded-start-0 flex-grow-1 border-start-0">
            <div class="d-lg-none d-inline-flex card-header">
                <button class="btn btn-primary btn-new-event" data-bs-toggle="modal" data-bs-target="#event-modal">
                    <i class="ti ti-plus me-2 align-middle"></i>
                    Create New PhotoShoot
                </button>
            </div>

            <div class="card-body" style="height: calc(100% - 350px);" data-simplebar data-simplebar-md>
                <div id="calendar"></div>
            </div>
        </div>
    </div>

    <!-- Modal Add/Edit -->
    <div class="modal fade" id="event-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <form class="needs-validation" id="shoot-form" novalidate>
                    <div class="modal-header">
                        <h4 class="modal-title" id="modal-title">Create Shoot</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <input type="hidden" id="psId" />

                        <div class="mb-2">
                            <label class="form-label">Title</label>
                            <input id="title" class="form-control" required />
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Scheduled Date</label>
                            <input id="scheduledDate" type="datetime-local" class="form-control" required />
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Duration (Hours)</label>
                            <input id="durationHours" type="number" min="1" class="form-control" />
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Location</label>
                            <input id="location" class="form-control" />
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Description</label>
                            <textarea id="description" class="form-control"></textarea>
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Price</label>
                            <input id="price" type="number" step="0.01" class="form-control" />
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Status</label>
                            <select id="status" class="form-select">
                                <option>Scheduled</option>
                                <option>InProgress</option>
                                <option>Completed</option>
                                <option>Cancelled</option>
                            </select>
                        </div>

                        <!-- Dynamic Client Dropdown -->
                        <div class="mb-2">
                            <label class="form-label">Client</label>
                            <select id="clientId" class="form-select" required></select>
                        </div>

                        <!-- Dynamic Photographer Dropdown -->
                        <div class="mb-2">
                            <label class="form-label">Photographer</label>
                            <select id="photographerId" class="form-select" required></select>
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Notes</label>
                            <textarea id="notes" class="form-control"></textarea>
                        </div>

                        <div class="d-flex flex-wrap align-items-center gap-2 mt-3">
                            <button type="button" class="btn btn-danger" id="btn-delete">Delete</button>
                            <button type="button" class="btn btn-light ms-auto" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary" id="btn-save">Save</button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>

</div>

@section scripts
{
    <script src="~/plugins/fullcalendar/index.global.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // ---------------------------------------
            // Load Clients + Photographers into dropdowns
            // ---------------------------------------
            function loadDropdowns(selectedClientId = null, selectedPhotographerId = null) {

                // Load Clients
                fetch("/PhotoShoots/GetClients")
                    .then(res => res.json())
                    .then(data => {
                        let ddl = document.getElementById("clientId");
                        ddl.innerHTML = "<option value=''>Select Client</option>";

                        data.forEach(c => {
                            ddl.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                        });

                        if (selectedClientId) ddl.value = selectedClientId;
                    });

                // Load Photographers
                fetch("/PhotoShoots/GetPhotographers")
                    .then(res => res.json())
                    .then(data => {
                        let ddl = document.getElementById("photographerId");
                        ddl.innerHTML = "<option value=''>Select Photographer</option>";

                        data.forEach(p => {
                            ddl.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                        });

                        if (selectedPhotographerId) ddl.value = selectedPhotographerId;
                    });
            }

            // ---------------------------------------
            // FullCalendar Setup
            // ---------------------------------------
            var calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: "dayGridMonth",
                editable: true,
                selectable: true,
                eventSources: [{ url: "/PhotoShoots/GetEvents", method: "GET" }],

                dateClick: function (info) {
                    resetModal();
                    loadDropdowns(); // load fresh lists
                    document.getElementById("scheduledDate").value = info.dateStr + "T09:00";
                    document.getElementById("durationHours").value = 2;

                    new bootstrap.Modal(document.getElementById("event-modal")).show();
                },

                eventClick: function (info) {
                    loadModal(info.event);
                    new bootstrap.Modal(document.getElementById("event-modal")).show();
                },

                eventDrop: function (info) { updateTimes(info.event); },
                eventResize: function (info) { updateTimes(info.event); }
            });

            calendar.render();

            // ---------------------------------------
            // Modal Logic
            // ---------------------------------------

            function resetModal() {
                document.getElementById("shoot-form").reset();
                document.getElementById("psId").value = "";
                loadDropdowns();
            }

            function loadModal(ev) {
                document.getElementById("psId").value = ev.id;
                document.getElementById("title").value = ev.title;
                document.getElementById("scheduledDate").value = ev.start.toISOString().slice(0, 16);
                document.getElementById("durationHours").value = (ev.end - ev.start) / 3600000;

                let clientId = "";
                let photographerId = "";

                if (ev.extendedProps) {
                    document.getElementById("description").value = ev.extendedProps.description || "";
                    document.getElementById("location").value = ev.extendedProps.location || "";
                    document.getElementById("status").value = ev.extendedProps.status || "Scheduled";
                    document.getElementById("price").value = ev.extendedProps.price || "";
                    clientId = ev.extendedProps.clientId || "";
                    photographerId = ev.extendedProps.photographerId || "";
                    document.getElementById("notes").value = ev.extendedProps.notes || "";
                }

                loadDropdowns(clientId, photographerId);
            }

            // ---------------------------------------
            // Save Shoot (Create or Update)
            // ---------------------------------------
            document.getElementById("btn-save").onclick = function (e) {
                e.preventDefault();
                saveShoot(calendar);
            };

            function saveShoot(calendar) {
                var id = document.getElementById("psId").value;

                var dto = {
                    Id: id || 0,
                    Title: document.getElementById("title").value,
                    Description: document.getElementById("description").value,
                    ScheduledDate: document.getElementById("scheduledDate").value,
                    DurationHours: parseInt(document.getElementById("durationHours").value),
                    Location: document.getElementById("location").value,
                    Price: parseFloat(document.getElementById("price").value),
                    Notes: document.getElementById("notes").value,
                    Status: document.getElementById("status").value,
                    ClientId: parseInt(document.getElementById("clientId").value),
                    PhotographerId: document.getElementById("photographerId").value
                };

                fetch(id ? "/PhotoShoots/UpdateAjax" : "/PhotoShoots/CreateAjax", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(dto)
                }).then(() => {
                    bootstrap.Modal.getInstance(document.getElementById("event-modal")).hide();
                    calendar.refetchEvents();
                });
            }

            // ---------------------------------------
            // Delete Shoot
            // ---------------------------------------
            document.getElementById("btn-delete").onclick = function () {
                deleteShoot(calendar);
            };

            function deleteShoot(calendar) {
                var id = document.getElementById("psId").value;
                if (!id) return;

                fetch("/PhotoShoots/DeleteAjax?id=" + id, { method: "POST" })
                    .then(() => {
                        bootstrap.Modal.getInstance(document.getElementById("event-modal")).hide();
                        calendar.refetchEvents();
                    });
            }

            // ---------------------------------------
            // Drag/Resize Update
            // ---------------------------------------
            function updateTimes(ev) {
                var payload = {
                    id: ev.id,
                    start: ev.start.toISOString(),
                    end: ev.end.toISOString()
                };

                fetch("/PhotoShoots/Move", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                }).then(() => {
                    calendar.refetchEvents();
                });
            }
        });
    </script>
}
