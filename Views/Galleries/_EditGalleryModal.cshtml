@{
    ViewBag.Purpose = "Partial for galleries module.";
}

@model MyPhotoBiz.ViewModels.EditGalleryViewModel

<div class="modal fade" id="editGalleryModalElement" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form asp-action="Edit" asp-route-id="@Model.Id" method="post" id="editGalleryForm">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="Id" />
                <input type="hidden" asp-for="CreatedDate" />

                <div class="modal-header">
                    <h5 class="modal-title"><i class="ti ti-edit me-2"></i>Edit Gallery: @Model.Name</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <!-- Nav Tabs -->
                    <ul class="nav nav-tabs mb-3" id="editGalleryTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="edit-basic-info-tab" data-bs-toggle="tab" data-bs-target="#edit-basic-info" type="button" role="tab">
                                <i class="ti ti-info-circle me-1"></i>Basic Info
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="edit-watermark-tab" data-bs-toggle="tab" data-bs-target="#edit-watermark" type="button" role="tab">
                                <i class="ti ti-photo-shield me-1"></i>Watermark
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="edit-photo-selection-tab" data-bs-toggle="tab" data-bs-target="#edit-photo-selection" type="button" role="tab">
                                <i class="ti ti-photo me-1"></i>Select Photos
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Tab 1: Basic Info -->
                        <div class="tab-pane fade show active" id="edit-basic-info" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label asp-for="Name" class="form-label">Gallery Name <span class="text-danger">*</span></label>
                                    <input asp-for="Name" class="form-control">
                                    <span asp-validation-for="Name" class="text-danger small"></span>
                                </div>

                                <div class="col-md-6">
                                    <label asp-for="ExpiryDate" class="form-label">Expiry Date <span class="text-danger">*</span></label>
                                    <input asp-for="ExpiryDate" type="date" class="form-control">
                                    <span asp-validation-for="ExpiryDate" class="text-danger small"></span>
                                </div>

                                <div class="col-12">
                                    <label asp-for="Description" class="form-label">Description <span class="text-danger">*</span></label>
                                    <textarea asp-for="Description" class="form-control" rows="3"></textarea>
                                    <span asp-validation-for="Description" class="text-danger small"></span>
                                </div>

                                <div class="col-md-6">
                                    <label asp-for="BrandColor" class="form-label">Brand Color</label>
                                    <input asp-for="BrandColor" type="color" class="form-control form-control-color">
                                    <span asp-validation-for="BrandColor" class="text-danger small"></span>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label d-block">Gallery Status</label>
                                    <div class="form-check form-switch">
                                        <input asp-for="IsActive" class="form-check-input" type="checkbox">
                                        <label asp-for="IsActive" class="form-check-label">Active</label>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <i class="ti ti-info-circle me-2"></i>
                                        <strong>Client Access:</strong> Client access is managed through the gallery details page.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab 2: Watermark Settings -->
                        <div class="tab-pane fade" id="edit-watermark" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <i class="ti ti-info-circle me-2"></i>
                                        Watermarks will be applied to photos when clients download them. This helps protect your work while allowing clients to preview photos.
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input asp-for="WatermarkEnabled" class="form-check-input" type="checkbox" id="watermarkEnabledSwitch">
                                        <label asp-for="WatermarkEnabled" class="form-check-label">Enable Watermark on Downloads</label>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input asp-for="WatermarkTiled" class="form-check-input" type="checkbox">
                                        <label asp-for="WatermarkTiled" class="form-check-label">Tiled (Repeating Pattern)</label>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label asp-for="WatermarkText" class="form-label">Watermark Text</label>
                                    <input asp-for="WatermarkText" class="form-control" placeholder="e.g., PROOF or Your Studio Name">
                                    <small class="text-muted">Leave empty to use default "PROOF" text</small>
                                </div>

                                <div class="col-md-6">
                                    <label asp-for="WatermarkImagePath" class="form-label">Logo Image Path (Optional)</label>
                                    <input asp-for="WatermarkImagePath" class="form-control" placeholder="/uploads/logos/your-logo.png">
                                    <small class="text-muted">Path to logo image (overrides text watermark)</small>
                                </div>

                                <div class="col-md-6">
                                    <label asp-for="WatermarkOpacity" class="form-label">Opacity: <span id="opacityValue">@(Model.WatermarkOpacity * 100)%</span></label>
                                    <input asp-for="WatermarkOpacity" type="range" class="form-range" min="0.1" max="1" step="0.1" id="opacityRange">
                                </div>

                                <div class="col-md-6">
                                    <label asp-for="WatermarkPosition" class="form-label">Position</label>
                                    <select asp-for="WatermarkPosition" class="form-select" asp-items="Html.GetEnumSelectList<MyPhotoBiz.Services.WatermarkPosition>()">
                                    </select>
                                    <small class="text-muted">Position is ignored when tiled mode is enabled</small>
                                </div>

                                <div class="col-12">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title"><i class="ti ti-eye me-1"></i>Preview</h6>
                                            <div class="watermark-preview gallery-watermark-preview position-relative border rounded">
                                                <div id="watermarkPreviewText" class="position-absolute text-white fw-bold gallery-watermark-text">
                                                    PROOF
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab 3: Photo Selection -->
                        <div class="tab-pane fade" id="edit-photo-selection" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <input type="text" id="edit-photo-search" class="form-control" placeholder="Search photos...">
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="selectAllEditPhotos()">
                                        <i class="ti ti-check-all me-1"></i> Select All
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-outline-secondary w-100" onclick="deselectAllEditPhotos()">
                                        <i class="ti ti-x me-1"></i> Deselect All
                                    </button>
                                </div>
                            </div>

                            <!-- Album Grid -->
                            <div class="album-grid gallery-album-grid border rounded p-3">
                                @if (Model.AvailableAlbums.Any())
                                {
                                    <div class="list-group" id="edit-album-list-container">
                                        @foreach (var album in Model.AvailableAlbums)
                                        {
                                            <label class="list-group-item d-flex align-items-center cursor-pointer">
                                                <input type="checkbox" name="SelectedAlbumIds" value="@album.Id" class="form-check-input me-3" @(album.IsSelected ? "checked" : "") />
                                                <div class="flex-grow-1">
                                                    <div class="fw-bold">@album.Name</div>
                                                    @if (!string.IsNullOrEmpty(album.Description))
                                                    {
                                                        <small class="text-muted d-block">@album.Description</small>
                                                    }
                                                    <small class="text-muted">
                                                        <i class="ti ti-photo me-1"></i>@album.PhotoCount photos
                                                        @if (!string.IsNullOrEmpty(album.ClientName))
                                                        {
                                                            <span class="ms-2"><i class="ti ti-user me-1"></i>@album.ClientName</span>
                                                        }
                                                    </small>
                                                </div>
                                            </label>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="text-center text-muted py-5">
                                        <i class="ti ti-photo-off fs-1 d-block mb-2"></i>
                                        <p>No photos available.</p>
                                    </div>
                                }
                            </div>

                            <div class="mt-3">
                                <strong id="edit-selected-count">0</strong> photos selected
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="ti ti-x me-1"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="editGalleryBtn">
                        <span class="btn-text">
                            <i class="ti ti-check me-1"></i> Save Changes
                        </span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            Saving...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .photo-checkbox-label:hover .photo-overlay {
        opacity: 1 !important;
    }
    .photo-checkbox:checked + img + .photo-overlay {
        opacity: 1 !important;
        background: rgba(25, 135, 84, 0.7) !important;
    }
</style>

<script>
    function selectAllEditPhotos() {
        document.querySelectorAll('#edit-photo-grid-container .photo-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
        updateEditSelectedCount();
    }

    function deselectAllEditPhotos() {
        document.querySelectorAll('#edit-photo-grid-container .photo-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        updateEditSelectedCount();
    }

    function updateEditSelectedCount() {
        const count = document.querySelectorAll('#edit-photo-grid-container .photo-checkbox:checked').length;
        document.getElementById('edit-selected-count').textContent = count;
    }

    // Photo search
    document.getElementById('edit-photo-search')?.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('#edit-photo-grid-container .photo-item').forEach(item => {
            const title = item.getAttribute('data-photo-title').toLowerCase();
            if (title.includes(searchTerm)) {
                item.classList.remove('d-none');
            } else {
                item.classList.add('d-none');
            }
        });
    });

    // Update count on checkbox change
    document.querySelectorAll('#edit-photo-grid-container .photo-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateEditSelectedCount);
    });

    // Initialize count
    updateEditSelectedCount();

    // Watermark preview functionality
    const opacityRange = document.getElementById('opacityRange');
    const opacityValue = document.getElementById('opacityValue');
    const watermarkText = document.getElementById('WatermarkText');
    const watermarkPreview = document.getElementById('watermarkPreviewText');
    const watermarkPosition = document.getElementById('WatermarkPosition');

    function updateWatermarkPreview() {
        if (!watermarkPreview) return;

        // Update text
        const text = watermarkText?.value || 'PROOF';
        watermarkPreview.textContent = text || 'PROOF';

        // Update opacity
        const opacity = opacityRange?.value || 0.5;
        watermarkPreview.style.opacity = opacity;
        if (opacityValue) {
            opacityValue.textContent = Math.round(opacity * 100) + '%';
        }

        // Update position
        const position = watermarkPosition?.value || 'Center';
        const positionMap = {
            'TopLeft': { top: '10%', left: '10%', transform: 'translate(0, 0)' },
            'TopCenter': { top: '10%', left: '50%', transform: 'translate(-50%, 0)' },
            'TopRight': { top: '10%', left: '90%', transform: 'translate(-100%, 0)' },
            'MiddleLeft': { top: '50%', left: '10%', transform: 'translate(0, -50%)' },
            'Center': { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' },
            'MiddleRight': { top: '50%', left: '90%', transform: 'translate(-100%, -50%)' },
            'BottomLeft': { top: '90%', left: '10%', transform: 'translate(0, -100%)' },
            'BottomCenter': { top: '90%', left: '50%', transform: 'translate(-50%, -100%)' },
            'BottomRight': { top: '90%', left: '90%', transform: 'translate(-100%, -100%)' }
        };
        const pos = positionMap[position] || positionMap['Center'];
        watermarkPreview.style.top = pos.top;
        watermarkPreview.style.left = pos.left;
        watermarkPreview.style.transform = pos.transform;
    }

    opacityRange?.addEventListener('input', updateWatermarkPreview);
    watermarkText?.addEventListener('input', updateWatermarkPreview);
    watermarkPosition?.addEventListener('change', updateWatermarkPreview);

    // Initialize preview
    updateWatermarkPreview();
</script>
