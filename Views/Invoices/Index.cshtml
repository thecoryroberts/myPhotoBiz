@using MyPhotoBiz.Enums
@using MyPhotoBiz.Models
@using MyPhotoBiz.ViewModels
@model IEnumerable<InvoiceViewModel>

@{
    ViewBag.Title = "Invoices";
    ViewBag.PageTitle = "Invoice Management";
    ViewBag.Icon = "ti-file-invoice";
    ViewBag.Color = "danger";
}

<div class="container-fluid">
    <partial name="Partials/_PageTitle" />

    <div class="row">
        <div class="col-12">
            <div data-table data-table-rows-per-page="10" class="card">
                <div class="card-header border-light justify-content-between">
                    <div class="d-flex gap-2">
                        <div class="app-search">
                            <input data-table-search type="text" class="form-control" placeholder="Search invoices...">
                            <i data-lucide="search" class="app-search-icon text-muted"></i>
                        </div>
                        <button data-table-delete-selected class="btn btn-danger d-none">Delete</button>
                        <a asp-action="Create" class="btn btn-purple rounded-circle btn-icon">
                            <i class="ti ti-plus fs-lg"></i>
                        </a>
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        <span class="me-2 fw-semibold">Filter By:</span>
                        <div class="app-search">
                            <select data-table-filter="Status" class="form-select form-control my-1 my-md-0">
                                <option value="">All Status</option>
                                <option value="Paid">Paid</option>
                                <option value="Pending">Pending</option>
                                <option value="Overdue">Overdue</option>
                                <option value="Draft">Draft</option>
                            </select>
                            <i data-lucide="check-circle" class="app-search-icon text-muted"></i>
                        </div>
                        <div>
                            <select data-table-set-rows-per-page class="form-select form-control my-1 my-md-0">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                    </div>
                </div>

                @if (!Model.Any())
                {
                    <!-- Empty State -->
                    <div class="card-body text-center py-5">
                        <div class="empty-state">
                            <div class="empty-state-icon bg-danger-subtle rounded-circle mx-auto mb-4" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;">
                                <i class="ti ti-file-invoice fs-1 text-danger"></i>
                            </div>
                            <h4 class="mb-2">No invoices yet</h4>
                            <p class="text-muted mb-4">Create your first invoice to start tracking payments and managing your photography business finances.</p>
                            <a asp-action="Create" class="btn btn-danger">
                                <i class="ti ti-plus me-1"></i> Create Your First Invoice
                            </a>
                        </div>
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-custom table-centered table-select table-hover w-100 mb-0">
                            <thead class="bg-light align-middle bg-opacity-25 thead-sm">
                                <tr class="text-uppercase fs-xxs">
                                    <th class="ps-3 th-checkbox">
                                        <input data-table-select-all type="checkbox"
                                            class="form-check-input form-check-input-light fs-14 mt-0">
                                    </th>
                                    <th>Invoice #</th>
                                    <th>Client</th>
                                    <th>Date</th>
                                    <th>Due Date</th>
                                    <th>Amount</th>
                                    <th data-table-filter-column="Status">Status</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var invoice in Model)
                                {
                                    <tr>
                                        <td class="ps-3">
                                            <input type="checkbox"
                                                class="form-check-input form-check-input-light fs-14 file-item-check mt-0">
                                        </td>
                                        <td>
                                            <h5 class="m-0">
                                                <span class="ti ti-file-invoice text-primary fs-lg"></span>
                                                <a asp-action="Details" asp-route-id="@invoice.Id"
                                                    class="link-reset fw-semibold">
                                                    @invoice.InvoiceNumber
                                                </a>
                                            </h5>
                                        </td>
                                        <td>
                                            @invoice.ClientName
                                            <div class="text-muted fs-xs">@invoice.ClientEmail</div>
                                        </td>
                                        <td>@invoice.InvoiceDate.ToString("MMM dd, yyyy")</td>
                                        <td>@invoice.DueDate.ToString("MMM dd, yyyy")</td>
                                        <td>$@invoice.TotalAmount.ToString("N2")</td>
                                        <td data-filter-value="@invoice.Status">
                                            <span class="badge
                                                    @(invoice.Status == InvoiceStatus.Paid ? "bg-success-subtle text-success" :
                                                                                                invoice.Status == InvoiceStatus.Pending ? "bg-warning-subtle text-warning" :
                                                                                                invoice.Status == InvoiceStatus.Overdue ? "bg-danger-subtle text-danger" :
                                                                                                "bg-info-subtle text-info") badge-label">
                                                @invoice.Status
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center justify-content-center gap-1">
                                                <a asp-action="Details" asp-route-id="@invoice.Id"
                                                    class="btn btn-light btn-icon btn-sm rounded-circle" title="View Details">
                                                    <i class="ti ti-eye fs-lg"></i>
                                                </a>
                                                @if (invoice.Status != InvoiceStatus.Paid)
                                                {
                                                    <form asp-action="MarkAsPaid" asp-route-id="@invoice.Id" method="post"
                                                        class="d-inline mark-paid-form">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="btn btn-light btn-icon btn-sm rounded-circle"
                                                            title="Mark as Paid">
                                                            <i class="ti ti-check fs-lg"></i>
                                                        </button>
                                                    </form>
                                                }
                                                <a asp-action="Edit" asp-route-id="@invoice.Id"
                                                    class="btn btn-light btn-icon btn-sm rounded-circle" title="Edit">
                                                    <i class="ti ti-edit fs-lg"></i>
                                                </a>
                                                <a asp-action="Delete" asp-route-id="@invoice.Id"
                                                    class="btn btn-light btn-icon btn-sm rounded-circle delete-invoice"
                                                    title="Delete" data-invoice-number="@invoice.InvoiceNumber">
                                                    <i class="ti ti-trash fs-lg"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="card-footer border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div data-table-pagination-info="invoices"></div>
                            <div data-table-pagination></div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script src="~/js/pages/custom-table.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Handle delete confirmation
            document.querySelectorAll('.delete-invoice').forEach(function (link) {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    var invoiceNumber = this.getAttribute('data-invoice-number');
                    var href = this.href;

                    confirmDelete('Invoice ' + invoiceNumber, function() {
                        window.location.href = href;
                    });
                });
            });

            // Handle mark as paid forms
            document.querySelectorAll('.mark-paid-form').forEach(function (form) {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    var formEl = this;

                    confirmAction({
                        title: 'Mark as Paid?',
                        text: 'This will update the invoice status to Paid.',
                        icon: 'question',
                        confirmButtonText: 'Yes, mark as paid',
                        confirmButtonColor: '#28a745'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            formEl.submit();
                        }
                    });
                });
            });
        });
    </script>
}