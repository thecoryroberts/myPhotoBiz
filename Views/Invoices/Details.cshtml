@model MyPhotoBiz.ViewModels.InvoiceViewModel
@{
    ViewBag.Title = Model.InvoiceNumber;
    ViewBag.PageTitle = "Invoice Details";
    ViewBag.SubTitle = "Invoices";
    ViewBag.SubTitleUrl = Url.Action("Index", "Invoices");
    ViewBag.Icon = "ti-file-invoice";
    ViewBag.Color = "danger";
    ViewBag.BackUrl = Url.Action("Index", "Invoices");
    ViewBag.Purpose = $"{Model.ClientName}'s invoice details.";
}

<div class="container-fluid">
    <partial name="Partials/_PageTitle" />

    <div class="row justify-content-center">
        <div class="col-xxl-10">
            <div class="row">
                <div class="col-xl-8">
                    <!-- Invoice Header Card -->
                    <div class="card mb-3">
                        <div class="card-header border-light d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="card-title mb-1">Invoice @Model.InvoiceNumber</h4>
                                <p class="text-muted mb-0">
                                    <i class="ti ti-user me-1"></i>@Model.ClientName
                                </p>
                            </div>
                            <div>
                                @{
                                    var statusBadge = Model.Status.ToString() switch
                                    {
                                        "Paid" => "bg-success-subtle text-success",
                                        "Overdue" => "bg-danger-subtle text-danger",
                                        "Pending" => "bg-warning-subtle text-warning",
                                        "Draft" => "bg-secondary-subtle text-secondary",
                                        "Cancelled" => "bg-dark-subtle text-dark",
                                        _ => "bg-info-subtle text-info"
                                    };
                                }
                                <span class="badge @statusBadge fs-6">@Model.Status</span>
                            </div>
                        </div>

                        <div class="card-body">
                            <!-- Invoice Info -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label text-muted fw-semibold mb-1">Invoice Date</label>
                                        <p class="mb-0">
                                            <i class="ti ti-calendar me-2"></i>@Model.InvoiceDate.ToString("MMM dd, yyyy")
                                        </p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label text-muted fw-semibold mb-1">Due Date</label>
                                        <p class="mb-0">
                                            <i class="ti ti-calendar-due me-2"></i>@Model.DueDate.ToString("MMM dd, yyyy")
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <!-- Invoice Items -->
                            <h5 class="mb-3">
                                <i class="ti ti-list me-2"></i>Items
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light bg-opacity-25">
                                        <tr class="text-uppercase fs-xxs">
                                            <th class="th-narrow">#</th>
                                            <th>Description</th>
                                            <th class="text-center th-small">Qty</th>
                                            <th class="text-end th-medium">Unit Price</th>
                                            <th class="text-end th-medium">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (Model.InvoiceItems != null && Model.InvoiceItems.Any())
                                        {
                                            for (int i = 0; i < Model.InvoiceItems.Count; i++)
                                            {
                                                var it = Model.InvoiceItems[i];
                                                <tr>
                                                    <td class="text-muted">@(i + 1)</td>
                                                    <td>
                                                        <strong>@it.Description</strong>
                                                    </td>
                                                    <td class="text-center">@it.Quantity</td>
                                                    <td class="text-end">@it.UnitPrice.ToString("C")</td>
                                                    <td class="text-end">
                                                        <strong>@((it.Quantity * it.UnitPrice).ToString("C"))</strong>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="5" class="text-center py-4">
                                                    <div class="text-muted">
                                                        <i class="ti ti-clipboard-off fs-2 mb-2 d-block"></i>
                                                        No items added to this invoice
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <!-- Totals -->
                            <div class="row justify-content-end mt-4 pt-3 border-top">
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">Subtotal:</span>
                                        <span class="fw-semibold">@Model.Amount.ToString("C")</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">Tax:</span>
                                        <span class="fw-semibold">@Model.Tax.ToString("C")</span>
                                    </div>
                                    <hr class="my-2">
                                    <div class="d-flex justify-content-between">
                                        <h5 class="mb-0">Total Amount:</h5>
                                        <h4 class="mb-0 text-primary">@Model.TotalAmount.ToString("C")</h4>
                                    </div>
                                </div>
                            </div>

                            <!-- Notes -->
                            @if (!string.IsNullOrEmpty(Model.Notes))
                            {
                                <div class="mt-4 pt-4 border-top">
                                    <h6 class="text-muted text-uppercase mb-2">
                                        <i class="ti ti-notes me-2"></i>Notes
                                    </h6>
                                    <div class="bg-light p-3 rounded">
                                        <p class="mb-0">@Model.Notes</p>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Sidebar Actions -->
                <div class="col-xl-4">
                    <div class="card d-print-none">
                        <div class="card-header border-light">
                            <h5 class="card-title mb-0">Actions</h5>
                        </div>
                        <div class="card-body d-flex flex-column gap-2">
                            <a asp-action="Preview" asp-route-invoiceNumber="@Model.InvoiceNumber" target="_blank" class="btn btn-primary">
                                <i class="ti ti-eye me-2"></i>Preview PDF
                            </a>
                            <a asp-action="Download" asp-route-id="@Model.InvoiceNumber" class="btn btn-success">
                                <i class="ti ti-download me-2"></i>Download PDF
                            </a>
                            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-light">
                                <i class="ti ti-edit me-2"></i>Edit Invoice
                            </a>
                            <hr class="my-2">
                            <a asp-action="Index" class="btn btn-light">
                                <i class="ti ti-arrow-left me-2"></i>Back to List
                            </a>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="card mt-3 d-print-none">
                        <div class="card-header border-light">
                            <h5 class="card-title mb-0">Invoice Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="avatar avatar-sm bg-primary-subtle flex-shrink-0">
                                    <span class="avatar-title text-primary rounded-circle">
                                        <i class="ti ti-file-invoice"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="small text-muted">Invoice Number</div>
                                    <div class="fw-semibold">@Model.InvoiceNumber</div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center mb-3">
                                <div class="avatar avatar-sm bg-success-subtle flex-shrink-0">
                                    <span class="avatar-title text-success rounded-circle">
                                        <i class="ti ti-list"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="small text-muted">Total Items</div>
                                    <div class="fw-semibold">@(Model.InvoiceItems?.Count ?? 0)</div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="avatar avatar-sm bg-info-subtle flex-shrink-0">
                                    <span class="avatar-title text-info rounded-circle">
                                        <i class="ti ti-calendar"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="small text-muted">Days Until Due</div>
                                    <div class="fw-semibold">
                                        @{
                                            var daysRemaining = (Model.DueDate - DateTime.Now).Days;
                                            var daysText = daysRemaining > 0 ? $"{daysRemaining} days" : daysRemaining == 0 ? "Due today" : "Overdue";
                                            var daysClass = daysRemaining > 7 ? "text-success" : daysRemaining >= 0 ? "text-warning" : "text-danger";
                                        }
                                        <span class="@daysClass">@daysText</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pay section -->
<div class="container-fluid d-print-none" id="pay">
    <div class="row justify-content-center mt-4">
        <div class="col-xxl-10">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0"><i class="ti ti-credit-card me-2"></i>Pay Invoice</h5>
                        <small class="text-muted">Securely pay the total balance using your card.</small>
                    </div>
                    <span class="badge bg-primary">@Model.TotalAmount.ToString("C")</span>
                </div>
                <div class="card-body">
                    @if (Model.Status == MyPhotoBiz.Enums.InvoiceStatus.Paid)
                    {
                        <div class="alert alert-success d-flex align-items-start mb-0">
                            <i class="ti ti-check me-2 mt-1"></i>
                            <div>
                                <strong>This invoice is already paid.</strong>
                                @if (Model.PaidDate.HasValue)
                                {
                                    <div>Paid on @Model.PaidDate.Value.ToString("MMM dd, yyyy")</div>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        @Html.AntiForgeryToken()
                        <div id="paymentAlerts"></div>
                        <div class="mb-3">
                            <label class="form-label">Card details</label>
                            <div id="card-element" class="form-control"></div>
                        </div>
                        <button id="payButton" class="btn btn-primary" type="button" data-invoice-id="@Model.Id">
                            <i class="ti ti-credit-card"></i> Pay @Model.TotalAmount.ToString("C")
                        </button>
                        <small class="text-muted d-block mt-2">Payment is processed by Stripe. Your card details are never stored on our servers.</small>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        (function() {
            const payBtn = document.getElementById('payButton');
            if (!payBtn) return;

            const invoiceId = payBtn.dataset.invoiceId;
            const alerts = document.getElementById('paymentAlerts');
            let stripe, card;

            function showAlert(type, message) {
                alerts.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            }

            async function initStripe() {
                payBtn.disabled = true;
                payBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Preparing payment...';
                try {
                    const formData = new FormData();
                    formData.append('__RequestVerificationToken', document.querySelector('input[name=\"__RequestVerificationToken\"]')?.value ?? '');

                    const response = await fetch(`/Invoices/Pay/${invoiceId}`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const err = await response.json().catch(() => ({}));
                        throw new Error(err.message || 'Unable to start payment.');
                    }

                    const data = await response.json();
                    stripe = Stripe(data.publishableKey);
                    const elements = stripe.elements();
                    card = elements.create('card', { hidePostalCode: true });
                    card.mount('#card-element');
                    payBtn.disabled = false;
                    payBtn.innerHTML = `<i class="ti ti-credit-card"></i> Pay ${new Intl.NumberFormat(undefined, { style: 'currency', currency: data.currency.toUpperCase() }).format(data.amount / 100)}`;

                    payBtn.onclick = () => pay(data.clientSecret);
                } catch (err) {
                    showAlert('danger', err.message || 'Payment could not be initialized.');
                    payBtn.disabled = true;
                    payBtn.innerHTML = '<i class="ti ti-ban"></i> Payment unavailable';
                }
            }

            async function pay(clientSecret) {
                payBtn.disabled = true;
                payBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
                const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: { card }
                });

                if (error) {
                    showAlert('danger', error.message);
                    payBtn.disabled = false;
                    payBtn.innerHTML = '<i class="ti ti-credit-card"></i> Try again';
                    return;
                }

                if (paymentIntent && paymentIntent.status === 'succeeded') {
                    showAlert('success', 'Payment received! Refreshing...');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showAlert('warning', 'Payment did not complete. Please try again.');
                    payBtn.disabled = false;
                    payBtn.innerHTML = '<i class="ti ti-credit-card"></i> Try again';
                }
            }

            initStripe();
        })();
    </script>
}
