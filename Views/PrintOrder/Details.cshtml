@using MyPhotoBiz.Enums
@using MyPhotoBiz.Models
@model PrintOrder

@{
    ViewBag.Title = "Order Details";
    ViewBag.PageTitle = $"Order {Model.OrderNumber}";
    ViewBag.Purpose = "View print order details.";
    ViewBag.Icon = "ti-printer";
    ViewBag.Color = "info";

    var shippingCost = (decimal)(ViewBag.ShippingCost ?? 5.00m);
    var subtotal = Model.Items.Sum(i => i.UnitPrice * i.Quantity);

    var statusClass = Model.Status switch
    {
        OrderStatus.Pending => "bg-warning text-dark",
        OrderStatus.Processing => "bg-info text-white",
        OrderStatus.Shipped => "bg-primary text-white",
        OrderStatus.Delivered => "bg-success text-white",
        OrderStatus.Cancelled => "bg-danger text-white",
        _ => "bg-secondary text-white"
    };
}

<div class="container-fluid">
    <partial name="Partials/_PageTitle" />

    <div class="row">
        <!-- Order Information -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="ti ti-file-invoice me-2"></i>Order Information
                    </h5>
                    <span class="badge @statusClass fs-sm">@Model.Status</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Order Number:</strong> @Model.OrderNumber</p>
                            <p class="mb-2"><strong>Order Date:</strong> @Model.CreatedDate.ToString("MMM dd, yyyy HH:mm")</p>
                            <p class="mb-2"><strong>Gallery:</strong> @(Model.Session?.Gallery?.Name ?? "N/A")</p>
                        </div>
                        <div class="col-md-6">
                            @if (Model.PaidDate.HasValue)
                            {
                                <p class="mb-2"><strong>Paid:</strong> @Model.PaidDate.Value.ToString("MMM dd, yyyy HH:mm")</p>
                            }
                            @if (Model.ShippedDate.HasValue)
                            {
                                <p class="mb-2"><strong>Shipped:</strong> @Model.ShippedDate.Value.ToString("MMM dd, yyyy HH:mm")</p>
                            }
                            @if (Model.DeliveredDate.HasValue)
                            {
                                <p class="mb-2"><strong>Delivered:</strong> @Model.DeliveredDate.Value.ToString("MMM dd, yyyy HH:mm")</p>
                            }
                            @if (Model.CancelledDate.HasValue)
                            {
                                <p class="mb-2 text-danger"><strong>Cancelled:</strong> @Model.CancelledDate.Value.ToString("MMM dd, yyyy HH:mm")</p>
                            }
                            @if (Model.RefundedDate.HasValue)
                            {
                                <p class="mb-2 text-danger"><strong>Refunded:</strong> @Model.RefundedDate.Value.ToString("MMM dd, yyyy HH:mm")</p>
                            }
                            @if (!string.IsNullOrEmpty(Model.PrintLabOrderId))
                            {
                                <p class="mb-2"><strong>Lab Order ID:</strong> @Model.PrintLabOrderId</p>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Items -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="ti ti-photo me-2"></i>Order Items (@Model.Items.Count)
                    </h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th style="width: 80px;">Photo</th>
                                <th>Title</th>
                                <th>Size</th>
                                <th>Finish</th>
                                <th class="text-center">Qty</th>
                                <th class="text-end">Price</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Items)
                            {
                                <tr>
                                    <td>
                                        @if (item.Photo != null && !string.IsNullOrEmpty(item.Photo.ThumbnailPath))
                                        {
                                            <img src="@Url.Action("Thumbnail", "Photos", new { id = item.PhotoId })"
                                                 alt="@item.Photo.Title" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;">
                                        }
                                        else
                                        {
                                            <div class="bg-light d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                                <i class="ti ti-photo text-muted"></i>
                                            </div>
                                        }
                                    </td>
                                    <td class="align-middle">@(item.Photo?.Title ?? "Unknown")</td>
                                    <td class="align-middle">@item.Size</td>
                                    <td class="align-middle">@item.FinishType</td>
                                    <td class="align-middle text-center">@item.Quantity</td>
                                    <td class="align-middle text-end">$@item.UnitPrice.ToString("N2")</td>
                                    <td class="align-middle text-end fw-semibold">$@((item.UnitPrice * item.Quantity).ToString("N2"))</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="border-top">
                            <tr>
                                <td colspan="6" class="text-end">Subtotal:</td>
                                <td class="text-end">$@subtotal.ToString("N2")</td>
                            </tr>
                            <tr>
                                <td colspan="6" class="text-end">Shipping:</td>
                                <td class="text-end">$@shippingCost.ToString("N2")</td>
                            </tr>
                            <tr class="fw-bold">
                                <td colspan="6" class="text-end">Total:</td>
                                <td class="text-end fs-5">$@Model.TotalPrice.ToString("N2")</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Customer Info -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="ti ti-user me-2"></i>Customer Information
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>Name:</strong> @Model.ClientName</p>
                    <p class="mb-2">
                        <strong>Email:</strong>
                        <a href="mailto:@Model.ClientEmail">@Model.ClientEmail</a>
                    </p>
                    @if (!string.IsNullOrEmpty(Model.ClientPhone))
                    {
                        <p class="mb-2">
                            <strong>Phone:</strong>
                            <a href="tel:@Model.ClientPhone">@Model.ClientPhone</a>
                        </p>
                    }
                </div>
            </div>

            <!-- Payment Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="ti ti-credit-card me-2"></i>Payment Status
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.RefundedDate.HasValue)
                    {
                        <div class="alert alert-danger mb-0">
                            <i class="ti ti-alert-circle me-2"></i>
                            Order refunded on @Model.RefundedDate.Value.ToString("MMM dd, yyyy")
                        </div>
                    }
                    else if (Model.PaidDate.HasValue)
                    {
                        <div class="alert alert-success mb-0">
                            <i class="ti ti-check me-2"></i>
                            Paid on @Model.PaidDate.Value.ToString("MMM dd, yyyy")
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="ti ti-clock me-2"></i>
                            Awaiting payment
                        </div>
                    }
                </div>
            </div>

            <!-- Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="ti ti-settings me-2"></i>Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        @if (Model.Status == OrderStatus.Pending)
                        {
                            <form asp-action="Process" asp-route-id="@Model.Id" method="post">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-info w-100">
                                    <i class="ti ti-package me-2"></i>Process Order
                                </button>
                            </form>
                        }
                        @if (Model.Status == OrderStatus.Processing)
                        {
                            <form asp-action="Ship" asp-route-id="@Model.Id" method="post">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="ti ti-truck-delivery me-2"></i>Mark as Shipped
                                </button>
                            </form>
                        }
                        @if (Model.Status == OrderStatus.Shipped)
                        {
                            <form asp-action="Deliver" asp-route-id="@Model.Id" method="post">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="ti ti-check me-2"></i>Mark as Delivered
                                </button>
                            </form>
                        }
                        @if (!Model.PaidDate.HasValue && Model.Status != OrderStatus.Cancelled)
                        {
                            <form asp-action="MarkPaid" asp-route-id="@Model.Id" method="post">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="ti ti-currency-dollar me-2"></i>Mark as Paid
                                </button>
                            </form>
                        }
                        @if (Model.Status != OrderStatus.Cancelled && Model.Status != OrderStatus.Shipped && Model.Status != OrderStatus.Delivered)
                        {
                            <button type="button" class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#cancelModal">
                                <i class="ti ti-x me-2"></i>Cancel Order
                            </button>
                        }
                        @if (Model.PaidDate.HasValue && !Model.RefundedDate.HasValue)
                        {
                            <form asp-action="Refund" asp-route-id="@Model.Id" method="post" id="refundForm">
                                @Html.AntiForgeryToken()
                                <button type="button" class="btn btn-outline-danger w-100" onclick="confirmRefund()">
                                    <i class="ti ti-receipt-refund me-2"></i>Issue Refund
                                </button>
                            </form>
                        }
                    </div>
                </div>
            </div>

            <a asp-action="Index" class="btn btn-light w-100">
                <i class="ti ti-arrow-left me-2"></i>Back to Orders
            </a>
        </div>
    </div>
</div>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="Cancel" asp-route-id="@Model.Id" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title">Cancel Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to cancel order <strong>@Model.OrderNumber</strong>?</p>
                    <div class="mb-3">
                        <label for="reason" class="form-label">Reason for cancellation</label>
                        <textarea class="form-control" id="reason" name="reason" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-danger">Cancel Order</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section scripts
{
    <script>
        function confirmRefund() {
            confirmAction({
                title: 'Issue Refund?',
                text: 'This will mark the order as refunded and cancelled. This action cannot be undone.',
                icon: 'warning',
                confirmButtonText: 'Yes, issue refund',
                confirmButtonColor: '#dc3545'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('refundForm').submit();
                }
            });
        }
    </script>
}
