@model MyPhotoBiz.ViewModels.FileManagerViewModel
@{
    ViewBag.Title = "File Manager";
    ViewBag.PageTitle = "File Manager";
    ViewBag.Icon = "ti-folders";
    ViewBag.Color = "secondary";
    ViewBag.Purpose = "List and manage files.";
}

<!-- Display Success/Error Messages -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="ti ti-check-circle me-2"></i>@TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="ti ti-alert-circle me-2"></i>@TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="container-fluid">
    <partial name="Partials/_PageTitle" />

    <div class="row">
        <!-- Left Sidebar -->
        <div class="col-xl-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-grid mb-3">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#uploadModal">
                            <i class="ti ti-upload me-2"></i>Upload Files
                        </button>
                    </div>

                    <div class="d-grid mb-3">
                        <button type="button" class="btn btn-secondary" data-bs-toggle="modal"
                            data-bs-target="#createFolderModal">
                            <i class="ti ti-folder-plus me-2"></i>New Folder
                        </button>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-uppercase fw-semibold text-muted fs-sm mb-3">Quick Access</h6>
                        <div class="list-group list-group-flush">
                            <a href="@Url.Action("Index")"
                                class="list-group-item list-group-item-action @(string.IsNullOrEmpty(Model.FilterType) && !Model.CurrentFolderId.HasValue ? "active" : "")">
                                <i class="ti ti-folder me-2"></i>All Files
                                <span
                                    class="badge bg-secondary-subtle text-secondary float-end">@Model.Files.Count()</span>
                            </a>
                            <a href="@Url.Action("Index", new { filterType = "Favorites" })"
                                class="list-group-item list-group-item-action @(Model.FilterType == "Favorites" ? "active" : "")">
                                <i class="ti ti-star me-2"></i>Favorites
                            </a>
                            <a href="@Url.Action("Index", new { filterType = "Recent" })"
                                class="list-group-item list-group-item-action @(Model.FilterType == "Recent" ? "active" : "")">
                                <i class="ti ti-clock me-2"></i>Recent Files
                            </a>
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-uppercase fw-semibold text-muted fs-sm mb-3">Categories</h6>
                        <div class="list-group list-group-flush">
                            <a href="@Url.Action("Index", new { filterType = "Images" })"
                                class="list-group-item list-group-item-action @(Model.FilterType == "Images" ? "active" : "")">
                                <i class="ti ti-photo me-2"></i>Images
                                <span class="badge bg-info-subtle text-info float-end">@Model.Files.Count(f => f.Type ==
                                                                        "JPG" || f.Type == "PNG" || f.Type == "JPEG")</span>
                            </a>
                            <a href="@Url.Action("Index", new { filterType = "Documents" })"
                                class="list-group-item list-group-item-action @(Model.FilterType == "Documents" ? "active" : "")">
                                <i class="ti ti-file-text me-2"></i>Documents
                                <span class="badge bg-primary-subtle text-primary float-end">@Model.Files.Count(f =>
                                                                        f.Type == "DOC" || f.Type == "DOCX" || f.Type == "PDF")</span>
                            </a>
                            <a href="@Url.Action("Index", new { filterType = "Videos" })"
                                class="list-group-item list-group-item-action @(Model.FilterType == "Videos" ? "active" : "")">
                                <i class="ti ti-video me-2"></i>Videos
                                <span class="badge bg-warning-subtle text-warning float-end">@Model.Files.Count(f =>
                                                                        f.Type == "MP4" || f.Type == "AVI")</span>
                            </a>
                            <a href="@Url.Action("Index", new { filterType = "Archives" })"
                                class="list-group-item list-group-item-action @(Model.FilterType == "Archives" ? "active" : "")">
                                <i class="ti ti-file-zip me-2"></i>Archives
                                <span class="badge bg-secondary-subtle text-secondary float-end">@Model.Files.Count(f =>
                                                                        f.Type == "ZIP" || f.Type == "RAR")</span>
                            </a>
                        </div>
                    </div>

                    <div>
                        <h6 class="text-uppercase fw-semibold text-muted fs-sm mb-3">Storage</h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">@FormatFileSize(Model.Files.Sum(f => f.Size)) used</span>
                            <span class="text-muted">of 10 GB</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            @{
                                var totalUsed = Model.Files.Sum(f => f.Size);
                                var totalAvailable = 10L * 1024 * 1024 * 1024; // 10 GB
                                var usedPercentage = (double)totalUsed / totalAvailable * 100;
                            }
                            <div class="progress-bar bg-success" role="progressbar"
                                style="width: @usedPercentage.ToString("F2")%" aria-valuenow="@usedPercentage"
                                aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-xl-9">
            <div class="card">
                <div class="card-header border-light d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div class="d-flex gap-2 flex-wrap">
                        <div class="app-search">
                            <input type="text" id="searchInput" class="form-control" placeholder="Search files...">
                            <i data-lucide="search" class="app-search-icon text-muted"></i>
                        </div>

                        <select id="filterType" class="form-select w-auto">
                            <option value="">All Types</option>
                            @{
                                var types = new[] { "PDF", "JPG", "PNG", "DOC", "DOCX", "XLS", "XLSX", "MP4", "ZIP" };
                                foreach (var type in types)
                                {
                                    if (Model.FilterType == type)
                                    {
                                        <option value="@type" selected>@type</option>
                                    }
                                    else
                                    {
                                        <option value="@type">@type</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        <span>
                            <div class="btn-group" role="group" aria-label="View toggle">
                                <button type="button" class="btn btn-light btn-sm" id="gridViewBtn" title="Grid View">
                                    <i class="ti ti-layout-grid"></i>
                                </button>
                                <button type="button" class="btn btn-light btn-sm active" id="listViewBtn"
                                    title="List View">
                                    <i class="ti ti-list"></i>
                                </button>
                            </div>
                        </span>
                    </div>
                </div>

                <!-- Breadcrumb Navigation -->
                @if (Model.Breadcrumbs.Any() || Model.CurrentFolderId.HasValue)
                {
                    <div class="card-body border-bottom py-2">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item">
                                    <a href="@Url.Action("Index")"><i class="ti ti-home me-1"></i>Home</a>
                                </li>
                                @foreach (var folder in Model.Breadcrumbs)
                                {
                                    <li class="breadcrumb-item">
                                        <a href="@Url.Action("Index", new { folderId = folder.Id })">
                                            <i class="ti ti-folder me-1"></i>@folder.Name
                                        </a>
                                    </li>
                                }
                            </ol>
                        </nav>
                    </div>
                }

                <div class="card-body">
                    @if (Model.Files.Any())
                    {
                        <!-- List View (Table) -->
                        <div id="listView" class="table-responsive">
                            <table class="table table-hover table-centered mb-0">
                                <thead class="bg-light bg-opacity-25">
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Size</th>
                                        <th>Modified</th>
                                        <th>Owner</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="filesTable">
                                    @foreach (var file in Model.Files)
                                    {
                                        <tr data-file-name="@file.Name.ToLower()" data-file-type="@file.Type"
                                            data-is-folder="@file.IsFolder.ToString().ToLower()">
                                            <td>
                                                <div class="d-flex align-items-center gap-2">
                                                    <div class="avatar avatar-sm bg-light rounded">
                                                        <span class="avatar-title">
                                                            @if (file.IsFolder)
                                                            {
                                                                <i class="ti ti-folder text-warning fs-lg"></i>
                                                            }
                                                            else if (file.Type == "PDF")
                                                            {
                                                                <i class="ti ti-file-type-pdf text-danger fs-lg"></i>
                                                            }
                                                            else if (file.Type == "JPG" || file.Type == "PNG" || file.Type ==
                                                            "JPEG")
                                                            {
                                                                <i class="ti ti-photo text-info fs-lg"></i>
                                                            }
                                                            else if (file.Type == "DOC" || file.Type == "DOCX")
                                                            {
                                                                <i class="ti ti-file-text text-primary fs-lg"></i>
                                                            }
                                                            else if (file.Type == "XLS" || file.Type == "XLSX")
                                                            {
                                                                <i class="ti ti-file-spreadsheet text-success fs-lg"></i>
                                                            }
                                                            else if (file.Type == "MP4" || file.Type == "AVI")
                                                            {
                                                                <i class="ti ti-video text-warning fs-lg"></i>
                                                            }
                                                            else if (file.Type == "ZIP" || file.Type == "RAR")
                                                            {
                                                                <i class="ti ti-file-zip text-secondary fs-lg"></i>
                                                            }
                                                            else
                                                            {
                                                                <i class="ti ti-file text-muted fs-lg"></i>
                                                            }
                                                        </span>
                                                    </div>
                                                    <div>
                                                        @if (file.IsFolder)
                                                        {
                                                            <h6 class="mb-0">
                                                                <a href="@Url.Action("Index", new { folderId = file.Id })"
                                                                    class="link-reset fw-semibold">
                                                                    @file.Name
                                                                </a>
                                                            </h6>
                                                        }
                                                        else
                                                        {
                                                            <h6 class="mb-0">@file.Name</h6>
                                                        }
                                                    </div>
                                                </div>
                                            </td>
                                            <td><span class="badge bg-secondary-subtle text-secondary">@file.Type</span></td>
                                            <td>@(file.IsFolder ? "--" : FormatFileSize(file.Size))</td>
                                            <td>@file.Modified.ToString("MMM dd, yyyy HH:mm")</td>
                                            <td>@file.Owner</td>
                                            <td class="text-end">
                                                <div class="d-flex gap-1 justify-content-end">
                                                    @if (!file.IsFolder)
                                                    {
                                                        <button type="button" class="btn btn-light btn-sm btn-icon favorite-btn"
                                                            data-file-id="@file.Id"
                                                            title="@(file.IsFavorite ? "Remove from favorites" : "Add to favorites")">
                                                            <i
                                                                class="ti ti-star@(file.IsFavorite ? "-filled text-warning" : "")"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-light btn-sm btn-icon"
                                                            onclick="showMetadataModal(@file.Id)" title="File Info">
                                                            <i class="ti ti-info-circle"></i>
                                                        </button>
                                                        <a asp-action="Download" asp-route-id="@file.Id"
                                                            class="btn btn-light btn-sm btn-icon" title="Download">
                                                            <i class="ti ti-download"></i>
                                                        </a>
                                                    }
                                                    <button type="button" class="btn btn-light btn-sm btn-icon"
                                                        onclick="showDeleteModal(@file.Id, @Html.Raw(Json.Serialize(file.Name)))" title="Delete">
                                                        <i class="ti ti-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- Grid View -->
                        <div id="gridView" class="row g-3" style="display: none;">
                            @foreach (var file in Model.Files)
                            {
                                <div class="col-xxl-2 col-xl-3 col-lg-4 col-md-6 file-card"
                                    data-file-name="@file.Name.ToLower()" data-file-type="@file.Type"
                                    data-is-folder="@file.IsFolder.ToString().ToLower()">
                                    <div class="card border h-100">
                                        <div class="card-body text-center">
                                            @if (file.IsFavorite && !file.IsFolder)
                                            {
                                                <div class="position-absolute top-0 end-0 p-2">
                                                    <i class="ti ti-star-filled text-warning"></i>
                                                </div>
                                            }
                                            <div class="avatar avatar-xl bg-light rounded mx-auto mb-3">
                                                <span class="avatar-title">
                                                    @if (file.IsFolder)
                                                    {
                                                        <i class="ti ti-folder text-warning" style="font-size: 2.5rem;"></i>
                                                    }
                                                    else if (file.Type == "PDF")
                                                    {
                                                        <i class="ti ti-file-type-pdf text-danger" style="font-size: 2.5rem;"></i>
                                                    }
                                                    else if (file.Type == "JPG" || file.Type == "PNG" || file.Type == "JPEG")
                                                    {
                                                        <i class="ti ti-photo text-info" style="font-size: 2.5rem;"></i>
                                                    }
                                                    else if (file.Type == "DOC" || file.Type == "DOCX")
                                                    {
                                                        <i class="ti ti-file-text text-primary" style="font-size: 2.5rem;"></i>
                                                    }
                                                    else if (file.Type == "XLS" || file.Type == "XLSX")
                                                    {
                                                        <i class="ti ti-file-spreadsheet text-success"
                                                            style="font-size: 2.5rem;"></i>
                                                    }
                                                    else if (file.Type == "MP4" || file.Type == "AVI")
                                                    {
                                                        <i class="ti ti-video text-warning" style="font-size: 2.5rem;"></i>
                                                    }
                                                    else if (file.Type == "ZIP" || file.Type == "RAR")
                                                    {
                                                        <i class="ti ti-file-zip text-secondary" style="font-size: 2.5rem;"></i>
                                                    }
                                                    else
                                                    {
                                                        <i class="ti ti-file text-muted" style="font-size: 2.5rem;"></i>
                                                    }
                                                </span>
                                            </div>
                                            @if (file.IsFolder)
                                            {
                                                <h6 class="mb-1 text-truncate" title="@file.Name">
                                                    <a href="@Url.Action("Index", new { folderId = file.Id })"
                                                        class="link-reset fw-semibold">
                                                        @file.Name
                                                    </a>
                                                </h6>
                                            }
                                            else
                                            {
                                                <h6 class="mb-1 text-truncate" title="@file.Name">@file.Name</h6>
                                            }
                                            <p class="text-muted fs-xs mb-2">@(file.IsFolder ? "--" : FormatFileSize(file.Size))
                                            </p>
                                            <span class="badge bg-secondary-subtle text-secondary mb-3">@file.Type</span>
                                            <div class="d-flex gap-1 justify-content-center flex-wrap">
                                                @if (!file.IsFolder)
                                                {
                                                    <button type="button" class="btn btn-light btn-sm btn-icon favorite-btn"
                                                        data-file-id="@file.Id"
                                                        title="@(file.IsFavorite ? "Remove from favorites" : "Add to favorites")">
                                                        <i class="ti ti-star@(file.IsFavorite ? "-filled text-warning" : "")"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-light btn-sm btn-icon"
                                                        onclick="showMetadataModal(@file.Id)" title="File Info">
                                                        <i class="ti ti-info-circle"></i>
                                                    </button>
                                                    <a asp-action="Download" asp-route-id="@file.Id"
                                                        class="btn btn-light btn-sm btn-icon" title="Download">
                                                        <i class="ti ti-download"></i>
                                                    </a>
                                                }
                                                <button type="button" class="btn btn-light btn-sm btn-icon"
                                                    onclick="showDeleteModal(@file.Id, @Html.Raw(Json.Serialize(file.Name)))" title="Delete">
                                                    <i class="ti ti-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <div class="avatar avatar-xl bg-light mb-3">
                                <span class="avatar-title">
                                    <i class="ti ti-folder-off fs-1 text-muted"></i>
                                </span>
                            </div>
                            <h5 class="text-muted">No files found</h5>
                            <p class="text-muted">Upload files to get started</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#uploadModal">
                                <i class="ti ti-upload me-2"></i>Upload Your First File
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="UploadFiles" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" name="parentFolderId" value="@Model.CurrentFolderId" />
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">Upload Files</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="files" class="form-label">Select Files or Folder</label>
                        <input type="file" class="form-control" id="files" name="files" multiple>
                        <small class="form-text text-muted d-block mt-2">
                            <i class="ti ti-info-circle me-1"></i>
                            You can select multiple files or use the button below to upload a folder
                        </small>
                    </div>
                    <div class="mb-3">
                        <label for="folderUpload" class="form-label">Or Select Folder</label>
                        <input type="file" class="form-control" id="folderUpload" name="files" multiple webkitdirectory
                            directory>
                        <small class="form-text text-muted">Upload entire folder with its structure</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="ti ti-upload me-2"></i>Upload
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Folder Modal -->
<div class="modal fade" id="createFolderModal" tabindex="-1" aria-labelledby="createFolderModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <form asp-action="CreateFolder" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="parentFolderId" value="@Model.CurrentFolderId" />
                <div class="modal-header">
                    <h5 class="modal-title" id="createFolderModalLabel">
                        <i class="ti ti-folder-plus me-2"></i>Create New Folder
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="folderName" class="form-label">Folder Name</label>
                        <input type="text" class="form-control" id="folderName" name="folderName"
                            placeholder="Enter folder name" required autofocus>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="ti ti-folder-plus me-2"></i>Create Folder
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="UploadFiles" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" name="parentFolderId" value="@Model.CurrentFolderId" />
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">Upload Files</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="files" class="form-label">Select Files or Folder</label>
                        <input type="file" class="form-control" id="files" name="files" multiple webkitdirectory
                            directory>
                        <small class="form-text text-muted">
                            You can select multiple files or an entire folder. Maximum file size: 50MB per file.
                        </small>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="uploadMode">
                        <label class="form-check-label" for="uploadMode">
                            Upload folder (preserves folder structure)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="ti ti-upload me-2"></i>Upload
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Folder Modal -->
<div class="modal fade" id="createFolderModal" tabindex="-1" aria-labelledby="createFolderModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <form asp-action="CreateFolder" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="parentFolderId" value="@Model.CurrentFolderId" />
                <div class="modal-header">
                    <h5 class="modal-title" id="createFolderModalLabel">Create New Folder</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="folderName" class="form-label">Folder Name</label>
                        <input type="text" class="form-control" id="folderName" name="folderName"
                            placeholder="Enter folder name" required autofocus>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="ti ti-folder-plus me-2"></i>Create
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Metadata Modal -->
<div class="modal fade" id="metadataModal" tabindex="-1" aria-labelledby="metadataModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="metadataModalLabel">File Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-semibold">File Name</label>
                    <p id="metadataFileName" class="text-muted"></p>
                </div>
                <div class="mb-3">
                    <label for="metadataDescription" class="form-label fw-semibold">Description</label>
                    <textarea id="metadataDescription" class="form-control" rows="3"
                        placeholder="Add a description..."></textarea>
                </div>
                <div class="mb-3">
                    <label for="metadataTags" class="form-label fw-semibold">Tags</label>
                    <input type="text" id="metadataTags" class="form-control"
                        placeholder="Enter tags separated by commas (e.g., work, important, 2025)" />
                    <small class="text-muted">Separate tags with commas</small>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Statistics</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted d-block">File Size</small>
                                <span id="metadataSize" class="fw-semibold">--</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted d-block">Downloads</small>
                                <span id="metadataDownloads" class="fw-semibold">0</span>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted d-block">Last Accessed</small>
                                <span id="metadataLastAccessed" class="fw-semibold">Never</span>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted d-block">Created</small>
                                <span id="metadataCreated" class="fw-semibold">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveMetadataBtn">
                    <i class="ti ti-device-floppy me-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

@* Delete handled via confirmDelete() helper *@

@functions {
    string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}

@section scripts
{
    <script>
        // Show delete confirmation
        function showDeleteModal(id, name) {
            confirmDelete(name, async function () {
                try {
                    const response = await fetch(`/api/files/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        showError(data.message || 'Error deleting file');
                        return;
                    }

                    showSuccess('File deleted successfully!');
                    setTimeout(() => location.reload(), 1500);

                } catch (error) {
                    console.error('Delete error:', error);
                    showError('An unexpected error occurred');
                }
            });
        }

        // Filter by type
        document.getElementById('filterType').addEventListener('change', function () {
            const filterValue = this.value.toLowerCase();
            window.location.href = `@Url.Action("Index")?filterType=${filterValue}`;
        });

        // View toggle functionality
        const gridViewBtn = document.getElementById('gridViewBtn');
        const listViewBtn = document.getElementById('listViewBtn');
        const gridView = document.getElementById('gridView');
        const listView = document.getElementById('listView');

        // Load saved view preference
        const savedView = localStorage.getItem('fileManagerView') || 'list';
        if (savedView === 'grid' && gridView) {
            showGridView();
        }

        if (gridViewBtn) {
            gridViewBtn.addEventListener('click', function () {
                showGridView();
                localStorage.setItem('fileManagerView', 'grid');
            });
        }

        if (listViewBtn) {
            listViewBtn.addEventListener('click', function () {
                showListView();
                localStorage.setItem('fileManagerView', 'list');
            });
        }

        function showGridView() {
            if (gridView && listView) {
                gridView.style.display = '';
                listView.style.display = 'none';
                gridViewBtn.classList.add('active');
                listViewBtn.classList.remove('active');
            }
        }

        function showListView() {
            if (gridView && listView) {
                listView.style.display = '';
                gridView.style.display = 'none';
                listViewBtn.classList.add('active');
                gridViewBtn.classList.remove('active');
            }
        }

        // Search functionality - works with both views
        document.getElementById('searchInput').addEventListener('keyup', function () {
            const searchValue = this.value.toLowerCase();

            // Search in table rows (list view)
            const rows = document.querySelectorAll('#filesTable tr');
            rows.forEach(row => {
                const fileName = row.getAttribute('data-file-name');
                if (fileName && fileName.includes(searchValue)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });

            // Search in cards (grid view)
            const cards = document.querySelectorAll('.file-card');
            cards.forEach(card => {
                const fileName = card.getAttribute('data-file-name');
                if (fileName && fileName.includes(searchValue)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });

        // Auto-dismiss alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function () {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000);
            });
        });

        // Handle favorite button clicks
        document.querySelectorAll('.favorite-btn').forEach(btn => {
            btn.addEventListener('click', async function () {
                const fileId = this.dataset.fileId;
                const icon = this.querySelector('i');

                try {
                    const response = await fetch(`/api/files/${fileId}/favorite`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        if (data.isFavorite) {
                            icon.classList.add('ti-star-filled', 'text-warning');
                            icon.classList.remove('ti-star');
                            this.title = 'Remove from favorites';
                        } else {
                            icon.classList.add('ti-star');
                            icon.classList.remove('ti-star-filled', 'text-warning');
                            this.title = 'Add to favorites';
                        }
                        showSuccess(data.isFavorite ? 'Added to favorites' : 'Removed from favorites');
                    } else {
                        showError('Error updating favorites');
                    }
                } catch (error) {
                    console.error('Error toggling favorite:', error);
                    showError('An unexpected error occurred');
                }
            });
        });

        // Metadata modal functionality
        let currentFileId = null;

        async function showMetadataModal(fileId) {
            currentFileId = fileId;

            try {
                const response = await fetch(`/api/files/${fileId}/metadata`);
                const result = await response.json();

                if (result.success) {
                    const file = result.data;
                    document.getElementById('metadataFileName').textContent = file.name;
                    document.getElementById('metadataDescription').value = file.description || '';
                    document.getElementById('metadataTags').value = file.tags || '';
                    document.getElementById('metadataSize').textContent = formatFileSize(file.size);
                    document.getElementById('metadataDownloads').textContent = file.downloadCount;
                    document.getElementById('metadataLastAccessed').textContent =
                        file.lastAccessed ? new Date(file.lastAccessed).toLocaleString() : 'Never';
                    document.getElementById('metadataCreated').textContent =
                        new Date(file.created).toLocaleString();

                    new bootstrap.Modal(document.getElementById('metadataModal')).show();
                } else {
                    showError('Error loading file information');
                }
            } catch (error) {
                console.error('Error loading metadata:', error);
                showError('An unexpected error occurred');
            }
        }

        // Helper function to format file size in JavaScript
        function formatFileSize(bytes) {
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            if (bytes === 0) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Save metadata button handler
        document.getElementById('saveMetadataBtn').addEventListener('click', async function () {
            const description = document.getElementById('metadataDescription').value;
            const tags = document.getElementById('metadataTags').value;

            try {
                const response = await fetch(`/api/files/${currentFileId}/metadata`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: description,
                        tags: tags
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Metadata updated successfully');
                    bootstrap.Modal.getInstance(document.getElementById('metadataModal')).hide();
                } else {
                    showError(data.message || 'Error updating metadata');
                }
            } catch (error) {
                console.error('Error saving metadata:', error);
                showError('An unexpected error occurred');
            }
        });
    </script>
}