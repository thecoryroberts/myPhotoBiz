@using MyPhotoBiz.Models
@model List<Photo>
@{
    ViewData["Title"] = ViewBag.GalleryName ?? "Photo Gallery";
    var sessionToken = ViewBag.SessionToken;
    var galleryName = ViewBag.GalleryName ?? "Photo Gallery";
    var brandColor = ViewBag.BrandColor ?? "#4f46e5";
    var expiryDate = ViewBag.ExpiryDate as DateTime?;
    var daysUntilExpiry = ViewBag.DaysUntilExpiry as int? ?? 999;
    var isExpiringSoon = daysUntilExpiry <= 7 && daysUntilExpiry >= 0;
    var isExpiringVerySoon = daysUntilExpiry <= 3 && daysUntilExpiry >= 0;
    ViewBag.Purpose = "Client gallery view and proofing.";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>

    <!-- Theme Config -->
    <script src="~/js/config.js"></script>

    <!-- Vendor CSS -->
    <link href="~/css/vendors.min.css" rel="stylesheet" type="text/css">

    <!-- App CSS -->
    <link href="~/css/app.min.css" rel="stylesheet" type="text/css">

    <style>
        :root {
            --gallery-brand: @brandColor;
            --gallery-bg: #2a2a2a;
            --gallery-card-bg: #333;
            --gallery-card-border: #444;
            --gallery-text: #e8e8e8;
            --gallery-text-muted: #999;
        }

        /* Neutral dark background for accurate photo color viewing */
        body {
            background: var(--gallery-bg);
            min-height: 100vh;
        }

        /* Header Card */
        .gallery-header {
            background: linear-gradient(135deg, var(--gallery-brand) 0%, #1a1a2e 100%);
            border: none;
        }

        .gallery-header .card-body {
            padding: 2rem;
        }

        /* Photo Cards */
        .photo-card {
            background: var(--gallery-card-bg);
            border: 1px solid var(--gallery-card-border);
            border-radius: 0.5rem;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .photo-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.4);
        }

        .photo-card .card-body {
            background: var(--gallery-card-bg);
            padding: 1rem;
        }

        .photo-card .card-title {
            color: var(--gallery-text);
            font-weight: 500;
        }

        .photo-image-wrapper {
            position: relative;
            background: #1a1a1a;
            overflow: hidden;
        }

        .photo-image {
            width: 100%;
            height: 220px;
            object-fit: cover;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .photo-image.loading {
            opacity: 0;
        }

        .photo-image.loaded {
            opacity: 1;
        }

        .photo-image.error {
            object-fit: contain;
            padding: 2rem;
            background: #1a1a1a;
        }

        /* Skeleton loading */
        .photo-skeleton {
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, #333 25%, #444 50%, #333 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }

        .photo-skeleton.hidden {
            display: none;
        }

        @@keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Action Buttons */
        .action-btn-group .btn {
            border-radius: 0.375rem;
        }

        /* Favorite Button Active State */
        .favorite-btn.active {
            background: var(--bs-warning) !important;
            border-color: var(--bs-warning) !important;
            color: #000 !important;
        }

        .favorite-btn.active i {
            animation: heart-pulse 0.3s ease;
        }

        @@keyframes heart-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 9999;
            inset: 0;
            background: rgba(0,0,0,0.95);
            align-items: center;
            justify-content: center;
        }

        .lightbox.active {
            display: flex;
        }

        .lightbox-image {
            max-width: 90%;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 0.25rem;
        }

        .lightbox-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .lightbox-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .lightbox-nav:hover:not(:disabled) {
            background: rgba(255,255,255,0.25);
        }

        .lightbox-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .lightbox-nav.prev { left: 1.5rem; }
        .lightbox-nav.next { right: 1.5rem; }

        .lightbox-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
        }

        .lightbox-title {
            color: white;
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .lightbox-counter {
            color: rgba(255,255,255,0.7);
            font-size: 0.875rem;
        }

        .lightbox-actions {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            display: flex;
            gap: 0.5rem;
        }

        /* Stats Badge */
        .stats-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 2rem;
            color: white;
            font-weight: 500;
        }

        .stats-badge i {
            font-size: 1.125rem;
        }

        /* Modal Styling */
        .modal-content {
            background: var(--gallery-card-bg);
            border: 1px solid var(--gallery-card-border);
        }

        .modal-header {
            border-bottom-color: var(--gallery-card-border);
        }

        .modal-header .modal-title {
            color: var(--gallery-text);
        }

        .modal-header .btn-close {
            filter: invert(1);
        }

        .modal-body {
            color: var(--gallery-text);
        }

        .modal-footer {
            border-top-color: var(--gallery-card-border);
        }

        .modal .form-label {
            color: var(--gallery-text);
        }

        .modal .form-control {
            background: #2a2a2a;
            border-color: var(--gallery-card-border);
            color: var(--gallery-text);
        }

        .modal .form-control:focus {
            background: #2a2a2a;
            border-color: var(--gallery-brand);
            color: var(--gallery-text);
        }

        .modal .form-control::placeholder {
            color: var(--gallery-text-muted);
        }

        .modal .text-muted {
            color: var(--gallery-text-muted) !important;
        }

        /* Summary Modal Stats */
        .summary-stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
        }

        .summary-stat-card i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .summary-stat-card h3 {
            margin: 0.5rem 0 0.25rem;
            font-size: 1.75rem;
            color: var(--gallery-text);
        }

        .summary-stat-card small {
            color: var(--gallery-text-muted);
        }

        /* Empty State */
        .empty-state {
            padding: 4rem 2rem;
            text-align: center;
            background: var(--gallery-card-bg);
            border-radius: 0.5rem;
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--gallery-text-muted);
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            color: var(--gallery-text);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--gallery-text-muted);
        }

        /* Toast positioning */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 10000;
        }

        /* Text overrides for dark theme */
        .text-muted {
            color: var(--gallery-text-muted) !important;
        }
    </style>
</head>
<body>
    <!-- Expiry Warning Banner -->
    @if (isExpiringSoon && expiryDate.HasValue)
    {
        <div class="alert @(isExpiringVerySoon ? "alert-danger" : "alert-warning") alert-dismissible fade show mb-0 rounded-0 border-0" role="alert">
            <div class="container-fluid">
                <div class="d-flex align-items-center justify-content-center gap-2 flex-wrap">
                    <i class="ti ti-clock-exclamation fs-5"></i>
                    <strong>Gallery Access Expiring Soon!</strong>
                    @if (daysUntilExpiry == 1)
                    {
                        <span>Your access expires tomorrow (@expiryDate.Value.ToString("MMMM dd, yyyy")).</span>
                    }
                    else if (daysUntilExpiry == 0)
                    {
                        <span>Your access expires today!</span>
                    }
                    else
                    {
                        <span>Access expires in @daysUntilExpiry days (@expiryDate.Value.ToString("MMMM dd, yyyy")).</span>
                    }
                    <span class="d-none d-md-inline">Download your favorite photos before access ends.</span>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Header Card -->
    <div class="container-fluid py-4">
        <div class="card gallery-header shadow-lg mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <div class="avatar avatar-md">
                                <span class="avatar-title bg-white bg-opacity-25 text-white rounded-circle fs-4">
                                    <i class="ti ti-photo"></i>
                                </span>
                            </div>
                            <div>
                                <h2 class="text-white fw-bold mb-0">@galleryName</h2>
                                <p class="text-white-50 mb-0">Browse and select your favorite photos</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mt-3 mt-lg-0">
                        <div class="d-flex flex-wrap gap-2 justify-content-lg-end justify-content-center">
                            <span class="stats-badge">
                                <i class="ti ti-heart-filled text-warning"></i>
                                <span id="favoriteCount">0</span> Favorites
                            </span>
                            @if (expiryDate.HasValue)
                            {
                                <span class="stats-badge @(isExpiringVerySoon ? "bg-danger bg-opacity-50" : isExpiringSoon ? "bg-warning bg-opacity-25" : "")">
                                    <i class="ti ti-calendar"></i>
                                    @expiryDate.Value.ToString("MMM dd, yyyy")
                                </span>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex flex-wrap gap-2 justify-content-center mb-4">
            <button type="button" class="btn btn-primary" onclick="viewCart()">
                <i class="ti ti-shopping-cart me-1"></i>View Cart & Order Prints
            </button>
            <button type="button" class="btn btn-success" onclick="downloadSelected()">
                <i class="ti ti-download me-1"></i>Download Selected
            </button>
            <button type="button" class="btn btn-light" onclick="viewSummary()">
                <i class="ti ti-chart-pie me-1"></i>Summary
            </button>
        </div>

        <!-- Photo Gallery -->
        @if (Model.Count == 0)
        {
            <div class="empty-state">
                <i class="ti ti-photo-off d-block"></i>
                <h3>No Photos Available</h3>
                <p>This gallery doesn't have any photos yet. Please check back later.</p>
            </div>
        }
        else
        {
            <div class="row g-3" id="photoGallery">
                @{ var photoIndex = 0; }
                @foreach (var photo in Model)
                {
                    <div class="col-xl-3 col-lg-4 col-md-6">
                        <div class="card photo-card" data-photo-id="@photo.Id" data-photo-index="@photoIndex">
                            <div class="photo-image-wrapper">
                                <div class="photo-skeleton" id="skeleton-@photo.Id"></div>
                                <img src="@Url.Action("Thumbnail", "Photos", new { id = photo.Id })"
                                     alt="@(photo.Title ?? string.Empty)"
                                     class="photo-image loading"
                                     data-full-path="@(photo.FullImagePath ?? string.Empty)"
                                     data-title="@(photo.Title ?? string.Empty)"
                                     data-photo-id="@photo.Id"
                                     onclick="openLightbox(@photoIndex)"
                                     onload="handleImageLoad(this, @photo.Id)"
                                     onerror="handleImageError(this, @photo.Id)">
                            </div>
                            <div class="card-body">
                                <h6 class="card-title mb-3 text-truncate" title="@(photo.Title ?? string.Empty)">
                                    @(string.IsNullOrEmpty(photo.Title) ? "Untitled" : photo.Title)
                                </h6>
                                <div class="d-flex flex-wrap gap-2 action-btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-warning favorite-btn flex-fill" onclick="toggleFavorite(@photo.Id, this)" data-photo-id="@photo.Id">
                                        <i class="ti ti-heart me-1"></i>Favorite
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="showEditModal(@photo.Id, '@System.Text.Encodings.Web.JavaScriptEncoder.Default.Encode(photo.Title ?? string.Empty)')" title="Request Edit">
                                        <i class="ti ti-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="downloadPhoto(@photo.Id)" title="Download">
                                        <i class="ti ti-download"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    photoIndex++;
                }
            </div>

            <!-- Load More / Photo Count -->
            @if (ViewBag.HasMorePhotos == true)
            {
                <div class="text-center mt-4" id="loadMoreContainer">
                    <button type="button" class="btn btn-primary btn-lg px-4" id="loadMoreBtn" onclick="loadMorePhotos()">
                        <span class="btn-text">
                            <i class="ti ti-photo-plus me-2"></i>Load More Photos
                        </span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            Loading...
                        </span>
                    </button>
                    <p class="text-muted mt-2 mb-0" id="photoProgress">
                        Showing <span id="currentCount">@Model.Count()</span> of <span id="totalCount">@ViewBag.TotalPhotos</span> photos
                    </p>
                </div>
            }
            else if (ViewBag.TotalPhotos > 0)
            {
                <div class="text-center mt-4">
                    <span class="badge bg-light text-dark px-3 py-2">
                        <i class="ti ti-check me-1"></i>Showing all @ViewBag.TotalPhotos photos
                    </span>
                </div>
            }
        }
    </div>

    <!-- Lightbox -->
    <div id="lightboxModal" class="lightbox" onclick="handleLightboxClick(event)">
        <button type="button" class="lightbox-close" onclick="closeLightbox()" aria-label="Close">
            <i class="ti ti-x"></i>
        </button>

        <button type="button" class="lightbox-nav prev" onclick="navigateLightbox(-1)" id="lightboxPrev" aria-label="Previous">
            <i class="ti ti-chevron-left"></i>
        </button>

        <img id="lightboxImage" class="lightbox-image" src="" alt="Photo">

        <button type="button" class="lightbox-nav next" onclick="navigateLightbox(1)" id="lightboxNext" aria-label="Next">
            <i class="ti ti-chevron-right"></i>
        </button>

        <div class="lightbox-info">
            <div class="lightbox-title" id="lightboxTitle"></div>
            <div class="lightbox-counter" id="lightboxCounter"></div>
        </div>

        <div class="lightbox-actions">
            <button type="button" class="btn btn-warning btn-sm" onclick="toggleFavoriteFromLightbox()" id="lightboxFavoriteBtn">
                <i class="ti ti-heart me-1"></i><span id="lightboxFavoriteText">Favorite</span>
            </button>
            <button type="button" class="btn btn-success btn-sm" onclick="downloadFromLightbox()">
                <i class="ti ti-download me-1"></i>Download
            </button>
        </div>
    </div>

    <!-- Edit Request Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="d-flex align-items-center gap-2">
                        <div class="avatar avatar-sm">
                            <span class="avatar-title bg-info-subtle text-info rounded-circle">
                                <i class="ti ti-edit"></i>
                            </span>
                        </div>
                        <h5 class="modal-title mb-0">Request Photo Editing</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editPhotoId">

                    <div class="mb-3">
                        <label for="editPhotoTitle" class="form-label fw-semibold">
                            Photo Title
                        </label>
                        <input type="text" id="editPhotoTitle" class="form-control" placeholder="Enter a title for this photo">
                        <small class="text-muted mt-1 d-block">Give this photo a memorable name.</small>
                    </div>

                    <div class="mb-3">
                        <label for="editingNotes" class="form-label fw-semibold">
                            Editing Instructions <span class="text-muted fw-normal">(optional)</span>
                        </label>
                        <textarea id="editingNotes" class="form-control" rows="4"
                                  placeholder="Describe any changes you'd like (e.g., brighten the background, remove red-eye, crop closer, adjust colors, etc.)"></textarea>
                        <small class="text-muted mt-1 d-block">Be as specific as possible to help us deliver the best results.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveEditingNotes()">
                        <i class="ti ti-send me-1"></i>Submit Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div class="modal fade" id="summaryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="d-flex align-items-center gap-2">
                        <div class="avatar avatar-sm">
                            <span class="avatar-title bg-primary-subtle text-primary rounded-circle">
                                <i class="ti ti-chart-pie"></i>
                            </span>
                        </div>
                        <h5 class="modal-title mb-0">Gallery Summary</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-4">
                            <div class="summary-stat-card">
                                <i class="ti ti-photo text-primary"></i>
                                <h3 id="totalPhotos">0</h3>
                                <small>Total Photos</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="summary-stat-card">
                                <i class="ti ti-heart-filled text-warning"></i>
                                <h3 id="summaryFavorites">0</h3>
                                <small>Favorites</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="summary-stat-card">
                                <i class="ti ti-edit text-info"></i>
                                <h3 id="summaryEditing">0</h3>
                                <small>Edit Requests</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="~/js/vendors.min.js"></script>
    <script src="~/js/app.js"></script>

    <script>
        const sessionToken = '@sessionToken';
        const galleryId = @ViewBag.GalleryId;
        let currentPhotoId = null;
        let favoritePhotos = new Set();

        // Pagination state
        let currentPage = @(ViewBag.CurrentPage ?? 1);
        let totalPages = @(ViewBag.TotalPages ?? 1);
        let pageSize = @(ViewBag.PageSize ?? 48);
        let totalPhotos = @(ViewBag.TotalPhotos ?? 0);
        let isLoadingMore = false;

        // Lightbox state
        let currentLightboxIndex = 0;
        let photoData = [];

        // Initialize photo data from DOM
        function initPhotoData() {
            const images = document.querySelectorAll('#photoGallery .photo-image');
            photoData = Array.from(images).map((img, index) => ({
                id: parseInt(img.dataset.photoId),
                fullPath: img.dataset.fullPath,
                title: img.dataset.title,
                index: index
            }));
        }

        // Image loading handlers
        function handleImageLoad(img, photoId) {
            img.classList.remove('loading');
            img.classList.add('loaded');
            const skeleton = document.getElementById('skeleton-' + photoId);
            if (skeleton) skeleton.classList.add('hidden');
        }

        function handleImageError(img, photoId) {
            img.classList.remove('loading');
            img.classList.add('loaded', 'error');
            img.src = '/images/svg/photo-placeholder.svg';
            const skeleton = document.getElementById('skeleton-' + photoId);
            if (skeleton) skeleton.classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-bg-${type} border-0 show`;
            toast.role = 'alert';
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            container.appendChild(toast);

            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', function () {
                toast.remove();
            });
        }

        function toggleFavorite(photoId, button) {
            const isFavorite = !button.classList.contains('active');

            fetch(`/api/proofing/mark-favorite?photoId=${photoId}&sessionToken=${sessionToken}&isFavorite=${isFavorite}`, {
                method: 'POST'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    button.classList.toggle('active');
                    if (isFavorite) {
                        favoritePhotos.add(photoId);
                        showToast('Added to favorites', 'success');
                    } else {
                        favoritePhotos.delete(photoId);
                        showToast('Removed from favorites', 'info');
                    }
                    updateFavoriteCount();
                    updateLightboxFavoriteButton();
                } else {
                    showToast(data.message || 'Failed to update favorite', 'danger');
                }
            })
            .catch(err => {
                console.error(err);
                showToast('An error occurred', 'danger');
            });
        }

        function showEditModal(photoId, photoTitle) {
            currentPhotoId = photoId;
            document.getElementById('editPhotoId').value = photoId;
            document.getElementById('editPhotoTitle').value = photoTitle || '';
            document.getElementById('editingNotes').value = '';

            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        }

        function saveEditingNotes() {
            const title = document.getElementById('editPhotoTitle').value.trim();
            const notes = document.getElementById('editingNotes').value.trim();

            if (!title && !notes) {
                showToast('Please enter a title or editing instructions', 'warning');
                return;
            }

            const payload = {};
            if (title) payload.title = title;
            if (notes) payload.editingNotes = notes;

            fetch(`/api/proofing/update-photo?photoId=${currentPhotoId}&sessionToken=${sessionToken}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();

                    // Update the photo title in the UI
                    if (title) {
                        updatePhotoTitleInUI(currentPhotoId, title);
                    }

                    const message = notes ? 'Photo updated and edit request submitted!' : 'Photo title updated!';
                    showToast(message, 'success');
                } else {
                    showToast(data.message || 'Failed to update photo', 'danger');
                }
            })
            .catch(err => {
                console.error(err);
                showToast('An error occurred', 'danger');
            });
        }

        function updatePhotoTitleInUI(photoId, newTitle) {
            // Update card title
            const card = document.querySelector(`.photo-card[data-photo-id="${photoId}"]`);
            if (card) {
                const titleEl = card.querySelector('.card-title');
                if (titleEl) {
                    titleEl.textContent = newTitle;
                    titleEl.title = newTitle;
                }
                const img = card.querySelector('.photo-image');
                if (img) {
                    img.dataset.title = newTitle;
                    img.alt = newTitle;
                }
            }

            // Update photoData array for lightbox
            const photoIndex = photoData.findIndex(p => p.id === photoId);
            if (photoIndex !== -1) {
                photoData[photoIndex].title = newTitle;
            }
        }

        function downloadPhoto(photoId) {
            window.location.href = `/Gallery/Download?photoId=${photoId}&galleryId=${galleryId}`;
        }

        // Lightbox functions
        function openLightbox(index) {
            currentLightboxIndex = index;
            updateLightboxContent();
            document.getElementById('lightboxModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            document.getElementById('lightboxModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function handleLightboxClick(event) {
            if (event.target.id === 'lightboxModal') {
                closeLightbox();
            }
        }

        function navigateLightbox(direction) {
            event.stopPropagation();
            const newIndex = currentLightboxIndex + direction;
            if (newIndex >= 0 && newIndex < photoData.length) {
                currentLightboxIndex = newIndex;
                updateLightboxContent();
            }
        }

        function updateLightboxContent() {
            const photo = photoData[currentLightboxIndex];
            if (!photo) return;

            const img = document.getElementById('lightboxImage');
            img.src = photo.fullPath;
            img.alt = photo.title || 'Photo';
            img.onerror = function() {
                this.src = '/images/svg/photo-placeholder.svg';
            };

            document.getElementById('lightboxTitle').textContent = photo.title || 'Untitled';
            document.getElementById('lightboxCounter').textContent = `${currentLightboxIndex + 1} of ${photoData.length}`;

            document.getElementById('lightboxPrev').disabled = currentLightboxIndex === 0;
            document.getElementById('lightboxNext').disabled = currentLightboxIndex === photoData.length - 1;

            currentPhotoId = photo.id;
            updateLightboxFavoriteButton();
        }

        function updateLightboxFavoriteButton() {
            const btn = document.getElementById('lightboxFavoriteBtn');
            const text = document.getElementById('lightboxFavoriteText');
            const photo = photoData[currentLightboxIndex];

            if (photo && favoritePhotos.has(photo.id)) {
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-success');
                text.textContent = 'Favorited';
            } else {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-warning');
                text.textContent = 'Favorite';
            }
        }

        function toggleFavoriteFromLightbox() {
            event.stopPropagation();
            const photo = photoData[currentLightboxIndex];
            if (!photo) return;

            const cardBtn = document.querySelector(`.favorite-btn[data-photo-id="${photo.id}"]`);
            if (cardBtn) {
                toggleFavorite(photo.id, cardBtn);
            }
        }

        function downloadFromLightbox() {
            event.stopPropagation();
            const photo = photoData[currentLightboxIndex];
            if (photo) {
                downloadPhoto(photo.id);
            }
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            const lightbox = document.getElementById('lightboxModal');
            if (!lightbox.classList.contains('active')) return;

            switch(e.key) {
                case 'Escape':
                    closeLightbox();
                    break;
                case 'ArrowLeft':
                    if (currentLightboxIndex > 0) navigateLightbox(-1);
                    break;
                case 'ArrowRight':
                    if (currentLightboxIndex < photoData.length - 1) navigateLightbox(1);
                    break;
                case ' ':
                case 'f':
                case 'F':
                    e.preventDefault();
                    toggleFavoriteFromLightbox();
                    break;
                case 'd':
                case 'D':
                    downloadFromLightbox();
                    break;
                case 'e':
                case 'E':
                    closeLightbox();
                    const photo = photoData[currentLightboxIndex];
                    if (photo) showEditModal(photo.id, photo.title);
                    break;
            }
        });

        function viewCart() {
            if (favoritePhotos.size === 0) {
                showToast('Please mark some photos as favorites first!', 'warning');
                return;
            }
            window.location.href = `/PrintOrder/CartPreview?sessionToken=${sessionToken}`;
        }

        async function downloadSelected() {
            if (favoritePhotos.size === 0) {
                showToast('Please mark some photos as favorites first!', 'warning');
                return;
            }

            showToast(`Preparing ZIP file with ${favoritePhotos.size} photo(s)...`, 'info');

            try {
                const photoIds = Array.from(favoritePhotos);
                const antiforgeryToken = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

                const response = await fetch(`/Gallery/DownloadBulk?galleryId=${galleryId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': antiforgeryToken
                    },
                    body: JSON.stringify(photoIds)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Download failed');
                }

                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'photos.zip';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                    if (filenameMatch && filenameMatch[1]) {
                        filename = filenameMatch[1].replace(/['"]/g, '');
                    }
                }

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showToast(`Successfully downloaded ${favoritePhotos.size} photo(s)!`, 'success');
            } catch (error) {
                console.error('Download error:', error);
                showToast('Failed to download photos. Please try again.', 'danger');
            }
        }

        function viewSummary() {
            fetch(`/api/proofing/summary/${sessionToken}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('totalPhotos').textContent = data.data.totalPhotos;
                        document.getElementById('summaryFavorites').textContent = data.data.favoriteCount;
                        document.getElementById('summaryEditing').textContent = data.data.editingCount;

                        const modal = new bootstrap.Modal(document.getElementById('summaryModal'));
                        modal.show();
                    } else {
                        showToast('Failed to load summary', 'danger');
                    }
                })
                .catch(err => {
                    console.error(err);
                    showToast('An error occurred', 'danger');
                });
        }

        function updateFavoriteCount() {
            document.getElementById('favoriteCount').textContent = favoritePhotos.size;
        }

        // Load more photos for pagination
        async function loadMorePhotos() {
            if (isLoadingMore || currentPage >= totalPages) return;

            isLoadingMore = true;
            const btn = document.getElementById('loadMoreBtn');
            const btnText = btn.querySelector('.btn-text');
            const btnLoading = btn.querySelector('.btn-loading');

            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            btn.disabled = true;

            try {
                const nextPage = currentPage + 1;
                const response = await fetch(`/api/gallery/${galleryId}/photos?page=${nextPage}&pageSize=${pageSize}`);
                const data = await response.json();

                if (data.success && data.data && data.data.photos && data.data.photos.length > 0) {
                    const gallery = document.getElementById('photoGallery');
                    const startIndex = photoData.length;
                    const photos = data.data.photos;
                    const pagination = data.data.pagination;

                    photos.forEach((photo, idx) => {
                        const photoIndex = startIndex + idx;
                        const col = document.createElement('div');
                        col.className = 'col-xl-3 col-lg-4 col-md-6';
                        col.innerHTML = `
                            <div class="card photo-card" data-photo-id="${photo.id}" data-photo-index="${photoIndex}">
                                <div class="photo-image-wrapper">
                                    <div class="photo-skeleton" id="skeleton-${photo.id}"></div>
                                    <img src="${photo.thumbnailPath || photo.fullImagePath}"
                                         alt="${escapeHtml(photo.title)}"
                                         class="photo-image loading"
                                         data-full-path="${photo.fullImagePath}"
                                         data-title="${escapeHtml(photo.title)}"
                                         data-photo-id="${photo.id}"
                                         onclick="openLightbox(${photoIndex})"
                                         onload="handleImageLoad(this, ${photo.id})"
                                         onerror="handleImageError(this, ${photo.id})">
                                </div>
                                <div class="card-body">
                                    <h6 class="card-title mb-3 text-truncate" title="${escapeHtml(photo.title)}">${escapeHtml(photo.title) || 'Untitled'}</h6>
                                    <div class="d-flex flex-wrap gap-2 action-btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-warning favorite-btn flex-fill ${favoritePhotos.has(photo.id) ? 'active' : ''}" onclick="toggleFavorite(${photo.id}, this)" data-photo-id="${photo.id}">
                                            <i class="ti ti-heart me-1"></i>Favorite
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info" onclick="showEditModal(${photo.id}, '${escapeHtml(photo.title).replace(/'/g, "\\'")}')" title="Request Edit">
                                            <i class="ti ti-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="downloadPhoto(${photo.id})" title="Download">
                                            <i class="ti ti-download"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        gallery.appendChild(col);

                        photoData.push({
                            id: photo.id,
                            fullPath: photo.fullImagePath,
                            title: photo.title,
                            index: photoIndex
                        });
                    });

                    currentPage = pagination.currentPage;
                    totalPages = pagination.totalPages;

                    const currentCount = document.getElementById('currentCount');
                    if (currentCount) {
                        currentCount.textContent = photoData.length;
                    }

                    if (!pagination.hasNextPage) {
                        const container = document.getElementById('loadMoreContainer');
                        if (container) {
                            container.innerHTML = `
                                <span class="badge bg-light text-dark px-3 py-2">
                                    <i class="ti ti-check me-1"></i>Showing all ${totalPhotos} photos
                                </span>
                            `;
                        }
                    }

                    showToast(`Loaded ${photos.length} more photos`, 'success');
                } else {
                    showToast('No more photos to load', 'info');
                }
            } catch (error) {
                console.error('Error loading more photos:', error);
                showToast('Failed to load more photos', 'danger');
            } finally {
                isLoadingMore = false;
                btnText.classList.remove('d-none');
                btnLoading.classList.add('d-none');
                btn.disabled = false;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Load favorites on page load
        document.addEventListener('DOMContentLoaded', function() {
            initPhotoData();

            fetch(`/api/proofing/favorites/${sessionToken}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.data) {
                        data.data.forEach(photo => {
                            favoritePhotos.add(photo.id);
                            const card = document.querySelector(`[data-photo-id="${photo.id}"]`);
                            if (card) {
                                const btn = card.querySelector('.favorite-btn');
                                if (btn) btn.classList.add('active');
                            }
                        });
                        updateFavoriteCount();
                    }
                })
                .catch(err => console.error('Error loading favorites:', err));
        });
    </script>
</body>
</html>
