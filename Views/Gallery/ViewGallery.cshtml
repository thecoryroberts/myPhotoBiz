@{
    ViewBag.Purpose = "Client gallery view and proofing.";
}

@using MyPhotoBiz.Models
@model List<Photo>
@{
    ViewData["Title"] = ViewBag.GalleryName ?? "Photo Gallery";
    var sessionToken = ViewBag.SessionToken;
    var galleryName = ViewBag.GalleryName ?? "Photo Gallery";
    var brandColor = ViewBag.BrandColor ?? "#2c3e50";
    var expiryDate = ViewBag.ExpiryDate as DateTime?;
    var daysUntilExpiry = ViewBag.DaysUntilExpiry as int? ?? 999;
    var isExpiringSoon = daysUntilExpiry <= 7 && daysUntilExpiry >= 0;
    var isExpiringVerySoon = daysUntilExpiry <= 3 && daysUntilExpiry >= 0;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>

    <!-- Theme Config -->
    <script src="~/js/config.js"></script>

    <!-- Vendor CSS -->
    <link href="~/css/vendors.min.css" rel="stylesheet" type="text/css">

    <!-- App CSS -->
    <link href="~/css/app.min.css" rel="stylesheet" type="text/css">

    <style>
        /* Neutral dark gray background for accurate photo color viewing */
        body {
            background: #3a3a3a;
        }

        .photo-card {
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            background: #2d2d2d;
            border-color: #4a4a4a !important;
        }

        .photo-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }

        .photo-card .card-body {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        .photo-card .card-title {
            color: #f0f0f0;
        }

        .photo-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: #4a4a4a;
        }

        .photo-image.loading {
            opacity: 0;
        }

        .photo-image.loaded {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .photo-image.error {
            object-fit: contain;
            padding: 20px;
            background: #4a4a4a;
        }

        /* Skeleton loading animation - dark theme */
        .photo-skeleton {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 250px;
            background: linear-gradient(90deg, #4a4a4a 25%, #5a5a5a 50%, #4a4a4a 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }

        .photo-skeleton.hidden {
            display: none;
        }

        @@keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Text colors for dark background */
        .text-muted {
            color: #a0a0a0 !important;
        } 

        .photo-card-wrapper {
            position: relative;
        }

        .favorite-btn.active {
            background: #ffc107 !important;
            color: white !important;
            border-color: #ffc107 !important;
        }

        .lightbox {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            align-items: center;
            justify-content: center;
        }

        .lightbox.active {
            display: flex;
        }

        .lightbox img {
            max-width: 85%;
            max-height: 85vh;
            object-fit: contain;
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            font-size: 24px;
        }

        .lightbox-nav:hover {
            background: rgba(255,255,255,0.3);
        }

        .lightbox-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .lightbox-nav.prev {
            left: 20px;
        }

        .lightbox-nav.next {
            right: 20px;
        }

        .lightbox-counter {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 14px;
            background: rgba(0,0,0,0.5);
            padding: 8px 16px;
            border-radius: 20px;
        }

        .lightbox-title {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 16px;
            background: rgba(0,0,0,0.5);
            padding: 8px 20px;
            border-radius: 20px;
            max-width: 80%;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lightbox-actions {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .lightbox-actions .btn {
            opacity: 0.8;
        }

        .lightbox-actions .btn:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Expiry Warning Banner -->
    @if (isExpiringSoon && expiryDate.HasValue)
    {
        <div class="alert @(isExpiringVerySoon ? "alert-danger" : "alert-warning") alert-dismissible fade show mb-0 rounded-0 border-0" role="alert">
            <div class="container-fluid">
                <div class="d-flex align-items-center justify-content-center gap-2">
                    <i class="ti ti-clock-alert fs-4"></i>
                    <strong>Gallery Access Expiring Soon!</strong>
                    @if (daysUntilExpiry == 1)
                    {
                        <span>Your access to this gallery expires tomorrow (@expiryDate.Value.ToString("MMMM dd, yyyy")).</span>
                    }
                    else if (daysUntilExpiry == 0)
                    {
                        <span>Your access to this gallery expires today!</span>
                    }
                    else
                    {
                        <span>Your access expires in @daysUntilExpiry days (@expiryDate.Value.ToString("MMMM dd, yyyy")).</span>
                    }
                    <span class="ms-2">Please download your favorite photos before access ends.</span>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Header -->
    <div class="container-fluid">
        <div class="card shadow-none position-relative overflow-hidden mb-4" style="background: linear-gradient(135deg, @brandColor 0%, #333 100%);">
            <div class="card-body px-4 py-4 text-white">
                <div class="row align-items-center">
                    <div class="col-md-8 text-center text-md-start">
                        <h2 class="fw-bold mb-2">
                            <i class="ti ti-photo me-2"></i>@galleryName
                        </h2>
                        <p class="mb-0 opacity-75">Browse and select your favorite photos for ordering or download</p>
                    </div>
                    <div class="col-md-4 text-center text-md-end mt-3 mt-md-0">
                        <span class="badge bg-warning text-dark fs-6 me-2">
                            <i class="ti ti-heart-filled"></i>
                            <span id="favoriteCount">0</span> Favorites
                        </span>
                        @if (expiryDate.HasValue)
                        {
                            <span class="badge @(isExpiringVerySoon ? "bg-danger" : isExpiringSoon ? "bg-warning text-dark" : "bg-light text-dark") fs-6">
                                <i class="ti ti-calendar"></i>
                                Expires: @expiryDate.Value.ToString("MMM dd, yyyy")
                            </span>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="container-fluid mb-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex gap-2 justify-content-center flex-wrap">
                    <button type="button" class="btn btn-primary" onclick="viewCart()">
                        <i class="ti ti-shopping-cart me-1"></i>View Cart & Order Prints
                    </button>
                    <button type="button" class="btn btn-success" onclick="downloadSelected()">
                        <i class="ti ti-download me-1"></i>Download Selected
                    </button>
                    <button type="button" class="btn btn-info" onclick="viewSummary()">
                        <i class="ti ti-info-circle me-1"></i>View Summary
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Gallery -->
    <div class="container-fluid">
        @if (Model.Count == 0)
        {
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card text-center">
                        <div class="card-body py-5">
                            <i class="ti ti-photo-off" style="font-size: 64px; color: #ccc;"></i>
                            <h3 class="mt-3">No Photos Available</h3>
                            <p class="text-muted">This gallery doesn't have any photos yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="row g-3" id="photoGallery">
                @{ var photoIndex = 0; }
                @foreach (var photo in Model)
                {
                    <div class="col-lg-3 col-md-4 col-sm-6">
                        <div class="card photo-card border" data-photo-id="@photo.Id" data-photo-index="@photoIndex">
                            <div class="photo-card-wrapper">
                                <div class="photo-skeleton" id="skeleton-@photo.Id"></div>
                                  <img src="@Url.Action("Thumbnail", "Photos", new { id = photo.Id })"
                                      alt="@(photo.Title ?? string.Empty)"
                                      class="photo-image loading"
                                      data-full-path="@(photo.FullImagePath ?? string.Empty)"
                                      data-title="@(photo.Title ?? string.Empty)"
                                     data-photo-id="@photo.Id"
                                     onclick="openLightbox(@photoIndex)"
                                     onload="handleImageLoad(this, @photo.Id)"
                                     onerror="handleImageError(this, @photo.Id)">
                            </div>
                            <div class="card-body">
                                <h6 class="card-title mb-3 text-truncate" title="@(photo.Title ?? string.Empty)">@(photo.Title ?? string.Empty)</h6>

                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-warning favorite-btn" onclick="toggleFavorite(@photo.Id, this)" data-photo-id="@photo.Id">
                                        <i class="ti ti-heart me-1"></i>Favorite
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="showEditModal(@photo.Id, '@System.Text.Encodings.Web.JavaScriptEncoder.Default.Encode(photo.Title ?? string.Empty)')">
                                        <i class="ti ti-edit me-1"></i>Request Edit
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="downloadPhoto(@photo.Id)">
                                        <i class="ti ti-download me-1"></i>Download
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    photoIndex++;
                }
            </div>

            <!-- Load More Button -->
            @if (ViewBag.HasMorePhotos == true)
            {
                <div class="text-center mt-4" id="loadMoreContainer">
                    <button type="button" class="btn btn-primary btn-lg" id="loadMoreBtn" onclick="loadMorePhotos()">
                        <span class="btn-text">
                            <i class="ti ti-photo-plus me-2"></i>Load More Photos
                        </span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            Loading...
                        </span>
                    </button>
                    <p class="text-muted mt-2 mb-0" id="photoProgress">
                        Showing <span id="currentCount">@Model.Count()</span> of <span id="totalCount">@ViewBag.TotalPhotos</span> photos
                    </p>
                </div>
            }
            else if (ViewBag.TotalPhotos > 0)
            {
                <div class="text-center mt-4 text-muted">
                    <i class="ti ti-check me-1"></i>Showing all @ViewBag.TotalPhotos photos
                </div>
            }
        }
    </div>

    <!-- Lightbox Modal -->
    <div id="lightboxModal" class="lightbox" onclick="handleLightboxClick(event)">
        <button type="button" class="lightbox-nav prev" onclick="navigateLightbox(-1)" id="lightboxPrev">
            <i class="ti ti-chevron-left"></i>
        </button>

        <img id="lightboxImage" src="" alt="Photo">

        <button type="button" class="lightbox-nav next" onclick="navigateLightbox(1)" id="lightboxNext">
            <i class="ti ti-chevron-right"></i>
        </button>

        <button type="button" class="btn btn-light position-absolute top-0 end-0 m-3" onclick="closeLightbox()">
            <i class="ti ti-x fs-lg"></i>
        </button>

        <div class="lightbox-title" id="lightboxTitle"></div>
        <div class="lightbox-counter" id="lightboxCounter"></div>

        <div class="lightbox-actions">
            <button type="button" class="btn btn-warning btn-sm" onclick="toggleFavoriteFromLightbox()" id="lightboxFavoriteBtn">
                <i class="ti ti-heart me-1"></i><span id="lightboxFavoriteText">Favorite</span>
            </button>
            <button type="button" class="btn btn-success btn-sm" onclick="downloadFromLightbox()">
                <i class="ti ti-download me-1"></i>Download
            </button>
        </div>
    </div>

    <!-- Edit Notes Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-light">
                    <h5 class="modal-title fw-semibold">
                        <i class="ti ti-edit me-2"></i>Request Photo Editing
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editPhotoId">

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Photo:</label>
                        <div id="editPhotoTitle" class="text-muted"></div>
                    </div>

                    <div class="mb-3">
                        <label for="editingNotes" class="form-label fw-semibold">
                            <i class="ti ti-message me-1 text-muted"></i>Editing Instructions
                        </label>
                        <textarea id="editingNotes" class="form-control" rows="5"
                                  placeholder="Describe the changes you'd like (e.g., brighten the background, remove red-eye, crop closer, etc.)"></textarea>
                        <small class="text-muted">Be as specific as possible to help us deliver the best results.</small>
                    </div>
                </div>
                <div class="modal-footer border-light">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                        <i class="ti ti-x me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveEditingNotes()">
                        <i class="ti ti-check me-1"></i>Submit Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div class="modal fade" id="summaryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-light">
                    <h5 class="modal-title fw-semibold">
                        <i class="ti ti-chart-pie me-2"></i>Gallery Summary
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row text-center g-3">
                        <div class="col-4">
                            <div class="card bg-primary-subtle">
                                <div class="card-body">
                                    <i class="ti ti-photo fs-1 text-primary"></i>
                                    <h3 class="mt-2 mb-0" id="totalPhotos">0</h3>
                                    <small class="text-muted">Total Photos</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-warning-subtle">
                                <div class="card-body">
                                    <i class="ti ti-heart-filled fs-1 text-warning"></i>
                                    <h3 class="mt-2 mb-0" id="summaryFavorites">0</h3>
                                    <small class="text-muted">Favorites</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-info-subtle">
                                <div class="card-body">
                                    <i class="ti ti-edit fs-1 text-info"></i>
                                    <h3 class="mt-2 mb-0" id="summaryEditing">0</h3>
                                    <small class="text-muted">Edit Requests</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-light">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="position-fixed top-0 end-0 p-3 z-toast" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="~/js/vendors.min.js"></script>
    <script src="~/js/app.js"></script>

    <script>
        const sessionToken = '@sessionToken';
        const galleryId = @ViewBag.GalleryId;
        let currentPhotoId = null;
        let favoritePhotos = new Set();

        // Pagination state
        let currentPage = @(ViewBag.CurrentPage ?? 1);
        let totalPages = @(ViewBag.TotalPages ?? 1);
        let pageSize = @(ViewBag.PageSize ?? 48);
        let totalPhotos = @(ViewBag.TotalPhotos ?? 0);
        let isLoadingMore = false;

        // Lightbox state
        let currentLightboxIndex = 0;
        let photoData = [];

        // Initialize photo data from DOM
        function initPhotoData() {
            const images = document.querySelectorAll('#photoGallery .photo-image');
            photoData = Array.from(images).map((img, index) => ({
                id: parseInt(img.dataset.photoId),
                fullPath: img.dataset.fullPath,
                title: img.dataset.title,
                index: index
            }));
        }

        // Image loading handlers
        function handleImageLoad(img, photoId) {
            img.classList.remove('loading');
            img.classList.add('loaded');
            const skeleton = document.getElementById('skeleton-' + photoId);
            if (skeleton) skeleton.classList.add('hidden');
        }

        function handleImageError(img, photoId) {
            img.classList.remove('loading');
            img.classList.add('loaded', 'error');
            img.src = '/images/svg/photo-placeholder.svg';
            const skeleton = document.getElementById('skeleton-' + photoId);
            if (skeleton) skeleton.classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-bg-${type} border-0 show`;
            toast.role = 'alert';
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            container.appendChild(toast);

            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', function () {
                toast.remove();
            });
        }

        function toggleFavorite(photoId, button) {
            const isFavorite = !button.classList.contains('active');

            fetch(`/api/proofing/mark-favorite?photoId=${photoId}&sessionToken=${sessionToken}&isFavorite=${isFavorite}`, {
                method: 'POST'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    button.classList.toggle('active');
                    if (isFavorite) {
                        favoritePhotos.add(photoId);
                        showToast('Added to favorites', 'success');
                    } else {
                        favoritePhotos.delete(photoId);
                        showToast('Removed from favorites', 'info');
                    }
                    updateFavoriteCount();
                    updateLightboxFavoriteButton();
                } else {
                    showToast(data.message || 'Failed to update favorite', 'danger');
                }
            })
            .catch(err => {
                console.error(err);
                showToast('An error occurred', 'danger');
            });
        }

        function showEditModal(photoId, photoTitle) {
            currentPhotoId = photoId;
            document.getElementById('editPhotoId').value = photoId;
            document.getElementById('editPhotoTitle').textContent = photoTitle;
            document.getElementById('editingNotes').value = '';

            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        }

        function saveEditingNotes() {
            const notes = document.getElementById('editingNotes').value.trim();

            if (!notes) {
                showToast('Please provide editing instructions', 'warning');
                return;
            }

            fetch(`/api/proofing/mark-for-editing?photoId=${currentPhotoId}&sessionToken=${sessionToken}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ editingNotes: notes })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                    showToast('Edit request submitted successfully!', 'success');
                } else {
                    showToast(data.message || 'Failed to submit request', 'danger');
                }
            })
            .catch(err => {
                console.error(err);
                showToast('An error occurred', 'danger');
            });
        }

        function downloadPhoto(photoId) {
            window.location.href = `/Gallery/Download?photoId=${photoId}&galleryId=${galleryId}`;
        }

        // Lightbox functions
        function openLightbox(index) {
            currentLightboxIndex = index;
            updateLightboxContent();
            document.getElementById('lightboxModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            document.getElementById('lightboxModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function handleLightboxClick(event) {
            // Only close if clicking on the background, not on controls
            if (event.target.id === 'lightboxModal') {
                closeLightbox();
            }
        }

        function navigateLightbox(direction) {
            event.stopPropagation();
            const newIndex = currentLightboxIndex + direction;
            if (newIndex >= 0 && newIndex < photoData.length) {
                currentLightboxIndex = newIndex;
                updateLightboxContent();
            }
        }

        function updateLightboxContent() {
            const photo = photoData[currentLightboxIndex];
            if (!photo) return;

            const img = document.getElementById('lightboxImage');
            img.src = photo.fullPath;
            img.alt = photo.title;
            img.onerror = function() {
                this.src = '/images/svg/photo-placeholder.svg';
            };

            document.getElementById('lightboxTitle').textContent = photo.title;
            document.getElementById('lightboxCounter').textContent = `${currentLightboxIndex + 1} / ${photoData.length}`;

            // Update navigation buttons
            document.getElementById('lightboxPrev').disabled = currentLightboxIndex === 0;
            document.getElementById('lightboxNext').disabled = currentLightboxIndex === photoData.length - 1;

            // Update favorite button
            currentPhotoId = photo.id;
            updateLightboxFavoriteButton();
        }

        function updateLightboxFavoriteButton() {
            const btn = document.getElementById('lightboxFavoriteBtn');
            const text = document.getElementById('lightboxFavoriteText');
            const photo = photoData[currentLightboxIndex];

            if (photo && favoritePhotos.has(photo.id)) {
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-success');
                text.textContent = 'Favorited';
            } else {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-warning');
                text.textContent = 'Favorite';
            }
        }

        function toggleFavoriteFromLightbox() {
            event.stopPropagation();
            const photo = photoData[currentLightboxIndex];
            if (!photo) return;

            const cardBtn = document.querySelector(`.favorite-btn[data-photo-id="${photo.id}"]`);
            if (cardBtn) {
                toggleFavorite(photo.id, cardBtn);
            }
        }

        function downloadFromLightbox() {
            event.stopPropagation();
            const photo = photoData[currentLightboxIndex];
            if (photo) {
                downloadPhoto(photo.id);
            }
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            const lightbox = document.getElementById('lightboxModal');
            if (!lightbox.classList.contains('active')) return;

            switch(e.key) {
                case 'Escape':
                    closeLightbox();
                    break;
                case 'ArrowLeft':
                    if (currentLightboxIndex > 0) navigateLightbox(-1);
                    break;
                case 'ArrowRight':
                    if (currentLightboxIndex < photoData.length - 1) navigateLightbox(1);
                    break;
                case ' ':
                case 'f':
                case 'F':
                    e.preventDefault();
                    toggleFavoriteFromLightbox();
                    break;
                case 'd':
                case 'D':
                    downloadFromLightbox();
                    break;
                case 'e':
                case 'E':
                    closeLightbox();
                    const photo = photoData[currentLightboxIndex];
                    if (photo) showEditModal(photo.id, photo.title);
                    break;
            }
        });

        function viewCart() {
            if (favoritePhotos.size === 0) {
                showToast('Please mark some photos as favorites first!', 'warning');
                return;
            }
            window.location.href = `/PrintOrder/CartPreview?sessionToken=${sessionToken}`;
        }

        async function downloadSelected() {
            if (favoritePhotos.size === 0) {
                showToast('Please mark some photos as favorites first!', 'warning');
                return;
            }

            // Show loading state
            showToast(`Preparing ZIP file with ${favoritePhotos.size} photo(s)...`, 'info');

            try {
                const photoIds = Array.from(favoritePhotos);
                const antiforgeryToken = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

                const response = await fetch(`/Gallery/DownloadBulk?galleryId=${galleryId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': antiforgeryToken
                    },
                    body: JSON.stringify(photoIds)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Download failed');
                }

                // Get the blob from response
                const blob = await response.blob();

                // Get filename from Content-Disposition header or use default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'photos.zip';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                    if (filenameMatch && filenameMatch[1]) {
                        filename = filenameMatch[1].replace(/['"]/g, '');
                    }
                }

                // Create download link and trigger download
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showToast(`Successfully downloaded ${favoritePhotos.size} photo(s)!`, 'success');
            } catch (error) {
                console.error('Download error:', error);
                showToast('Failed to download photos. Please try again.', 'danger');
            }
        }

        function viewSummary() {
            fetch(`/api/proofing/summary/${sessionToken}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('totalPhotos').textContent = data.data.totalPhotos;
                        document.getElementById('summaryFavorites').textContent = data.data.favoriteCount;
                        document.getElementById('summaryEditing').textContent = data.data.editingCount;

                        const modal = new bootstrap.Modal(document.getElementById('summaryModal'));
                        modal.show();
                    } else {
                        showToast('Failed to load summary', 'danger');
                    }
                })
                .catch(err => {
                    console.error(err);
                    showToast('An error occurred', 'danger');
                });
        }

        function updateFavoriteCount() {
            document.getElementById('favoriteCount').textContent = favoritePhotos.size;
        }

        // Load more photos for pagination
        async function loadMorePhotos() {
            if (isLoadingMore || currentPage >= totalPages) return;

            isLoadingMore = true;
            const btn = document.getElementById('loadMoreBtn');
            const btnText = btn.querySelector('.btn-text');
            const btnLoading = btn.querySelector('.btn-loading');

            // Show loading state
            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            btn.disabled = true;

            try {
                const nextPage = currentPage + 1;
                const response = await fetch(`/api/gallery/${galleryId}/photos?page=${nextPage}&pageSize=${pageSize}`);
                const data = await response.json();

                if (data.success && data.data && data.data.photos && data.data.photos.length > 0) {
                    const gallery = document.getElementById('photoGallery');
                    const startIndex = photoData.length;
                    const photos = data.data.photos;
                    const pagination = data.data.pagination;

                    // Create and append new photo cards
                    photos.forEach((photo, idx) => {
                        const photoIndex = startIndex + idx;
                        const col = document.createElement('div');
                        col.className = 'col-lg-3 col-md-4 col-sm-6';
                        col.innerHTML = `
                            <div class="card photo-card border" data-photo-id="${photo.id}" data-photo-index="${photoIndex}">
                                <div class="photo-card-wrapper">
                                    <div class="photo-skeleton" id="skeleton-${photo.id}"></div>
                                    <img src="${photo.thumbnailPath || photo.fullImagePath}"
                                         alt="${escapeHtml(photo.title)}"
                                         class="photo-image loading"
                                         data-full-path="${photo.fullImagePath}"
                                         data-title="${escapeHtml(photo.title)}"
                                         data-photo-id="${photo.id}"
                                         onclick="openLightbox(${photoIndex})"
                                         onload="handleImageLoad(this, ${photo.id})"
                                         onerror="handleImageError(this, ${photo.id})">
                                </div>
                                <div class="card-body">
                                    <h6 class="card-title mb-3 text-truncate" title="${escapeHtml(photo.title)}">${escapeHtml(photo.title)}</h6>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-warning favorite-btn ${favoritePhotos.has(photo.id) ? 'active' : ''}" onclick="toggleFavorite(${photo.id}, this)" data-photo-id="${photo.id}">
                                            <i class="ti ti-heart me-1"></i>Favorite
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info" onclick="showEditModal(${photo.id}, '${escapeHtml(photo.title).replace(/'/g, "\\'")}')">
                                            <i class="ti ti-edit me-1"></i>Request Edit
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="downloadPhoto(${photo.id})">
                                            <i class="ti ti-download me-1"></i>Download
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        gallery.appendChild(col);

                        // Add to photo data for lightbox
                        photoData.push({
                            id: photo.id,
                            fullPath: photo.fullImagePath,
                            title: photo.title,
                            index: photoIndex
                        });
                    });

                    // Update state
                    currentPage = pagination.currentPage;
                    totalPages = pagination.totalPages;

                    // Update counter
                    const currentCount = document.getElementById('currentCount');
                    if (currentCount) {
                        currentCount.textContent = photoData.length;
                    }

                    // Hide button if no more pages
                    if (!pagination.hasNextPage) {
                        const container = document.getElementById('loadMoreContainer');
                        if (container) {
                            container.innerHTML = `
                                <div class="text-muted">
                                    <i class="ti ti-check me-1"></i>Showing all ${totalPhotos} photos
                                </div>
                            `;
                        }
                    }

                    showToast(`Loaded ${photos.length} more photos`, 'success');
                } else {
                    showToast('No more photos to load', 'info');
                }
            } catch (error) {
                console.error('Error loading more photos:', error);
                showToast('Failed to load more photos', 'danger');
            } finally {
                isLoadingMore = false;
                // Restore button state
                btnText.classList.remove('d-none');
                btnLoading.classList.add('d-none');
                btn.disabled = false;
            }
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Load favorites on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize photo data
            initPhotoData();

            // Load favorites
            fetch(`/api/proofing/favorites/${sessionToken}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.data) {
                        data.data.forEach(photo => {
                            favoritePhotos.add(photo.id);
                            const card = document.querySelector(`[data-photo-id="${photo.id}"]`);
                            if (card) {
                                const btn = card.querySelector('.favorite-btn');
                                if (btn) btn.classList.add('active');
                            }
                        });
                        updateFavoriteCount();
                    }
                })
                .catch(err => console.error('Error loading favorites:', err));
        });
    </script>
</body>
</html>
